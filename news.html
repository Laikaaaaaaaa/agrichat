<!DOCTYPE html>
<html lang="vi">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover" />

  <meta name="mobile-web-app-capable" content="yes" />
  <meta name="apple-mobile-web-app-capable" content="yes" />
  <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent" />
  <meta name="format-detection" content="telephone=no" />
  <meta http-equiv="X-UA-Compatible" content="IE=edge" />
  
  <title>Tin t·ª©c N√¥ng nghi·ªáp - AgriSense AI</title>

  <link rel="icon" type="image/x-icon" href="/static/favicon logo/favicon/favicon.ico">
  <link rel="icon" type="image/svg+xml" href="/static/favicon logo/favicon/favicon.svg">
  <link rel="icon" type="image/png" sizes="96x96" href="/static/favicon logo/favicon/favicon-96x96.png">
  <link rel="apple-touch-icon" sizes="180x180" href="/static/favicon logo/favicon/apple-touch-icon.png">
  <link rel="manifest" href="/static/favicon logo/favicon/site.webmanifest">

  <script src="https://cdn.tailwindcss.com"></script>
  
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" />
  <style>
    /* WebView Optimization */
    * {
      -webkit-tap-highlight-color: rgba(0, 0, 0, 0);
      -webkit-touch-callout: none;
    }
    
    /* Fix mobile viewport issues with Chrome address bar */
    html {
      height: 100%;
      overflow-x: hidden;
      -webkit-text-size-adjust: 100%;
      -ms-text-size-adjust: 100%;
    }
    
    body {
      min-height: 100%;
      overflow-x: hidden;
      position: relative;
      -webkit-font-smoothing: antialiased;
      -moz-osx-font-smoothing: grayscale;
    }
    
    /* Smooth scrolling for WebView */
    * {
      -webkit-overflow-scrolling: touch;
    }
    
    /* Prevent text selection in WebView */
    img {
      -webkit-user-select: none;
      user-select: none;
      pointer-events: none;
    }
    
    /* Better touch handling */
    button, a, input, textarea, select {
      -webkit-user-select: text;
      user-select: text;
    }
    
    /* Custom animations - matching index.html */
    @keyframes fadeInUp {
      from {
        opacity: 0;
        transform: translateY(20px);
      }
      to {
        opacity: 1;
        transform: translateY(0);
      }
    }
    
    .fade-in-up {
      animation: fadeInUp 0.5s ease-out;
    }
    
    .news-card {
      transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
      cursor: pointer;
    }
    
    .news-card:hover {
      transform: translateY(-4px);
      box-shadow: 0 20px 25px -5px rgba(0, 0, 0, 0.1);
    }
    
    /* Modal animations */
    @keyframes modalFadeIn {
      from {
        opacity: 0;
      }
      to {
        opacity: 1;
      }
    }
    
    @keyframes modalSlideIn {
      from {
        opacity: 0;
        transform: translateY(-20px) scale(0.95);
      }
      to {
        opacity: 1;
        transform: translateY(0) scale(1);
      }
    }
    
    #article-modal {
      animation: modalFadeIn 0.3s ease-out;
    }
    
    #article-modal > div {
      animation: modalSlideIn 0.3s ease-out;
    }
    
    /* Modal image column - smaller on mobile, full on desktop */
    #modal-image-column {
      min-height: 200px;
      max-height: 250px;
    }
    
    @media (min-width: 768px) {
      #modal-image-column {
        max-height: none;
        height: auto;
        flex: 1;
      }
      
      /* Make image column sticky effect */
      .md\:w-2\/5 {
        display: flex;
        flex-direction: column;
      }
    }
    
    .category-button {
      transition: all 0.3s ease;
    }
    
    .category-button.active {
      background-color: #10b981;
      color: white;
    }
    
    .loading-spinner {
      border: 3px solid #f3f3f3;
      border-top: 3px solid #10b981;
      border-radius: 50%;
      width: 40px;
      height: 40px;
      animation: spin 1s linear infinite;
    }
    
    @keyframes spin {
      0% { transform: rotate(0deg); }
      100% { transform: rotate(360deg); }
    }
    
    /* Line clamp utilities */
    .line-clamp-2 {
      display: -webkit-box;
      -webkit-line-clamp: 2;
      line-clamp: 2;
      -webkit-box-orient: vertical;
      overflow: hidden;
    }
    
    .line-clamp-3 {
      display: -webkit-box;
      -webkit-line-clamp: 3;
      line-clamp: 3;
      -webkit-box-orient: vertical;
      overflow: hidden;
    }
  </style>
</head>
<body class="bg-green-50 font-sans text-gray-700">
  
  <header class="bg-green-100 border-b border-green-200 shadow-sm flex-shrink-0">
    <div class="w-full flex justify-between items-center py-3 px-4 md:py-4 md:px-6">
      <div class="flex items-center gap-3">
        
        <button onclick="goBack()" class="text-white bg-green-600 hover:bg-green-700 transition-colors p-2 rounded-lg shadow-lg border-2 border-green-500 font-bold text-sm">
          <i class="fas fa-arrow-left"></i>
        </button>
        
        <img src="/static/logo/logo.png" alt="AgriSense AI Logo" class="h-12 md:h-14 w-auto object-contain">
      </div>
      <span class="text-xs md:text-sm text-gray-500 hidden md:block">Tin t·ª©c n√¥ng nghi·ªáp th√¥ng minh</span>
      <div class="flex items-center gap-2 md:gap-4">
        <span id="header-status" class="text-xs md:text-sm text-green-500">
          <i class="fas fa-spinner fa-spin mr-1"></i>ƒêang t·∫£i tin t·ª©c...
        </span>
      </div>
    </div>
  </header>

  <div class="w-full px-2 md:px-4 relative">
    
    <main class="bg-white shadow-lg rounded-2xl p-3 md:p-6 flex flex-col w-full relative mx-auto max-w-7xl mt-4 mb-4">

      <div class="text-center mb-6 md:mb-8 pb-4 border-b border-gray-100">
        <h1 class="text-2xl md:text-3xl font-bold text-green-800 mb-3">
          <i class="fas fa-newspaper text-green-600 mr-3"></i>
          <span id="page-title">Tin t·ª©c N√¥ng nghi·ªáp</span>
        </h1>
        <p class="text-sm md:text-base text-gray-600 max-w-2xl mx-auto">
          C·∫≠p nh·∫≠t nh·ªØng tin t·ª©c m·ªõi nh·∫•t v·ªÅ n√¥ng nghi·ªáp, c√¥ng ngh·ªá, kh√≠ h·∫≠u v√† chƒÉn nu√¥i
        </p>
      </div>

      <div class="mb-6 space-y-4">
        
        <div class="flex justify-center">
          <div class="relative w-full max-w-md">
            <input 
              type="text" 
              id="search-input"
              placeholder="T√¨m ki·∫øm tin t·ª©c..." 
              spellcheck="false"
              class="w-full pl-10 pr-20 py-3 border-2 border-green-200 rounded-xl focus:ring-2 focus:ring-green-400 focus:border-green-500 shadow-sm text-sm md:text-base"
            />
            <i class="fas fa-search absolute left-3 top-1/2 transform -translate-y-1/2 text-gray-400"></i>

            <button id="clear-search" onclick="clearSearch()" class="absolute right-12 top-1/2 transform -translate-y-1/2 text-gray-400 hover:text-gray-600 transition-colors hidden">
              <i class="fas fa-times"></i>
            </button>

            <button onclick="searchNews()" class="absolute right-2 top-1/2 transform -translate-y-1/2 bg-green-500 hover:bg-green-600 text-white p-2 rounded-lg transition-colors">
              <i class="fas fa-search text-sm"></i>
            </button>
          </div>
        </div>

        <div id="search-results-info" class="text-center text-sm text-gray-600 hidden">
          <i class="fas fa-info-circle mr-1"></i>
          <span id="search-results-text"></span>
        </div>

        <div class="flex flex-wrap justify-center gap-2 md:gap-3">
          <button class="category-button active px-3 md:px-4 py-2 rounded-full border-2 border-green-500 hover:border-green-600 text-xs md:text-sm font-medium transition-colors" data-category="all">
            <i class="fas fa-globe-americas mr-1"></i>
            T·∫•t c·∫£
          </button>
          <button class="category-button px-3 md:px-4 py-2 rounded-full border-2 border-green-300 hover:border-green-500 text-xs md:text-sm font-medium transition-colors" data-category="agriculture">
            <i class="fas fa-seedling mr-1"></i>
            N√¥ng nghi·ªáp
          </button>
          <button class="category-button px-3 md:px-4 py-2 rounded-full border-2 border-green-300 hover:border-green-500 text-xs md:text-sm font-medium transition-colors" data-category="technology">
            <i class="fas fa-microchip mr-1"></i>
            C√¥ng ngh·ªá
          </button>
          <button class="category-button px-3 md:px-4 py-2 rounded-full border-2 border-green-300 hover:border-green-500 text-xs md:text-sm font-medium transition-colors" data-category="climate">
            <i class="fas fa-cloud mr-1"></i>
            Kh√≠ h·∫≠u
          </button>
          <button class="category-button px-3 md:px-4 py-2 rounded-full border-2 border-green-300 hover:border-green-500 text-xs md:text-sm font-medium transition-colors" data-category="livestock">
            <i class="fa-solid fa-cow mr-1"></i>
            ChƒÉn nu√¥i
          </button>
        </div>
      </div>

      <div id="loading" class="text-center py-12">
        <div class="loading-spinner mx-auto mb-4"></div>
        <p class="text-gray-600 text-sm md:text-base">ƒêang t·∫£i tin t·ª©c...</p>
      </div>

      <div id="news-container" class="hidden flex-1 overflow-auto" style="min-height: 0;">
        <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-4 md:gap-6 w-full">
          
        </div>
      </div>

      <div id="no-results" class="text-center py-12 hidden">
        <i class="fas fa-newspaper text-gray-300 text-4xl md:text-6xl mb-4"></i>
        <h3 class="text-lg md:text-xl font-semibold text-gray-600 mb-2">Kh√¥ng t√¨m th·∫•y tin t·ª©c</h3>
        <p class="text-sm md:text-base text-gray-500">Th·ª≠ t√¨m ki·∫øm v·ªõi t·ª´ kh√≥a kh√°c ho·∫∑c ch·ªçn danh m·ª•c kh√°c</p>
      </div>

      <div class="text-center mt-6 pt-4 border-t border-gray-100">
        <button id="load-more" class="hidden bg-green-500 hover:bg-green-600 text-white px-6 py-3 rounded-xl font-medium transition-colors shadow-sm">
          <i class="fas fa-plus mr-2"></i>
          T·∫£i th√™m tin t·ª©c
        </button>
      </div>
    </main>
  </div>

  <div id="article-modal" class="hidden fixed inset-0 bg-black bg-opacity-50 z-50 flex items-center justify-center p-4" onclick="closeArticleModal(event)">
    <div class="bg-white rounded-2xl shadow-2xl max-w-6xl w-full max-h-[95vh] overflow-hidden flex flex-col" onclick="event.stopPropagation()">
      
      <div class="bg-gradient-to-r from-green-500 to-green-600 px-6 py-4 flex items-center justify-between flex-shrink-0">
        <h2 class="text-xl font-bold text-white flex items-center gap-2">
          <i class="fas fa-newspaper"></i>
          <span>Chi ti·∫øt b√†i b√°o</span>
        </h2>
        <button onclick="closeArticleModal()" class="text-white hover:text-gray-200 transition-colors">
          <i class="fas fa-times text-2xl"></i>
        </button>
      </div>

      <div class="flex flex-col md:flex-row flex-1 overflow-hidden">
        
        <div class="hidden md:flex md:w-2/5 flex-shrink-0 bg-gray-50 overflow-hidden flex-col">
          <div id="modal-image-column" class="flex-shrink-0 relative">
            
          </div>

          <div id="modal-actions-desktop" class="flex gap-3 p-4 bg-gray-100 border-t border-gray-200">
            
          </div>
        </div>

        <div id="modal-content" class="flex-1 overflow-y-auto p-6" style="max-height: calc(95vh - 120px);">
          
        </div>
      </div>

      <div id="modal-actions-mobile" class="md:hidden border-t border-gray-200 px-4 py-3 bg-gray-50 flex-shrink-0">
        
      </div>
    </div>
  </div>

  <div id="share-modal" class="hidden fixed inset-0 bg-black bg-opacity-50 z-[60] flex items-center justify-center p-4" onclick="closeShareModal(event)">
    <div class="bg-white rounded-2xl shadow-2xl max-w-lg w-full overflow-hidden" onclick="event.stopPropagation()">
      
      <div class="bg-gradient-to-r from-green-500 to-green-600 px-6 py-4 text-center">
        <h3 class="text-lg font-semibold text-white">Chia s·∫ª b√†i vi·∫øt</h3>
      </div>

      <div class="p-8">
        <div id="share-options" class="flex justify-center items-center gap-4 flex-wrap">
          
        </div>
      </div>
    </div>
  </div>

  <footer class="bg-green-100 border-t border-green-200 mt-8">
    <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8 py-6">
      <div class="text-center">
        <p class="text-sm text-gray-600">¬© 2025 AgriSense AI. T·∫•t c·∫£ quy·ªÅn ƒë∆∞·ª£c b·∫£o l∆∞u.</p>
        <p class="text-xs text-gray-500 mt-1">Chuy√™n gia t∆∞ v·∫•n n√¥ng nghi·ªáp th√¥ng minh</p>
      </div>
    </div>
  </footer>

  <script>
    // News API Configuration
    const newsAPIs = [
      'df2bad590b1349e980a3123efe8b26b8',
      '09479cf1408a4221a37bb8eeb4944d57',
      'ac9afdf035ae40a6aac44a3e9bbdb676',
      'b2631d135606454b90e5f91a4b65c005'
    ];
    
    // Vietnamese RSS feeds for agriculture and related news
    const vietnameseRSSFeeds = [
      // N√¥ng nghi·ªáp m√¥i tr∆∞·ªùng - NO FILTER (accept ALL - th·ªùi s·ª±, kinh doanh, v.v. ƒë·ªÅu li√™n quan NN&MT)
      {
        name: "N√¥ng nghi·ªáp M√¥i tr∆∞·ªùng - ChƒÉn nu√¥i",
        url: "https://nongnghiepmoitruong.vn/chan-nuoi.rss",
        category: "livestock"
      },
      {
        name: "N√¥ng nghi·ªáp M√¥i tr∆∞·ªùng - T√°i c∆° c·∫•u",
        url: "https://nongnghiepmoitruong.vn/tai-co-cau-nong-nghiep.rss",
        category: "agriculture"
      },
      {
        name: "N√¥ng nghi·ªáp M√¥i tr∆∞·ªùng - Khuy·∫øn n√¥ng",
        url: "https://nongnghiepmoitruong.vn/khuyen-nong.rss",
        category: "agriculture"
      },
      {
        name: "N√¥ng nghi·ªáp M√¥i tr∆∞·ªùng - KHCN",
        url: "https://nongnghiepmoitruong.vn/khoa-hoc---cong-nghe.rss",
        category: "technology"
      },
      {
        name: "N√¥ng nghi·ªáp M√¥i tr∆∞·ªùng - Th·ªã tr∆∞·ªùng",
        url: "https://nongnghiepmoitruong.vn/thi-truong.rss",
        category: "agriculture"
      },
      {
        name: "N√¥ng nghi·ªáp M√¥i tr∆∞·ªùng - Kinh doanh",
        url: "https://nongnghiepmoitruong.vn/kinh-doanh.rss",
        category: "agriculture"
      },
      {
        name: "N√¥ng nghi·ªáp M√¥i tr∆∞·ªùng - Th·ªùi s·ª±",
        url: "https://nongnghiepmoitruong.vn/thoi-su.rss",
        category: "agriculture"
      },
      {
        name: "N√¥ng nghi·ªáp M√¥i tr∆∞·ªùng - Video",
        url: "https://nongnghiepmoitruong.vn/video.rss",
        category: "agriculture"
      },
      {
        name: "N√¥ng nghi·ªáp M√¥i tr∆∞·ªùng - T·∫•t c·∫£",
        url: "https://nongnghiepmoitruong.vn/rss",
        category: "agriculture"
      },
      
      // VnExpress - NO FILTER (load t·∫•t c·∫£ ƒë·ªÉ c√≥ b√†i xen k·∫Ω)
      {
        name: "VnExpress - N√¥ng nghi·ªáp",
        url: "https://vnexpress.net/tag/nong-nghiep.rss",
        category: "agriculture"
      },
      {
        name: "VnExpress - Khoa h·ªçc",
        url: "https://vnexpress.net/rss/khoa-hoc.rss",
        category: "technology"
      },
      
      // Tu·ªïi Tr·∫ª - NO FILTER
      {
        name: "Tu·ªïi Tr·∫ª - Khoa h·ªçc",
        url: "https://tuoitre.vn/rss/khoa-hoc.rss",
        category: "technology"
      },
      
      // VietnamNet - NO FILTER
      {
        name: "VietnamNet - Khoa h·ªçc",
        url: "https://vietnamnet.vn/rss/khoa-hoc.rss",
        category: "technology"
      },
      {
        name: "VietnamNet - M√¥i tr∆∞·ªùng",
        url: "https://vietnamnet.vn/rss/moi-truong.rss",
        category: "climate"
      },
      
      // Zing News - NO FILTER
      {
        name: "Zing News - Khoa h·ªçc",
        url: "https://zingnews.vn/rss/khoa-hoc.rss",
        category: "technology"
      },
      
      // COA (C·ªông ƒë·ªìng N√¥ng nghi·ªáp H·ªØu C∆°) - NO FILTER
      {
        name: "COA - Tin t·ª©c",
        url: "https://coa.org.vn/vi/news/rss/Tin-tuc/",
        category: "agriculture"
      },
      {
        name: "COA - T·∫•t c·∫£",
        url: "https://coa.org.vn/vi/news/rss/",
        category: "agriculture"
      },
      {
        name: "COA - N√¥ng nghi·ªáp h·ªØu c∆°",
        url: "https://coa.org.vn/vi/news/rss/nong-nghiep-huu-co/",
        category: "agriculture"
      },
      {
        name: "COA - Ch·ª©ng nh·∫≠n h·ªØu c∆°",
        url: "https://coa.org.vn/vi/news/rss/chung-nhan-huu-co/",
        category: "agriculture"
      },
      
      // Ban Qu·∫£n L√Ω D·ª± √Ån D·∫°o C√¥ng Nghi·ªáp v√† Ph√°t Tri·ªÉn N√¥ng Th√¥n - C√† Mau
      {
        name: "C√† Mau - C√°c d·ª± √°n tri·ªÉn khai",
        url: "https://banqldactnnptnt.camau.gov.vn/Rss.aspx?catid=47983&catname=cac-du-an-trien-khai&rec=50&sub=F&id=1396",
        category: "agriculture"
      },
      
      // VEPF (Vietnam Environment Protection Fund) - NO FILTER
      {
        name: "VEPF - Tin t·ª©c",
        url: "https://www.vepf.vn/vi/rss/tin-tuc-vepftpdhmy.rss",
        category: "climate"
      },
      {
        name: "VEPF - Tin m√¥i tr∆∞·ªùng",
        url: "https://www.vepf.vn/vi/rss/tin-moi-truong-vepfpw4e5j.rss",
        category: "climate"
      }
    ];
    
    let currentAPIIndex = 0;
    let currentCategory = 'all';
    let currentPage = 1;
    let allNews = [];
    let vietnameseNews = [];
    let isLoading = false;
    let hasMoreNews = true;
    
    // NEW: Track loading state for progressive display
    let currentDisplayCount = 0; // S·ªë b√†i ƒëang hi·ªÉn th·ªã
    let loadedFeedsCount = 0;    // S·ªë RSS feeds ƒë√£ load
    let allLoadedArticles = [];  // T·∫•t c·∫£ b√†i ƒë√£ load (ch∆∞a filter)
    const ARTICLES_PER_PAGE = 10;
    
    // Cache cho t·ª´ng danh m·ª•c ƒë·ªÉ gi·∫£m lag
    let categoryCache = {
      all: [],
      agriculture: [],
      technology: [],
      climate: [],
      livestock: []
    };

    // Update header status message
    function updateHeaderStatus(message, isLoading = false) {
      const headerStatus = document.getElementById('header-status');
      if (headerStatus) {
        if (isLoading) {
          headerStatus.innerHTML = `<i class="fas fa-spinner fa-spin mr-1"></i>${message}`;
          headerStatus.className = 'text-xs md:text-sm text-green-500';
        } else {
          headerStatus.innerHTML = `<i class="fas fa-check-circle mr-1"></i>${message}`;
          headerStatus.className = 'text-xs md:text-sm text-green-600 font-medium';
        }
      }
    }

    // Category keywords mapping - Enhanced ƒë·ªÉ ph√¢n bi·ªát r√µ r√†ng c√°c danh m·ª•c
    const categoryKeywords = {
      agriculture: [
        // Ti·∫øng Vi·ªát
        'n√¥ng nghi·ªáp', 'n√¥ng d√¢n', 'tr·ªìng tr·ªçt', 'c√¢y tr·ªìng', 'l√∫a', 'g·∫°o', 'rau c·ªß', 'hoa m√†u', 
        'gi·ªëng c√¢y', 'ph√¢n b√≥n', 'thu·ªëc tr·ª´ s√¢u', 't∆∞·ªõi ti√™u', 'ƒë·∫•t n√¥ng nghi·ªáp', 'n√¥ng s·∫£n',
        'xu·∫•t kh·∫©u n√¥ng s·∫£n', 'an to√†n th·ª±c ph·∫©m', 'n√¥ng nghi·ªáp h·ªØu c∆°', 'n√¥ng nghi·ªáp s·∫°ch',
        // Ti·∫øng Anh
        'farming', 'agriculture', 'crop', 'harvest', 'soil', 'seed', 'irrigation', 'pesticide', 
        'rice', 'corn', 'wheat', 'vegetable', 'organic farming', 'sustainable agriculture'
      ],
      technology: [
        // Ti·∫øng Vi·ªát
        'c√¥ng ngh·ªá', 'tr√≠ tu·ªá nh√¢n t·∫°o', 'AI', 'drone', 'robot', 'c·∫£m bi·∫øn', 'IoT', 'th√¥ng minh',
        't·ª± ƒë·ªông h√≥a', 'khoa h·ªçc', 'nghi√™n c·ª©u', 'ph√°t minh', 'kh√°m ph√°', 'startup', 's·ªë h√≥a',
        'blockchain', 'big data', 'machine learning', 'n√¥ng nghi·ªáp th√¥ng minh',
        // Ti·∫øng Anh
        'technology', 'innovation', 'digital', 'smart', 'automation', 'artificial intelligence', 
        'precision agriculture', 'sensor', 'IoT', 'robotics', 'drone technology'
      ],
      climate: [
        // Ti·∫øng Vi·ªát
        'kh√≠ h·∫≠u', 'th·ªùi ti·∫øt', 'nhi·ªát ƒë·ªô', 'm∆∞a', 'h·∫°n h√°n', 'l≈© l·ª•t', 'b√£o', 'bi·∫øn ƒë·ªïi kh√≠ h·∫≠u',
        '√¥ nhi·ªÖm', 'm√¥i tr∆∞·ªùng', 'kh√≠ th·∫£i', 'carbon', 'hi·ªáu ·ª©ng nh√† k√≠nh', 'nƒÉng l∆∞·ª£ng t√°i t·∫°o',
        'b·∫£o v·ªá m√¥i tr∆∞·ªùng', 'sinh th√°i', 'ƒëa d·∫°ng sinh h·ªçc', 'r·ª´ng', 'sa m·∫°c h√≥a',
        // Ti·∫øng Anh
        'climate', 'weather', 'temperature', 'rainfall', 'drought', 'flood', 'global warming', 
        'climate change', 'monsoon', 'pollution', 'environment', 'carbon emissions', 'renewable energy'
      ],
      livestock: [
        // Ti·∫øng Vi·ªát
        'chƒÉn nu√¥i', 'b√≤', 'heo', 'l·ª£n', 'g√†', 'v·ªãt', 'c·ª´u', 'd√™', 'tr√¢u', 'ng·ª±a', 'th·ªãt', 's·ªØa',
        'tr·ª©ng', 'gia s√∫c', 'gia c·∫ßm', 'th·ª©c ƒÉn chƒÉn nu√¥i', 'vaccine', 'b·ªánh ƒë·ªông v·∫≠t',
        'trang tr·∫°i', 'chƒÉn nu√¥i c√¥ng nghi·ªáp', 'an to√†n sinh h·ªçc', 'gi·∫øt m·ªï', 'ch·∫ø bi·∫øn th·ªãt',
        // Ti·∫øng Anh
        'livestock', 'cattle', 'pig', 'chicken', 'dairy', 'meat', 'animal', 'poultry', 
        'beef', 'pork', 'eggs', 'farm animals', 'animal husbandry', 'veterinary'
      ]
    };

    // Enhanced similarity calculation function for duplicate detection
    function calculateSimilarity(str1, str2) {
      if (!str1 || !str2) return 0;
      if (str1 === str2) return 1;
      
      // Normalize strings
      const s1 = str1.toLowerCase().trim().replace(/[^\w\s]/g, '');
      const s2 = str2.toLowerCase().trim().replace(/[^\w\s]/g, '');
      
      if (s1 === s2) return 1;
      
      // Calculate Levenshtein distance
      const matrix = [];
      const len1 = s1.length;
      const len2 = s2.length;
      
      if (len1 === 0) return len2 === 0 ? 1 : 0;
      if (len2 === 0) return 0;
      
      // Initialize matrix
      for (let i = 0; i <= len1; i++) {
        matrix[i] = [i];
      }
      for (let j = 0; j <= len2; j++) {
        matrix[0][j] = j;
      }
      
      // Calculate distances
      for (let i = 1; i <= len1; i++) {
        for (let j = 1; j <= len2; j++) {
          const cost = s1[i - 1] === s2[j - 1] ? 0 : 1;
          matrix[i][j] = Math.min(
            matrix[i - 1][j] + 1,      // deletion
            matrix[i][j - 1] + 1,      // insertion
            matrix[i - 1][j - 1] + cost // substitution
          );
        }
      }
      
      const maxLen = Math.max(len1, len2);
      const distance = matrix[len1][len2];
      
      return 1 - (distance / maxLen);
    }

    // Additional function to normalize article data and reduce duplicates
    function normalizeArticle(article) {
      return {
        ...article,
        title: article.title ? article.title.trim().replace(/\s+/g, ' ') : '',
        description: article.description ? article.description.trim().replace(/\s+/g, ' ') : '',
        normalizedTitle: article.title ? article.title.toLowerCase().replace(/[^\w\s]/g, '').trim() : ''
      };
    }

    // Enhanced duplicate detection for RSS feeds
    function removeDuplicatesFromFeed(articles) {
      const seen = new Set();
      const uniqueArticles = [];
      
      for (const article of articles) {
        const normalized = normalizeArticle(article);
        const titleKey = normalized.normalizedTitle;
        const urlKey = article.url;
        
        // Check if we've seen this title or URL before
        if (!seen.has(titleKey) && !seen.has(urlKey)) {
          // Additional check against existing articles for similarity
          const isDuplicate = uniqueArticles.some(existing => {
            return calculateSimilarity(existing.normalizedTitle, normalized.normalizedTitle) > 0.75 ||
                   (existing.url === article.url) ||
                   (existing.description && article.description && 
                    calculateSimilarity(existing.description.toLowerCase(), article.description.toLowerCase()) > 0.8);
          });
          
          if (!isDuplicate) {
            seen.add(titleKey);
            seen.add(urlKey);
            uniqueArticles.push(normalized);
          }
        }
      }
      
      return uniqueArticles;
    }

    // Initialize page
    document.addEventListener('DOMContentLoaded', async function() {
      // Initialize clock
      updateClock();
      setInterval(updateClock, 1000);
      
      // Setup event listeners first
      setupEventListeners();
      
      // Get URL parameters
      const urlParams = new URLSearchParams(window.location.search);
      const categoryParam = urlParams.get('category');
      const typeParam = urlParams.get('type');
      
      // Set initial category if provided
      if (categoryParam && categoryParam !== 'all') {
        currentCategory = categoryParam;
        // Update active button
        document.querySelectorAll('.category-button').forEach(btn => {
          btn.classList.remove('active');
        });
        const targetButton = document.querySelector(`[data-category="${categoryParam}"]`);
        if (targetButton) {
          targetButton.classList.add('active');
        }
      }
      
      // Update page title if type is provided
      if (typeParam) {
        document.getElementById('page-title').textContent = typeParam;
        document.title = `${typeParam} - AgriSense AI`;
      }
      
      // Show loading state
      showLoading();
      updateHeaderStatus('ƒêang t·∫£i tin t·ª©c t·ª´ RSS...', true);
      console.log('üöÄ B·∫Øt ƒë·∫ßu t·∫£i tin t·ª©c t·ª´ RSS2JSON...');
      
      // === ∆ØU TI√äN: Load RSS ngay l·∫≠p t·ª©c ===
      // Kh√¥ng ch·ªù l√¢u, load RSS v·ªõi rss2json ngay
      loadVietnameseNews().then(() => {
        console.log(`‚úÖ Load xong! ${vietnameseNews.length} b√†i`);
        filterAndDisplayNews();
        hideLoading();
      }).catch(error => {
        console.error('‚ùå L·ªói load:', error);
        hideLoading();
        showNoResults();
      });
      
      // Update status sau 5s
      setTimeout(() => {
        if (vietnameseNews.length > 0) {
          console.log(`üìä ${vietnameseNews.length} b√†i b√°o ƒë√£ load`);
          updateHeaderStatus(`${vietnameseNews.length} tin t·ª©c`, false);
        }
      }, 5000);
    });

    // Fetch Vietnamese RSS feeds - OPTIMIZED: Load only what's needed
    async function loadVietnameseNews() {
      console.log('üöÄ ƒêang t·∫£i tin t·ª©c Vi·ªát Nam (ch·ªâ load khi c·∫ßn)...');
      
      try {
        // Prioritize agricultural feeds first
        const agricultureFeeds = vietnameseRSSFeeds.filter(feed => 
          feed.category === 'agriculture' || feed.name.toLowerCase().includes('n√¥ng nghi·ªáp') || 
          feed.name.toLowerCase().includes('chƒÉn nu√¥i') || feed.name.toLowerCase().includes('th·ªßy s·∫£n')
        );
        const otherFeeds = vietnameseRSSFeeds.filter(feed => !agricultureFeeds.includes(feed));
        const prioritizedFeeds = [...agricultureFeeds, ...otherFeeds];
        
        console.log(`üìã ∆Øu ti√™n ${agricultureFeeds.length} ngu·ªìn n√¥ng nghi·ªáp, ${otherFeeds.length} ngu·ªìn kh√°c`);
        
        // LOAD ONLY FIRST 5 FEEDS for initial display (~ 50-100 articles)
        const initialFeeds = prioritizedFeeds.slice(0, 5);
        console.log(`‚ö° Load ${initialFeeds.length} ngu·ªìn ƒë·∫ßu ti√™n...`);
        
        // Store full feed list for later loading
        window.remainingFeeds = prioritizedFeeds.slice(5);
        window.allPrioritizedFeeds = prioritizedFeeds;
        
        // Load initial feeds in parallel
        const feedPromises = initialFeeds.map(feed => loadSingleFeed(feed));
        const results = await Promise.all(feedPromises);
        
        // Collect all articles
        results.forEach(items => {
          if (items && items.length > 0) {
            allLoadedArticles = [...allLoadedArticles, ...items];
          }
        });
        
        // Remove duplicates and sort
        allLoadedArticles = removeDuplicatesFromFeed(allLoadedArticles);
        allLoadedArticles.sort((a, b) => {
          if (a.priority !== b.priority) return (a.priority || 3) - (b.priority || 3);
          return new Date(b.publishedAt) - new Date(a.publishedAt);
        });
        
        vietnameseNews = [...allLoadedArticles];
        loadedFeedsCount = initialFeeds.length;
        
        console.log(`‚úÖ ƒê√£ load ${loadedFeedsCount} ngu·ªìn, c√≥ ${vietnameseNews.length} b√†i`);
        
      } catch (error) {
        console.error('‚ùå L·ªói t·∫£i tin:', error);
      }
    }
    
    // Load a single RSS feed - U·ª®U TI√äN rss2json, b·ªè /api/rss-parse
    async function loadSingleFeed(feed) {
      console.log(`üì• ƒêang t·∫£i: ${feed.name} t·ª´ backend Python...`);
      
      try {
        // G·ªçi backend Python API ƒë·ªÉ load RSS
        const response = await fetch(`/api/fetch-rss-feeds?url=${encodeURIComponent(feed.url)}`, {
          timeout: 15000,
          headers: { 'Accept': 'application/json' }
        });
        
        if (!response.ok) {
          console.warn(`   ‚ö†Ô∏è Backend tr·∫£ v·ªÅ ${response.status}, fallback sang rss2json...`);
          return await loadSingleFeedFallback(feed);
        }
        
        const data = await response.json();
        
        if (!data.items || data.items.length === 0) {
          console.warn(`   ‚ö†Ô∏è ${feed.name}: kh√¥ng c√≥ b√†i vi·∫øt t·ª´ backend`);
          return await loadSingleFeedFallback(feed);
        }
        
        // Chuy·ªÉn ƒë·ªïi format t·ª´ backend
        const newsItems = data.items.map(item => {
          let description = item.description || '';
          if (description) {
            description = description.replace(/<[^>]*>/g, '').substring(0, 300);
          }
          
          return {
            title: item.title || '',
            description: description || 'Kh√¥ng c√≥ m√¥ t·∫£',
            url: item.link || '',
            urlToImage: item.thumbnail || item.image || getImageFromItem(item, feed.name),
            publishedAt: item.pubDate || item.isoDate || new Date().toISOString(),
            source: { name: feed.name },
            content: item.content || description,
            category: feed.category,
            isVietnamese: true,
            priority: feed.category === 'agriculture' ? 1 : 2,
            guid: item.guid || item.link
          };
        });
        
        if (newsItems.length > 0) {
          console.log(`‚úÖ ${feed.name}: ${newsItems.length} b√†i (t·ª´ backend)`);
          return newsItems;
        }
        
      } catch (error) {
        console.warn(`   ‚ö†Ô∏è Backend error: ${error.message}, fallback sang rss2json...`);
      }
      
      // Fallback to rss2json if backend fails
      return await loadSingleFeedFallback(feed);
    }
    
    // Fallback function ƒë·ªÉ d√πng rss2json n·∫øu backend fail
    async function loadSingleFeedFallback(feed) {
      console.log(`   üîÑ Fallback: ${feed.name} d√πng rss2json...`);
      
      const rssServices = [
        {
          url: `https://api.rss2json.com/v1/api.json?rss_url=${encodeURIComponent(feed.url)}&count=99`,
          name: 'rss2json.com'
        },
        {
          url: `https://rss2json.com/api.json?rss_url=${encodeURIComponent(feed.url)}&api_key=bhqojjrpwu79kwhljjcj20c2c3s7ycpwmq0ldyjb&count=99`,
          name: 'rss2json.com (backup)'
        }
      ];
      
      for (const service of rssServices) {
        try {
          console.log(`     üîó Th·ª≠ ${service.name}...`);
          const response = await fetch(service.url, { 
            timeout: 8000,
            headers: { 'Accept': 'application/json' }
          });
          
          if (!response.ok) {
            console.warn(`     ‚ö†Ô∏è ${service.name} tr·∫£ v·ªÅ ${response.status}`);
            continue;
          }
          
          const data = await response.json();
          
          if (data.status !== 'ok') {
            console.warn(`     ‚ö†Ô∏è ${service.name} status: ${data.status}`);
            continue;
          }
          
          if (!data.items || data.items.length === 0) {
            console.warn(`     ‚ö†Ô∏è ${feed.name}: kh√¥ng c√≥ b√†i vi·∫øt`);
            continue;
          }
          
          const newsItems = data.items.map(item => {
            let description = item.description || '';
            if (description) {
              description = description.replace(/<[^>]*>/g, '').substring(0, 300);
            }
            
            return {
              title: item.title || '',
              description: description || 'Kh√¥ng c√≥ m√¥ t·∫£',
              url: item.link || '',
              urlToImage: item.thumbnail || getImageFromItem(item, feed.name),
              publishedAt: item.pubDate || item.isoDate || new Date().toISOString(),
              source: { name: feed.name },
              content: item.content || description,
              category: feed.category,
              isVietnamese: true,
              priority: feed.category === 'agriculture' ? 1 : 2,
              guid: item.guid || item.link
            };
          });
          
          if (newsItems.length > 0) {
            console.log(`‚úÖ ${feed.name}: ${newsItems.length} b√†i (t·ª´ rss2json fallback)`);
            return newsItems;
          }
          
        } catch (error) {
          console.warn(`     ‚ö†Ô∏è ${service.name} l·ªói: ${error.message}`);
          continue;
        }
      }
      
      console.error(`‚ùå Kh√¥ng t·∫£i ƒë∆∞·ª£c ${feed.name}`);
      return [];
    }
    
    // Load more feeds when user clicks "Load More"
    async function loadMoreFeeds() {
      if (!window.remainingFeeds || window.remainingFeeds.length === 0) {
        console.log('‚ùå Kh√¥ng c√≤n ngu·ªìn RSS ƒë·ªÉ load');
        hasMoreNews = false;
        return false;
      }
      
      if (isLoading) {
        console.log('‚è≥ ƒêang load, ch·ªù t√≠...');
        return false;
      }
      
      isLoading = true;
      updateHeaderStatus('ƒêang t·∫£i th√™m tin t·ª©c...', true);
      
      // Load next 3 feeds
      const nextBatch = window.remainingFeeds.slice(0, 3);
      window.remainingFeeds = window.remainingFeeds.slice(3);
      
      console.log(`üì¶ Load th√™m ${nextBatch.length} ngu·ªìn (c√≤n ${window.remainingFeeds.length})`);
      
      const feedPromises = nextBatch.map(feed => loadSingleFeed(feed));
      const results = await Promise.all(feedPromises);
      
      // Add new articles
      results.forEach(items => {
        if (items && items.length > 0) {
          allLoadedArticles = [...allLoadedArticles, ...items];
        }
      });
      
      // Remove duplicates and sort
      allLoadedArticles = removeDuplicatesFromFeed(allLoadedArticles);
      allLoadedArticles.sort((a, b) => {
        if (a.priority !== b.priority) return (a.priority || 3) - (b.priority || 3);
        return new Date(b.publishedAt) - new Date(a.publishedAt);
      });
      
      vietnameseNews = [...allLoadedArticles];
      loadedFeedsCount += nextBatch.length;
      
      // Clear cache to force refresh
      categoryCache = {
        all: [],
        agriculture: [],
        technology: [],
        climate: [],
        livestock: []
      };
      
      console.log(`‚úÖ T·ªïng ${loadedFeedsCount} ngu·ªìn, ${vietnameseNews.length} b√†i`);
      updateHeaderStatus(`${vietnameseNews.length} tin t·ª©c m·ªõi nh·∫•t`, false);
      
      isLoading = false;
      return true;
    }

    // Extract default image based on feed/category
    function extractDefaultImage(feedName) {
      const defaultImages = {
        'vnexpress': 'https://i.vnexpress.net/files/f1/2021/05/12/vnexpress-favicon-16x16.png',
        'zing': 'https://zing.vn/favicon.ico',
        'dantri': 'https://dantri.com.vn/favicon.ico',
        'thanhnien': 'https://thanhnien.vn/favicon.ico',
        'thoibao': 'https://thoibao.vn/favicon.ico',
        'tuoitre': 'https://tuoitre.vn/favicon.ico',
        'n√¥ng nghi·ªáp': 'https://images.unsplash.com/photo-1574943320219-553eb213f72d?w=300&h=200&fit=crop',
        'm√¥i tr∆∞·ªùng': 'https://images.unsplash.com/photo-1511632765486-a01980e01a18?w=300&h=200&fit=crop',
        'livestock': 'https://images.unsplash.com/photo-1547471080-7cc2caa01a7e?w=300&h=200&fit=crop',
        'agriculture': 'https://images.unsplash.com/photo-1574943320219-553eb213f72d?w=300&h=200&fit=crop'
      };
      
      // Try exact match first
      if (defaultImages[feedName.toLowerCase()]) {
        return defaultImages[feedName.toLowerCase()];
      }
      
      // Try partial match
      for (const [key, url] of Object.entries(defaultImages)) {
        if (feedName.toLowerCase().includes(key)) {
          return url;
        }
      }
      
      // Default agriculture image
      return 'https://images.unsplash.com/photo-1574943320219-553eb213f72d?w=300&h=200&fit=crop';
    }

    // Enhanced image extraction function with Vietnamese agriculture focus
    function getImageFromItem(item, feedName) {
      // Try multiple sources for images
      let imageUrl = null;
      
      // 1. Try thumbnail
      if (item.thumbnail) {
        imageUrl = item.thumbnail;
      }
      // 2. Try enclosure
      else if (item.enclosure && item.enclosure.link) {
        imageUrl = item.enclosure.link;
      }
      // 3. Try extracting from content with priority for Vietnamese sources
      else if (item.content) {
        imageUrl = extractImageFromContent(item.content);
      }
      // 4. Try extracting from description
      else if (item.description) {
        imageUrl = extractImageFromContent(item.description);
      }
      
      // 5. Try media:content or other RSS image tags
      if (!imageUrl && item['media:content']) {
        imageUrl = item['media:content']['@_url'] || item['media:content'].url;
      }
      
      // 6. Use high-quality agriculture images based on content/feed
      if (!imageUrl) {
        imageUrl = getAgricultureImageByContent(item, feedName);
      }
      
      return imageUrl;
    }

    // Get agriculture-specific images based on content
    function getAgricultureImageByContent(item, feedName) {
      const title = (item.title || '').toLowerCase();
      const description = (item.description || '').toLowerCase();
      const content = title + ' ' + description;
      
      // Vietnamese agriculture-specific images
      if (content.includes('l√∫a') || content.includes('g·∫°o')) {
        return 'https://images.unsplash.com/photo-1574323347407-f5e1ad6d020b?w=400&h=200&fit=crop&auto=format';
      }
      if (content.includes('rau') || content.includes('c·ªß')) {
        return 'https://images.unsplash.com/photo-1416879595882-3373a0480b5b?w=400&h=200&fit=crop&auto=format';
      }
      if (content.includes('b√≤') || content.includes('s·ªØa')) {
        return 'https://images.unsplash.com/photo-1516467508483-a7212febe31a?w=400&h=200&fit=crop&auto=format';
      }
      if (content.includes('heo') || content.includes('l·ª£n')) {
        return 'https://images.unsplash.com/photo-1416879595882-3373a0480b5b?w=400&h=200&fit=crop&auto=format';
      }
      if (content.includes('g√†') || content.includes('tr·ª©ng')) {
        return 'https://images.unsplash.com/photo-1548550023-2bdb3c5beed7?w=400&h=200&fit=crop&auto=format';
      }
      if (content.includes('c√°') || content.includes('t√¥m') || content.includes('th·ªßy s·∫£n')) {
        return 'https://images.unsplash.com/photo-1544943910-4c1dc44aab44?w=400&h=200&fit=crop&auto=format';
      }
      if (content.includes('m√¥i tr∆∞·ªùng') || content.includes('kh√≠ h·∫≠u')) {
        return 'https://images.unsplash.com/photo-1441974231531-c6227db76b6e?w=400&h=200&fit=crop&auto=format';
      }
      if (content.includes('c√¥ng ngh·ªá') || content.includes('ai') || content.includes('drone')) {
        return 'https://images.unsplash.com/photo-1581092160562-40aa08e78837?w=400&h=200&fit=crop&auto=format';
      }
      if (content.includes('h·ªØu c∆°') || content.includes('s·∫°ch')) {
        return 'https://images.unsplash.com/photo-1500937386664-56d1dfef3854?w=400&h=200&fit=crop&auto=format';
      }
      
      // Feed-specific high-quality images for Vietnamese sources
      const feedImages = {
        'VnExpress': 'https://images.unsplash.com/photo-1625246333195-78d9c38ad449?w=400&h=200&fit=crop&auto=format',
        'Tu·ªïi Tr·∫ª': 'https://images.unsplash.com/photo-1500595046743-cd271d694d30?w=400&h=200&fit=crop&auto=format',
        'Thanh Ni√™n': 'https://images.unsplash.com/photo-1574323347407-f5e1ad6d020b?w=400&h=200&fit=crop&auto=format',
        'D√¢n tr√≠': 'https://images.unsplash.com/photo-1625246333195-78d9c38ad449?w=400&h=200&fit=crop&auto=format',
        'VTC': 'https://images.unsplash.com/photo-1586201375761-83865001e31c?w=400&h=200&fit=crop&auto=format',
        'N√¥ng nghi·ªáp': 'https://images.unsplash.com/photo-1574323347407-f5e1ad6d020b?w=400&h=200&fit=crop&auto=format',
        'M√¥i tr∆∞·ªùng': 'https://images.unsplash.com/photo-1441974231531-c6227db76b6e?w=400&h=200&fit=crop&auto=format'
      };
      
      for (const [key, img] of Object.entries(feedImages)) {
        if (feedName.includes(key)) {
          return img;
        }
      }
      
      // Default high-quality agriculture image
      return 'https://images.unsplash.com/photo-1574323347407-f5e1ad6d020b?w=400&h=200&fit=crop&auto=format';
    }

    // Helper function to extract image from content
    function extractImageFromContent(content) {
      if (!content) return null;
      
      // Try multiple image extraction patterns
      const imgPatterns = [
        /<img[^>]+src="([^"]+)"/i,
        /<img[^>]+src='([^']+)'/i,
        /src="([^"]*\.(jpg|jpeg|png|gif|webp)[^"]*)"/i,
        /src='([^']*\.(jpg|jpeg|png|gif|webp)[^']*)'/i,
        /<media:content[^>]+url="([^"]+)"/i,
        /<enclosure[^>]+url="([^"]+)"/i
      ];
      
      for (const pattern of imgPatterns) {
        const match = content.match(pattern);
        if (match && match[1]) {
          // Validate URL
          try {
            const url = new URL(match[1]);
            if (url.protocol === 'http:' || url.protocol === 'https:') {
              return match[1];
            }
          } catch (e) {
            // If it's a relative URL, try to make it absolute
            if (match[1].startsWith('/')) {
              return 'https:' + match[1];
            }
          }
        }
      }
      
      return null;
    }

    // Generate category-specific Vietnamese news with maximum diversity
    function generateCategorySpecificNews(category, count = 20) {
      const categoryNews = {
        agriculture: [
          {
            title: 'N√¥ng d√¢n ƒê·ªìng b·∫±ng s√¥ng C·ª≠u Long ·ª©ng d·ª•ng AI trong s·∫£n xu·∫•t l√∫a',
            description: 'H·ªá th·ªëng tr√≠ tu·ªá nh√¢n t·∫°o gi√∫p d·ª± b√°o s√¢u b·ªánh, t·ªëi ∆∞u h√≥a l∆∞·ª£ng ph√¢n b√≥n v√† tƒÉng nƒÉng su·∫•t l√∫a l√™n 30%...',
            urlToImage: 'https://images.unsplash.com/photo-1574323347407-f5e1ad6d020b?w=400&h=200&fit=crop&auto=format',
            category: 'agriculture'
          },
          {
            title: 'Tr·ªìng rau th·ªßy canh trong nh√† k√≠nh - m√¥ h√¨nh hi·ªáu qu·∫£ cao',
            description: 'C√¥ng ngh·ªá tr·ªìng rau kh√¥ng ƒë·∫•t gi√∫p ti·∫øt ki·ªám 90% n∆∞·ªõc, tƒÉng nƒÉng su·∫•t g·∫•p 4 l·∫ßn v√† kh√¥ng s·ª≠ d·ª•ng thu·ªëc tr·ª´ s√¢u...',
            urlToImage: 'https://images.unsplash.com/photo-1416879595882-3373a0480b5b?w=400&h=200&fit=crop&auto=format',
            category: 'agriculture'
          },
          {
            title: 'Xu·∫•t kh·∫©u g·∫°o Vi·ªát Nam v∆∞·ª£t m·ªëc 8,5 tri·ªáu t·∫•n nƒÉm 2025',
            description: 'V·ªõi ch·∫•t l∆∞·ª£ng cao v√† gi√° c·∫°nh tranh, g·∫°o Vi·ªát Nam ti·∫øp t·ª•c d·∫´n ƒë·∫ßu th·ªã tr∆∞·ªùng xu·∫•t kh·∫©u to√†n c·∫ßu...',
            urlToImage: 'https://images.unsplash.com/photo-1586201375761-83865001e31c?w=400&h=200&fit=crop&auto=format',
            category: 'agriculture'
          },
          {
            title: 'N√¥ng nghi·ªáp h·ªØu c∆° - xu h∆∞·ªõng b·ªÅn v·ªØng c·ªßa t∆∞∆°ng lai',
            description: 'Di·ªán t√≠ch canh t√°c h·ªØu c∆° tƒÉng 25% m·ªói nƒÉm, ƒë√°p ·ª©ng nhu c·∫ßu th·ª±c ph·∫©m s·∫°ch c·ªßa ng∆∞·ªùi ti√™u d√πng...',
            urlToImage: 'https://images.unsplash.com/photo-1500937386664-56d1dfef3854?w=400&h=200&fit=crop&auto=format',
            category: 'agriculture'
          },
          {
            title: 'ChƒÉn nu√¥i b√≤ s·ªØa c√¥ng ngh·ªá cao t·∫°i Vi·ªát Nam ph√°t tri·ªÉn m·∫°nh',
            description: 'Trang tr·∫°i b√≤ s·ªØa hi·ªán ƒë·∫°i v·ªõi h·ªá th·ªëng t·ª± ƒë·ªông h√≥a ho√†n to√†n ƒëang mang l·∫°i hi·ªáu qu·∫£ kinh t·∫ø cao...',
            urlToImage: 'https://images.unsplash.com/photo-1516467508483-a7212febe31a?w=400&h=200&fit=crop&auto=format',
            category: 'agriculture'
          },
          {
            title: 'Nu√¥i t√¥m th·∫ª ch√¢n tr·∫Øng c√¥ng ngh·ªá biofloc th√†nh c√¥ng',
            description: 'C√¥ng ngh·ªá nu√¥i t√¥m kh√¥ng th·∫£i n∆∞·ªõc gi√∫p tƒÉng nƒÉng su·∫•t 40% v√† gi·∫£m t·ª∑ l·ªá b·ªánh t·∫≠t ƒë√°ng k·ªÉ...',
            urlToImage: 'https://images.unsplash.com/photo-1544943910-4c1dc44aab44?w=400&h=200&fit=crop&auto=format',
            category: 'agriculture'
          },
          {
            title: 'S·∫£n xu·∫•t c√† ph√™ b·ªÅn v·ªØng - th∆∞∆°ng hi·ªáu Vi·ªát n·ªïi ti·∫øng th·∫ø gi·ªõi',
            description: 'C√°c v√πng c√† ph√™ Vi·ªát Nam √°p d·ª•ng quy tr√¨nh s·∫£n xu·∫•t b·ªÅn v·ªØng, n√¢ng cao gi√° tr·ªã v√† th∆∞∆°ng hi·ªáu...',
            urlToImage: 'https://images.unsplash.com/photo-1447933601403-0c6688de566e?w=400&h=200&fit=crop&auto=format',
            category: 'agriculture'
          },
          {
            title: '·ª®ng d·ª•ng drone phun thu·ªëc b·∫£o v·ªá th·ª±c v·∫≠t hi·ªáu qu·∫£ cao',
            description: 'Drone n√¥ng nghi·ªáp gi√∫p gi·∫£m 70% l∆∞·ª£ng thu·ªëc s·ª≠ d·ª•ng v√† tƒÉng ƒë·ªô ch√≠nh x√°c trong phun thu·ªëc...',
            urlToImage: 'https://images.unsplash.com/photo-1473968512647-3e447244af8f?w=400&h=200&fit=crop&auto=format',
            category: 'agriculture'
          }
        ],
        technology: [
          {
            title: 'AI c√°ch m·∫°ng h√≥a ng√†nh n√¥ng nghi·ªáp Vi·ªát Nam',
            description: 'Tr√≠ tu·ªá nh√¢n t·∫°o ƒëang thay ƒë·ªïi ho√†n to√†n c√°ch th·ª©c s·∫£n xu·∫•t n√¥ng nghi·ªáp t·ª´ gieo tr·ªìng ƒë·∫øn thu ho·∫°ch...',
            urlToImage: 'https://images.unsplash.com/photo-1581092160562-40aa08e78837?w=400&h=200&fit=crop&auto=format',
            category: 'technology'
          },
          {
            title: 'IoT v√† c·∫£m bi·∫øn th√¥ng minh trong trang tr·∫°i hi·ªán ƒë·∫°i',
            description: 'H·ªá th·ªëng c·∫£m bi·∫øn ƒëo ƒë·ªô ·∫©m, pH, nhi·ªát ƒë·ªô gi√∫p t·ª± ƒë·ªông h√≥a ho√†n to√†n quy tr√¨nh canh t√°c...',
            urlToImage: 'https://images.unsplash.com/photo-1518709268805-4e9042af2176?w=400&h=200&fit=crop&auto=format',
            category: 'technology'
          },
          {
            title: 'Blockchain trong truy xu·∫•t ngu·ªìn g·ªëc th·ª±c ph·∫©m',
            description: 'C√¥ng ngh·ªá chu·ªói kh·ªëi ƒë·∫£m b·∫£o t√≠nh minh b·∫°ch v√† an to√†n th·ª±c ph·∫©m t·ª´ trang tr·∫°i ƒë·∫øn ng∆∞·ªùi ti√™u d√πng...',
            urlToImage: 'https://images.unsplash.com/photo-1639322537228-f710d846310a?w=400&h=200&fit=crop&auto=format',
            category: 'technology'
          },
          {
            title: 'Robot thu ho·∫°ch t·ª± ƒë·ªông - t∆∞∆°ng lai c·ªßa n√¥ng nghi·ªáp',
            description: 'Robot AI c√≥ th·ªÉ nh·∫≠n di·ªán ƒë·ªô ch√≠n v√† thu ho·∫°ch t·ª± ƒë·ªông, gi·∫£m 80% chi ph√≠ nh√¢n c√¥ng...',
            urlToImage: 'https://images.unsplash.com/photo-1485827404703-89b55fcc595e?w=400&h=200&fit=crop&auto=format',
            category: 'technology'
          },
          {
            title: 'N√¥ng nghi·ªáp ch√≠nh x√°c v·ªõi GPS v√† satellite',
            description: 'C√¥ng ngh·ªá ƒë·ªãnh v·ªã v·ªá tinh gi√∫p t·ªëi ∆∞u h√≥a vi·ªác b√≥n ph√¢n, gieo h·∫°t v·ªõi ƒë·ªô ch√≠nh x√°c centimeter...',
            urlToImage: 'https://images.unsplash.com/photo-1446776653964-20c1d3a81b06?w=400&h=200&fit=crop&auto=format',
            category: 'technology'
          },
          {
            title: 'Big Data ph√¢n t√≠ch xu h∆∞·ªõng th·ªã tr∆∞·ªùng n√¥ng s·∫£n',
            description: 'D·ªØ li·ªáu l·ªõn gi√∫p d·ª± b√°o gi√° c·∫£, nhu c·∫ßu th·ªã tr∆∞·ªùng v√† t·ªëi ∆∞u h√≥a k·∫ø ho·∫°ch s·∫£n xu·∫•t...',
            urlToImage: 'https://images.unsplash.com/photo-1551288049-bebda4e38f71?w=400&h=200&fit=crop&auto=format',
            category: 'technology'
          },
          {
            title: 'NƒÉng l∆∞·ª£ng m·∫∑t tr·ªùi cho trang tr·∫°i xanh',
            description: 'H·ªá th·ªëng ƒëi·ªán m·∫∑t tr·ªùi k·∫øt h·ª£p n√¥ng nghi·ªáp gi√∫p gi·∫£m chi ph√≠ ƒëi·ªán v√† tƒÉng thu nh·∫≠p...',
            urlToImage: 'https://images.unsplash.com/photo-1509391366360-2e959784a276?w=400&h=200&fit=crop&auto=format',
            category: 'technology'
          },
          {
            title: '·ª®ng d·ª•ng di ƒë·ªông k·∫øt n·ªëi n√¥ng d√¢n v·ªõi th·ªã tr∆∞·ªùng',
            description: 'App th√¥ng minh gi√∫p n√¥ng d√¢n ti·∫øp c·∫≠n th√¥ng tin gi√° c·∫£, th·ªùi ti·∫øt v√† k·ªπ thu·∫≠t canh t√°c...',
            urlToImage: 'https://images.unsplash.com/photo-1512941937669-90a1b58e7e9c?w=400&h=200&fit=crop&auto=format',
            category: 'technology'
          }
        ],
        climate: [
          {
            title: 'Bi·∫øn ƒë·ªïi kh√≠ h·∫≠u th√°ch th·ª©c l·ªõn v·ªõi n√¥ng nghi·ªáp Vi·ªát Nam',
            description: 'Hi·ªán t∆∞·ª£ng th·ªùi ti·∫øt c·ª±c ƒëoan ng√†y c√†ng gia tƒÉng, ƒë√≤i h·ªèi gi·∫£i ph√°p th√≠ch ·ª©ng kh·∫©n c·∫•p...',
            urlToImage: 'https://images.unsplash.com/photo-1441974231531-c6227db76b6e?w=400&h=200&fit=crop&auto=format',
            category: 'climate'
          },
          {
            title: 'H·∫°n h√°n k√©o d√†i ·∫£nh h∆∞·ªüng nghi√™m tr·ªçng ƒë·∫øn s·∫£n xu·∫•t l√∫a',
            description: 'T√¨nh tr·∫°ng thi·∫øu n∆∞·ªõc t·∫°i ƒê·ªìng b·∫±ng s√¥ng C·ª≠u Long ƒëang ƒëe d·ªça m√πa v·ª• l√∫a m·ªõi...',
            urlToImage: 'https://images.unsplash.com/photo-1416879595882-3373a0480b5b?w=400&h=200&fit=crop&auto=format',
            category: 'climate'
          },
          {
            title: 'Gi·∫£i ph√°p th√≠ch ·ª©ng v·ªõi n∆∞·ªõc bi·ªÉn d√¢ng ·ªü v√πng ven bi·ªÉn',
            description: 'C√°c bi·ªán ph√°p ch·ªëng x√¢m nh·∫≠p m·∫∑n v√† gi·ªëng c√¢y ch·ªãu m·∫∑n ƒëang ƒë∆∞·ª£c tri·ªÉn khai r·ªông r√£i...',
            urlToImage: 'https://images.unsplash.com/photo-1439066615861-d1af74d74000?w=400&h=200&fit=crop&auto=format',
            category: 'climate'
          },
          {
            title: 'N√¥ng nghi·ªáp th√¥ng minh th√≠ch ·ª©ng bi·∫øn ƒë·ªïi kh√≠ h·∫≠u',
            description: 'H·ªá th·ªëng d·ª± b√°o th·ªùi ti·∫øt AI gi√∫p n√¥ng d√¢n ch·ªß ƒë·ªông ·ª©ng ph√≥ v·ªõi thi√™n tai...',
            urlToImage: 'https://images.unsplash.com/photo-1504567961542-e18d1ac2c7a4?w=400&h=200&fit=crop&auto=format',
            category: 'climate'
          },
          {
            title: 'Gi·ªëng c√¢y ch·ªãu h·∫°n - gi·∫£i ph√°p cho n√¥ng nghi·ªáp b·ªÅn v·ªØng',
            description: 'C√°c gi·ªëng l√∫a, ng√¥ ch·ªãu h·∫°n m·ªõi gi√∫p duy tr√¨ s·∫£n xu·∫•t trong ƒëi·ªÅu ki·ªán khan hi·∫øm n∆∞·ªõc...',
            urlToImage: 'https://images.unsplash.com/photo-1574323347407-f5e1ad6d020b?w=400&h=200&fit=crop&auto=format',
            category: 'climate'
          },
          {
            title: 'R·ª´ng tr·ªìng h·∫•p th·ª• CO2 - gi·∫£m thi·ªÉu bi·∫øn ƒë·ªïi kh√≠ h·∫≠u',
            description: 'Ch∆∞∆°ng tr√¨nh tr·ªìng r·ª´ng quy m√¥ l·ªõn g√≥p ph·∫ßn gi·∫£m ph√°t th·∫£i kh√≠ nh√† k√≠nh...',
            urlToImage: 'https://images.unsplash.com/photo-1441974231531-c6227db76b6e?w=400&h=200&fit=crop&auto=format',
            category: 'climate'
          },
          {
            title: 'Qu·∫£n l√Ω n∆∞·ªõc th√¥ng minh ch·ªëng h·∫°n h√°n hi·ªáu qu·∫£',
            description: 'H·ªá th·ªëng t∆∞·ªõi ti√™u th√¥ng minh gi√∫p ti·∫øt ki·ªám 50% l∆∞·ª£ng n∆∞·ªõc s·ª≠ d·ª•ng...',
            urlToImage: 'https://images.unsplash.com/photo-1505142468610-359e7d316be0?w=400&h=200&fit=crop&auto=format',
            category: 'climate'
          },
          {
            title: 'NƒÉng l∆∞·ª£ng t√°i t·∫°o trong n√¥ng nghi·ªáp gi·∫£m ph√°t th·∫£i',
            description: 'ƒêi·ªán gi√≥, ƒëi·ªán m·∫∑t tr·ªùi ƒëang thay th·∫ø nhi√™n li·ªáu h√≥a th·∫°ch trong s·∫£n xu·∫•t n√¥ng nghi·ªáp...',
            urlToImage: 'https://images.unsplash.com/photo-1509391366360-2e959784a276?w=400&h=200&fit=crop&auto=format',
            category: 'climate'
          }
        ],
        livestock: [
          {
            title: 'ChƒÉn nu√¥i b√≤ th·ªãt s·∫°ch kh√¥ng s·ª≠ d·ª•ng kh√°ng sinh',
            description: 'M√¥ h√¨nh chƒÉn nu√¥i b√≤ th·ªãt t·ª± nhi√™n ƒëang mang l·∫°i gi√° tr·ªã cao v√† an to√†n cho ng∆∞·ªùi ti√™u d√πng...',
            urlToImage: 'https://images.unsplash.com/photo-1516467508483-a7212febe31a?w=400&h=200&fit=crop&auto=format',
            category: 'livestock'
          },
          {
            title: 'Ng√†nh chƒÉn nu√¥i heo ph·ª•c h·ªìi m·∫°nh m·∫Ω sau ƒë·∫°i d·ªãch',
            description: 'V·ªõi c√¥ng ngh·ªá sinh h·ªçc hi·ªán ƒë·∫°i, ƒë√†n heo Vi·ªát Nam ƒë√£ ph·ª•c h·ªìi v√† v∆∞·ª£t m·ª©c tr∆∞·ªõc d·ªãch...',
            urlToImage: 'https://images.unsplash.com/photo-1548550023-2bdb3c5beed7?w=400&h=200&fit=crop&auto=format',
            category: 'livestock'
          },
          {
            title: 'ChƒÉn nu√¥i g√† organic - xu h∆∞·ªõng ti√™u d√πng m·ªõi',
            description: 'G√† nu√¥i th·∫£ v∆∞·ªùn kh√¥ng s·ª≠ d·ª•ng th·ª©c ƒÉn c√¥ng nghi·ªáp ƒëang ƒë∆∞·ª£c ∆∞a chu·ªông tr√™n th·ªã tr∆∞·ªùng...',
            urlToImage: 'https://images.unsplash.com/photo-1518728495266-2d56fe834b2b?w=400&h=200&fit=crop&auto=format',
            category: 'livestock'
          },
          {
            title: 'ChƒÉn nu√¥i d√™ n√∫i - ti·ªÅm nƒÉng l·ªõn v√πng cao Vi·ªát Nam',
            description: 'D√™ n√∫i th√≠ch ·ª©ng t·ªët v·ªõi ƒë·ªãa h√¨nh kh√≥ khƒÉn v√† mang l·∫°i thu nh·∫≠p cao cho ƒë·ªìng b√†o v√πng cao...',
            urlToImage: 'https://images.unsplash.com/photo-1548550023-2bdb3c5beed7?w=400&h=200&fit=crop&auto=format',
            category: 'livestock'
          },
          {
            title: 'C√¥ng ngh·ªá AI gi√°m s√°t s·ª©c kh·ªèe ƒë√†n gia s√∫c',
            description: 'Camera th√¥ng minh v√† c·∫£m bi·∫øn IoT gi√∫p ph√°t hi·ªán s·ªõm b·ªánh t·∫≠t v√† t·ªëi ∆∞u h√≥a chƒÉm s√≥c...',
            urlToImage: 'https://images.unsplash.com/photo-1581092160562-40aa08e78837?w=400&h=200&fit=crop&auto=format',
            category: 'livestock'
          },
          {
            title: 'Nu√¥i c·ª´u s·∫£n xu·∫•t len ch·∫•t l∆∞·ª£ng cao',
            description: 'Ng√†nh chƒÉn nu√¥i c·ª´u Vi·ªát Nam ƒëang ph√°t tri·ªÉn ƒë·ªÉ cung c·∫•p len ch·∫•t l∆∞·ª£ng cho ng√†nh d·ªát may...',
            urlToImage: 'https://images.unsplash.com/photo-1586201375761-83865001e31c?w=400&h=200&fit=crop&auto=format',
            category: 'livestock'
          },
          {
            title: 'Vaccine sinh h·ªçc ngƒÉn ng·ª´a d·ªãch b·ªánh gia s√∫c',
            description: 'C√¥ng ngh·ªá vaccine m·ªõi gi√∫p b·∫£o v·ªá ƒë√†n gia s√∫c kh·ªèi c√°c b·ªánh truy·ªÅn nhi·ªÖm nguy hi·ªÉm...',
            urlToImage: 'https://images.unsplash.com/photo-1559757148-5c350d0d3c56?w=400&h=200&fit=crop&auto=format',
            category: 'livestock'
          },
          {
            title: 'Th·ª©c ƒÉn chƒÉn nu√¥i th√¥ng minh tƒÉng nƒÉng su·∫•t',
            description: 'Th·ª©c ƒÉn b·ªï sung enzyme v√† probiotic gi√∫p gia s√∫c ph√°t tri·ªÉn kh·ªèe m·∫°nh v√† tƒÉng tr·ªçng nhanh...',
            urlToImage: 'https://images.unsplash.com/photo-1548550023-2bdb3c5beed7?w=400&h=200&fit=crop&auto=format',
            category: 'livestock'
          }
        ]
      };
      
      const articles = categoryNews[category] || categoryNews['agriculture'];
      const result = [];
      
      // T·∫°o n·ªôi dung ƒëa d·∫°ng t·ªëi ƒëa
      for (let i = 0; i < count; i++) {
        const articleIndex = i % articles.length;
        const baseArticle = articles[articleIndex];
        const timeOffset = (i * 2 + Math.random() * 3) * 3600000; // Random time between 2-5 hours
        const uniqueId = Date.now() + i + Math.floor(Math.random() * 1000);
        
        // S·ª≠ d·ª•ng tr·ª±c ti·∫øp ti√™u ƒë·ªÅ g·ªëc - kh√¥ng th√™m h·∫≠u t·ªë
        const variation = {
          ...baseArticle,
          title: baseArticle.title,
          publishedAt: new Date(Date.now() - timeOffset).toISOString(),
          url: `https://vietnamnews.vn/${category}/${uniqueId}`,
          source: { name: getRandomSource(category) },
          isVietnamese: true,
          priority: category === 'agriculture' ? 1 : 2
        };
        result.push(variation);
      }
      
      return result;
    }
    
    // Get random source name for variety
    function getRandomSource(category) {
      const sources = {
        agriculture: ['VnExpress N√¥ng nghi·ªáp', 'Tu·ªïi Tr·∫ª N√¥ng th√¥n', 'D√¢n Tr√≠ N√¥ng nghi·ªáp', 'N√¥ng nghi·ªáp Vi·ªát Nam', 'B√°o N√¥ng d√¢n'],
        technology: ['VnExpress Khoa h·ªçc', 'Tu·ªïi Tr·∫ª C√¥ng ngh·ªá', 'ICTNews', 'Vietnam Tech', 'Innovation Vietnam'],
        climate: ['VnExpress M√¥i tr∆∞·ªùng', 'Tu·ªïi Tr·∫ª Xanh', 'M√¥i tr∆∞·ªùng Vi·ªát Nam', 'Green ID', 'Climate Vietnam'],
        livestock: ['VnExpress ChƒÉn nu√¥i', 'Th·ªßy s·∫£n Vi·ªát Nam', 'ChƒÉn nu√¥i VN', 'Livestock Vietnam', 'Trang tr·∫°i Vi·ªát']
      };
      const categorySource = sources[category] || sources['agriculture'];
      return categorySource[Math.floor(Math.random() * categorySource.length)];
    }
    
    // Get Vietnamese category display names
    function getCategoryDisplayName(category) {
      const categoryNames = {
        agriculture: 'N√¥ng nghi·ªáp',
        technology: 'C√¥ng ngh·ªá',
        climate: 'Kh√≠ h·∫≠u',
        livestock: 'ChƒÉn nu√¥i'
      };
      return categoryNames[category] || 'Tin t·ª©c';
    }

    // Generate mock Vietnamese news for demonstration - improved to avoid duplication
    function generateMockVietnameseNews(feed, count = 15) {
      // Use the category-specific news generator for more varied content
      return generateCategorySpecificNews(feed.category, count);
    }

    // Generate all mock Vietnamese news - increased volume
    function generateAllMockVietnameseNews() {
      const allMockNews = [];
      vietnameseRSSFeeds.forEach((feed, index) => {
        // Generate 15-25 articles per feed for maximum content (ensure 50+ per category)
        const articlesPerFeed = 15 + (index % 11); // Vary between 15-25 articles
        allMockNews.push(...generateMockVietnameseNews(feed, articlesPerFeed));
      });
      console.log(`üéØ T·∫°o t·ªïng ${allMockNews.length} b√†i b√°o Vi·ªát Nam t·ª´ ${vietnameseRSSFeeds.length} ngu·ªìn RSS`);
      return allMockNews;
    }

    // Clock function - matching index.html
    function updateClock() {
      const now = new Date();
      const timeString = now.toLocaleTimeString('vi-VN', { 
        hour: '2-digit', 
        minute: '2-digit',
        second: '2-digit'
      });
      const clockElement = document.getElementById('clock');
      if (clockElement) {
        clockElement.textContent = timeString;
      }
    }

    function setupEventListeners() {
      // Category buttons
      document.querySelectorAll('.category-button').forEach(button => {
        button.addEventListener('click', function() {
          const category = this.getAttribute('data-category');
          selectCategory(category);
        });
      });

      // Enhanced search functionality
      const searchInput = document.getElementById('search-input');
      
      // Search on Enter key
      searchInput.addEventListener('keypress', function(e) {
        if (e.key === 'Enter') {
          searchNews();
        }
      });
      
      // Real-time search v·ªõi debounce
      let searchTimeout;
      searchInput.addEventListener('input', function(e) {
        updateSearchUI(); // Update UI ngay l·∫≠p t·ª©c
        clearTimeout(searchTimeout);
        searchTimeout = setTimeout(() => {
          searchNews();
        }, 500); // ƒê·ª£i 500ms sau khi user ng·ª´ng g√µ
      });
      
      // Clear search khi click X
      searchInput.addEventListener('keydown', function(e) {
        if (e.key === 'Escape') {
          this.value = '';
          searchNews();
        }
      });

      // Load more button
      document.getElementById('load-more').addEventListener('click', function() {
        loadMoreNews();
      });
    }

    function selectCategory(category) {
      currentCategory = category;
      currentPage = 1;
      currentDisplayCount = 0; // Reset display count when changing category
      
      // Update active button IMMEDIATELY for instant feedback
      document.querySelectorAll('.category-button').forEach(btn => {
        btn.classList.remove('active');
      });
      
      const targetButton = document.querySelector(`[data-category="${category}"]`);
      if (targetButton) {
        targetButton.classList.add('active');
      }
      
      // Use requestAnimationFrame for smooth transition
      requestAnimationFrame(() => {
        console.log(`‚ö° Chuy·ªÉn sang: ${getCategoryDisplayName(category) || category}`);
        filterAndDisplayNews(); // Will use cache if available = INSTANT
      });
    }

    async function loadNews(reset = true) {
      // Only load English news if Vietnamese content is insufficient
      if (vietnameseNews.length >= 50) {
        console.log(`üáªüá≥ ƒê·ªß tin Vi·ªát Nam (${vietnameseNews.length} b√†i), b·ªè qua t·∫£i tin ti·∫øng Anh`);
        if (reset) {
          allNews = []; // No English news needed
        }
        return; // Don't call filterAndDisplayNews here, let caller handle it
      }
      
      if (isLoading) return;
      
      isLoading = true;

      try {
        const apiKey = newsAPIs[currentAPIIndex];
        let query = 'agriculture OR farming OR crop OR livestock OR climate OR food OR rural';
        
        // Add specific keywords based on category
        if (currentCategory !== 'all' && categoryKeywords[currentCategory]) {
          query = categoryKeywords[currentCategory].join(' OR ');
        }

        // Limit English news to minimal amount
        const response = await fetch(`https://newsapi.org/v2/everything?q=${encodeURIComponent(query)}&language=en&sortBy=publishedAt&page=${currentPage}&pageSize=10&apiKey=${apiKey}`);
        
        if (!response.ok) {
          throw new Error('Failed to fetch news');
        }

        const data = await response.json();
        
        let newsArticles = data.articles || [];
        
        // Severely limit English content
        newsArticles = newsArticles.slice(0, Math.max(0, 50 - vietnameseNews.length));
        
        if (reset) {
          allNews = newsArticles;
        } else {
          allNews = [...allNews, ...newsArticles];
        }

        // Check if we have more news to load (but prefer Vietnamese)
        hasMoreNews = vietnameseNews.length < 200; // Focus on Vietnamese content expansion

        console.log(`üìä T·∫£i ${newsArticles.length} b√†i ti·∫øng Anh (T·ªïng Vi·ªát: ${vietnameseNews.length}, Anh: ${allNews.length})`);
        
      } catch (error) {
        console.error('‚ùå L·ªói t·∫£i tin ti·∫øng Anh:', error);
        
        // Try next API if current one fails
        currentAPIIndex = (currentAPIIndex + 1) % newsAPIs.length;
        if (currentAPIIndex !== 0) {
          await loadNews(reset); // Try with next API
        }
      }
      
      isLoading = false;
    }

    function filterAndDisplayNews(skipDisplay = false) {
      // Check cache first for INSTANT loading
      if (categoryCache[currentCategory] && categoryCache[currentCategory].length > 0) {
        console.log(`‚ö° CACHE HIT cho ${currentCategory}: ${categoryCache[currentCategory].length} b√†i`);
        if (!skipDisplay) {
          displayNews(categoryCache[currentCategory]);
          applySearchFilter();
        }
        return;
      }
      
      console.log(`üîÑ T·∫°o cache m·ªõi cho danh m·ª•c: ${currentCategory}`);
      
      // PRIORITIZE VIETNAMESE NEWS COMPLETELY - Always show Vietnamese first
      let filteredNews = [...vietnameseNews];
      
      // Only add English articles if Vietnamese news is insufficient (less than 50 articles)
      if (filteredNews.length < 50 && allNews.length > 0) {
        // Add minimal English content to reach 50 articles minimum
        const needed = Math.min(50 - filteredNews.length, 5); // Maximum 5 English articles
        filteredNews = [...filteredNews, ...allNews.slice(0, needed)];
      }

      // OPTIMIZED CATEGORY FILTERING - Faster algorithm
      if (currentCategory !== 'all') {
        const keywords = categoryKeywords[currentCategory];
        const keywordSet = new Set(keywords.map(k => k.toLowerCase())); // Use Set for O(1) lookup
        
        filteredNews = filteredNews.filter(article => {
          // Fast category match for Vietnamese articles
          if (article.isVietnamese && article.category === currentCategory) {
            return true;
          }
          
          // Keyword matching (optimized)
          const text = (article.title + ' ' + article.description).toLowerCase();
          for (const keyword of keywordSet) {
            if (text.includes(keyword)) return true;
          }
          return false;
        });
        
        console.log(`üìä Danh m·ª•c ${currentCategory}: ${filteredNews.length} b√†i`);
      }

      // FAST duplicate removal - simplified algorithm
      const seen = new Map();
      filteredNews = filteredNews.filter(article => {
        const key = article.url || article.title.toLowerCase().trim();
        if (seen.has(key)) return false;
        seen.set(key, true);
        return true;
      });

      // Sort by Vietnamese priority first, then by priority level, then by date
      filteredNews.sort((a, b) => {
        // Always prioritize Vietnamese articles
        if (a.isVietnamese && !b.isVietnamese) return -1;
        if (!a.isVietnamese && b.isVietnamese) return 1;
        
        // Within same language, sort by priority then date
        if (a.priority !== b.priority) {
          return (a.priority || 3) - (b.priority || 3);
        }
        return new Date(b.publishedAt) - new Date(a.publishedAt);
      });

      // Log status
      const vietnameseCount = filteredNews.filter(article => article.isVietnamese).length;
      const englishCount = filteredNews.length - vietnameseCount;
      console.log(`üìä Hi·ªÉn th·ªã: ${vietnameseCount} VN, ${englishCount} EN (T·ªïng: ${filteredNews.length})`);

      // Cache k·∫øt qu·∫£ ƒë·ªÉ tƒÉng t·ªëc ƒë·ªô chuy·ªÉn ƒë·ªïi danh m·ª•c
      categoryCache[currentCategory] = [...filteredNews];
      console.log(`üíæ ƒê√£ cache ${filteredNews.length} b√†i cho ${currentCategory}`);

      // Only display if not skipped (when called from loadMoreNews)
      if (!skipDisplay) {
        console.log(`üéØ G·ªçi displayNews v·ªõi ${filteredNews.length} b√†i...`);
        displayNews(filteredNews);
        console.log(`‚úÖ displayNews ho√†n t·∫•t`);
        applySearchFilter();
      } else {
        console.log(`‚è≠Ô∏è Skip display - ch·ªâ t·∫°o cache`);
      }
    }

    function displayNews(articles, append = false) {
      console.log(`üì∫ displayNews: ${articles.length} b√†i, append=${append}`);
      const container = document.getElementById('news-container');
      const noResults = document.getElementById('no-results');
      const loadMoreBtn = document.getElementById('load-more');
      const loading = document.getElementById('loading');

      // Always hide loading spinner when displaying
      if (loading) {
        loading.classList.add('hidden');
        console.log(`üö´ ƒê√£ ·∫©n loading spinner`);
      }

      if (articles.length === 0) {
        console.log(`‚ùå Kh√¥ng c√≥ b√†i b√°o ƒë·ªÉ hi·ªÉn th·ªã`);
        container.classList.add('hidden');
        noResults.classList.remove('hidden');
        loadMoreBtn.classList.add('hidden');
        return;
      }

      container.classList.remove('hidden');
      noResults.classList.add('hidden');
      
      // Get the grid container inside news-container
      const gridContainer = container.querySelector('div');
      
      // Clear container if NOT appending
      if (!append) {
        gridContainer.innerHTML = '';
        currentDisplayCount = 0;
      }

      // Calculate how many articles to display
      const startIndex = currentDisplayCount;
      const endIndex = Math.min(startIndex + ARTICLES_PER_PAGE, articles.length);
      const articlesToShow = articles.slice(startIndex, endIndex);
      
      console.log(`üìä Hi·ªÉn th·ªã b√†i ${startIndex + 1}-${endIndex} / ${articles.length}`);

      articlesToShow.forEach((article, index) => {
        if (!article.title || article.title === '[Removed]') return;
        
        // Skip if article already exists (prevent duplicates)
        const existingCards = gridContainer.querySelectorAll('.news-card');
        const articleExists = Array.from(existingCards).some(card => {
          const existingTitle = card.querySelector('h3').textContent.toLowerCase().trim();
          const newTitle = article.title.toLowerCase().trim();
          return existingTitle === newTitle;
        });
        
        if (!articleExists) {
          const newsCard = createNewsCard(article, startIndex + index);
          gridContainer.appendChild(newsCard);
          
          // ü§ñ Asynchronously update with ML classification (non-blocking)
          updateCardWithMLClassification(newsCard, article).catch(err => {
            console.warn('‚ö†Ô∏è ML update error:', err);
          });
        }
      });

      // Update display count
      currentDisplayCount = endIndex;
      const totalDisplayed = gridContainer.children.length;
      
      console.log(`‚úÖ ƒê√£ hi·ªÉn th·ªã ${totalDisplayed} b√†i (${currentDisplayCount}/${articles.length})`);
      
      // Show/hide load more button based on remaining articles
      if (currentDisplayCount < articles.length || window.remainingFeeds?.length > 0) {
        loadMoreBtn.classList.remove('hidden');
        loadMoreBtn.innerHTML = `<i class="fas fa-plus mr-2"></i>Xem th√™m (${totalDisplayed})`;
      } else {
        loadMoreBtn.classList.add('hidden');
      }
    }

    function createNewsCard(article, index) {
      const card = document.createElement('div');
      card.className = 'news-card bg-white rounded-xl shadow-md overflow-hidden border border-gray-100 fade-in-up';
      card.style.animationDelay = `${index * 0.1}s`;

      const imageUrl = article.urlToImage || 'https://via.placeholder.com/400x200/10b981/ffffff?text=AgriSense+AI';
      const publishedDate = new Date(article.publishedAt).toLocaleDateString('vi-VN');
      const description = article.description || 'Kh√¥ng c√≥ m√¥ t·∫£';
      const displayCategory = getCategoryFromArticle(article);
      
      // Detect if this is Vietnamese news
      const isVietnamese = vietnameseNews.some(vnNews => vnNews.title === article.title);
      const sourceFlag = isVietnamese ? 'üáªüá≥' : 'üåç';

      const searchIndex = [
        article.title || '',
        article.description || '',
        article.content || '',
        article.category || '',
        article.source?.name || '',
        displayCategory || ''
      ].join(' ').toLowerCase();

      card.dataset.title = (article.title || '').toLowerCase();
      card.dataset.description = (article.description || '').toLowerCase();
      card.dataset.category = (article.category || '').toLowerCase();
      card.dataset.content = (article.content || '').toLowerCase();
      card.dataset.source = (article.source?.name || '').toLowerCase();
      card.dataset.search = searchIndex;
      
      // Store full article data for modal
      card.articleData = article;
      
      // Add click event to open modal
      card.addEventListener('click', function(e) {
        // Don't open modal if clicking on links or buttons
        if (e.target.tagName === 'A' || e.target.tagName === 'BUTTON' || e.target.closest('a') || e.target.closest('button')) {
          return;
        }
        openArticleModal(article);
      });
      
      card.innerHTML = `
        <div class="relative">
          <img src="${imageUrl}" alt="${article.title}" class="w-full h-40 md:h-48 object-cover" onerror="this.src='https://via.placeholder.com/400x200/10b981/ffffff?text=AgriSense+AI'">
          <div class="absolute top-3 left-3">
            <span class="bg-green-500 text-white px-2 py-1 rounded-full text-xs font-medium shadow-sm category-badge">
              ${sourceFlag} ${displayCategory}
            </span>
          </div>
          ${isVietnamese ? '<div class="absolute top-3 right-3"><span class="bg-red-500 text-white px-2 py-1 rounded-full text-xs font-medium">Tin Vi·ªát</span></div>' : ''}
        </div>
        <div class="p-4 md:p-5">
          <div class="flex items-center gap-2 text-xs md:text-sm text-gray-500 mb-3">
            <i class="fas fa-calendar-alt text-green-500"></i>
            <span>${publishedDate}</span>
            <span class="mx-2">‚Ä¢</span>
            <span class="text-green-600 font-medium">${article.source.name}</span>
          </div>
          <h3 class="font-semibold text-base md:text-lg text-gray-900 mb-3 line-clamp-2 leading-tight">
            ${article.title}
          </h3>
          <p class="text-gray-600 mb-4 line-clamp-3 text-sm leading-relaxed">
            ${description}
          </p>
          <div class="flex items-center justify-between pt-2 border-t border-gray-100">
            <a href="${article.url}" target="_blank" class="inline-flex items-center text-green-600 hover:text-green-700 font-medium text-sm transition-colors">
              <i class="fas fa-external-link-alt mr-2 text-xs"></i>
              ƒê·ªçc th√™m
            </a>
            <div class="flex items-center gap-2">
              <button onclick="shareArticle('${article.url}', '${article.title.replace(/'/g, "\\'")}' )" class="text-gray-400 hover:text-green-600 transition-colors p-1 rounded-full hover:bg-green-50">
                <i class="fas fa-share-alt text-sm"></i>
              </button>
              ${isVietnamese ? '<span class="text-xs text-green-600 font-medium">VN</span>' : '<span class="text-xs text-blue-600 font-medium">EN</span>'}
            </div>
          </div>
        </div>
      `;

      return card;
    }

    // ü§ñ Async ML Classification for cards already displayed
    async function updateCardWithMLClassification(card, article) {
      try {
        const mlCategory = await classifyArticleWithML(article);
        
        // Update the category badge if it changed
        const badge = card.querySelector('.category-badge');
        if (badge) {
          const sourceFlag = badge.textContent.includes('üáªüá≥') ? 'üáªüá≥' : 'üåç';
          const oldCategory = badge.textContent.replace(sourceFlag, '').trim();
          
          if (oldCategory !== mlCategory) {
            badge.textContent = `${sourceFlag} ${mlCategory}`;
            badge.style.transition = 'all 0.3s ease';
            badge.style.opacity = '0.7';
            setTimeout(() => {
              badge.style.opacity = '1';
            }, 150);
            
            console.log(`ü§ñ Updated category: "${oldCategory}" ‚Üí "${mlCategory}"`);
            
            // Update card's data attributes for filtering
            card.dataset.category = mlCategory.toLowerCase();
          }
        }
      } catch (error) {
        console.warn('‚ö†Ô∏è Failed to update ML classification:', error);
      }
    }

    // ü§ñ ML Classification cache
    const classificationCache = {};

    async function classifyArticleWithML(article) {
      // Check cache first
      const cacheKey = (article.title || '').substring(0, 50);
      if (classificationCache[cacheKey]) {
        return classificationCache[cacheKey];
      }

      try {
        const response = await fetch('/api/classify-article', {
          method: 'POST',
          headers: {
            'Content-Type': 'application/json'
          },
          body: JSON.stringify({
            title: article.title || '',
            description: article.description || '',
            content: article.content || ''
          })
        });

        if (response.ok) {
          const data = await response.json();
          if (data.success && data.classification) {
            const displayCategory = data.classification.display_category || 'Kh√°c';
            classificationCache[cacheKey] = displayCategory;
            return displayCategory;
          }
        }
      } catch (error) {
        console.warn('‚ö†Ô∏è ML classification error, using fallback:', error);
      }

      // Fallback to rule-based if ML fails
      return getCategoryFromArticleFallback(article);
    }

    function getCategoryFromArticleFallback(article) {
      const text = (article.title + ' ' + article.description).toLowerCase();
      
      for (const [category, keywords] of Object.entries(categoryKeywords)) {
        if (keywords.some(keyword => text.includes(keyword.toLowerCase()))) {
          const categoryNames = {
            agriculture: 'N√¥ng nghi·ªáp',
            technology: 'C√¥ng ngh·ªá',
            climate: 'Kh√≠ h·∫≠u',
            livestock: 'ChƒÉn nu√¥i'
          };
          return categoryNames[category];
        }
      }
      
      return 'Tin t·ª©c';
    }

    function getCategoryFromArticle(article) {
      // Return fallback immediately for display
      // ML classification happens asynchronously in background
      return getCategoryFromArticleFallback(article);
    }

    async function loadMoreNews() {
      console.log('üîΩ User b·∫•m "T·∫£i th√™m"');
      
      if (isLoading) {
        console.log('‚è≥ ƒêang load, ch·ªù...');
        return;
      }
      
      // Get current filtered articles for this category
      const filteredArticles = categoryCache[currentCategory] || [];
      
      // Option 1: If we have more articles in current filter, show them
      if (currentDisplayCount < filteredArticles.length) {
        console.log(`üìÑ Hi·ªÉn th·ªã th√™m 10 b√†i t·ª´ cache (${currentDisplayCount}/${filteredArticles.length})`);
        displayNews(filteredArticles, true); // Append mode
        return;
      }
      
      // Option 2: If no more filtered articles, load more RSS feeds
      if (window.remainingFeeds && window.remainingFeeds.length > 0) {
        console.log('üì° T·∫£i th√™m RSS feeds...');
        
        const hasNewFeeds = await loadMoreFeeds();
        
        if (hasNewFeeds) {
          // Save current display count before clearing cache
          const previousDisplayCount = currentDisplayCount;
          
          // Clear cache to force re-filter with new data
          categoryCache[currentCategory] = [];
          
          // Re-filter to get updated article list (DON'T display yet)
          filterAndDisplayNews(true); // skipDisplay = true
          
          // Restore display count to continue from where we were
          currentDisplayCount = previousDisplayCount;
          
          // Now display next batch from updated cache (this will append)
          const filteredArticles = categoryCache[currentCategory] || [];
          if (currentDisplayCount < filteredArticles.length) {
            displayNews(filteredArticles, true); // Append mode
          } else {
            console.log('‚ö†Ô∏è Kh√¥ng c√≥ b√†i m·ªõi sau khi load feeds');
          }
          
          console.log('‚úÖ ƒê√£ t·∫£i v√† hi·ªÉn th·ªã tin m·ªõi');
        } else {
          console.log('‚ùå Kh√¥ng c√≤n ngu·ªìn RSS');
          document.getElementById('load-more').classList.add('hidden');
        }
      } else {
        console.log('üèÅ ƒê√£ h·∫øt t·∫•t c·∫£ tin t·ª©c');
        document.getElementById('load-more').classList.add('hidden');
      }
    }

    // Enhanced search function to include Vietnamese news
    function searchNews() {
      console.log('üîç Search function called');
      const searchQuery = document.getElementById('search-input').value.trim();
      console.log('üîç Search query:', searchQuery);
      console.log('üîç Total articles before search:', allNews.length);
      
      currentPage = 1;
      updateSearchUI();
      filterAndDisplayNews();
    }
    
    // Clear search function
    function clearSearch() {
      const searchInput = document.getElementById('search-input');
      searchInput.value = '';
      searchInput.focus();
      updateSearchUI();
      searchNews();
    }
    
    // Update search UI elements
    function updateSearchUI() {
      const searchInput = document.getElementById('search-input');
      const clearBtn = document.getElementById('clear-search');
      const searchResultsInfo = document.getElementById('search-results-info');
      
      if (searchInput.value.trim()) {
        clearBtn.classList.remove('hidden');
      } else {
        clearBtn.classList.add('hidden');
        searchResultsInfo.classList.add('hidden');
      }
    }
    
    // Update search results info
    function updateSearchResultsInfo(query, total, found) {
      const searchResultsInfo = document.getElementById('search-results-info');
      const searchResultsText = document.getElementById('search-results-text');
      
      if (query && query.trim()) {
        searchResultsText.textContent = `T√¨m th·∫•y ${found} k·∫øt qu·∫£ cho "${query}"`;
        searchResultsInfo.classList.remove('hidden');
      } else {
        searchResultsInfo.classList.add('hidden');
      }
    }

    function refreshLoadMoreButton() {
      const loadMoreBtn = document.getElementById('load-more');
      const container = document.getElementById('news-container');
      const gridContainer = container ? container.querySelector('div') : null;
      const searchValue = document.getElementById('search-input')?.value.trim();
      if (!loadMoreBtn || !gridContainer) return;

      if (searchValue) {
        loadMoreBtn.classList.add('hidden');
        return;
      }

      const totalDisplayed = gridContainer.querySelectorAll('.news-card').length;
      if (totalDisplayed < 100) {
        loadMoreBtn.classList.remove('hidden');
        loadMoreBtn.innerHTML = `<i class="fas fa-plus mr-2"></i>Xem th√™m (${totalDisplayed})`;
      } else {
        loadMoreBtn.classList.add('hidden');
      }
    }

    function applySearchFilter() {
      const searchInput = document.getElementById('search-input');
      const container = document.getElementById('news-container');
      const noResults = document.getElementById('no-results');
      const loadMoreBtn = document.getElementById('load-more');
      const gridContainer = container ? container.querySelector('div') : null;
      if (!gridContainer) return;

      const query = (searchInput?.value || '').trim().toLowerCase();
      const cards = Array.from(gridContainer.querySelectorAll('.news-card'));

      if (!query) {
        cards.forEach(card => {
          card.style.display = '';
        });
        if (cards.length > 0) {
          container.classList.remove('hidden');
          noResults.classList.add('hidden');
        }
        updateSearchResultsInfo('', cards.length, cards.length);
        refreshLoadMoreButton();
        return;
      }

      const searchWords = query.split(/\s+/).filter(Boolean);
      let matchCount = 0;

      cards.forEach(card => {
        const searchable = card.dataset.search || '';
        const matches = searchWords.some(word => searchable.includes(word));
        if (matches) {
          card.style.display = '';
          matchCount++;
        } else {
          card.style.display = 'none';
        }
      });

      updateSearchResultsInfo(searchInput.value, cards.length, matchCount);

      if (matchCount === 0) {
        container.classList.add('hidden');
        noResults.classList.remove('hidden');
      } else {
        container.classList.remove('hidden');
        noResults.classList.add('hidden');
      }

      if (loadMoreBtn) {
        loadMoreBtn.classList.add('hidden');
      }
    }

    // Test search function for debugging
    function testSearch() {
      console.log('=== SEARCH DEBUG ===');
      console.log('Total articles:', allNews.length);
      console.log('Current category:', currentCategory);
      console.log('Search input value:', document.getElementById('search-input').value);
      
      if (allNews.length > 0) {
        console.log('Sample article:', allNews[0]);
      } else {
        console.log('‚ùå No articles loaded yet!');
      }
      
      return allNews.length;
    }
    
    // Add to window for console access
    window.testSearch = testSearch;

    // Share Modal Functions
    let currentShareUrl = '';
    let currentShareTitle = '';

    function shareArticle(url, title) {
      currentShareUrl = url;
      currentShareTitle = title;
      
      const shareModal = document.getElementById('share-modal');
      const shareOptions = document.getElementById('share-options');
      
      // Create share options
      shareOptions.innerHTML = `
        
        <button onclick="shareToFacebook()" class="group flex flex-col items-center gap-2 p-3 rounded-xl hover:bg-gray-50 transition-all" title="Chia s·∫ª l√™n Facebook">
          <div class="w-16 h-16 bg-blue-600 hover:bg-blue-700 rounded-full flex items-center justify-center transition-all group-hover:scale-110 shadow-lg">
            <i class="fab fa-facebook-f text-white text-2xl"></i>
          </div>
          <span class="text-xs text-gray-600 font-medium">Facebook</span>
        </button>

        <button onclick="shareToTwitter()" class="group flex flex-col items-center gap-2 p-3 rounded-xl hover:bg-gray-50 transition-all" title="Chia s·∫ª l√™n Twitter">
          <div class="w-16 h-16 bg-black hover:bg-gray-800 rounded-full flex items-center justify-center transition-all group-hover:scale-110 shadow-lg">
            <i class="fab fa-twitter text-white text-2xl"></i>
          </div>
          <span class="text-xs text-gray-600 font-medium">Twitter</span>
        </button>

        <button onclick="shareToTelegram()" class="group flex flex-col items-center gap-2 p-3 rounded-xl hover:bg-gray-50 transition-all" title="Chia s·∫ª qua Telegram">
          <div class="w-16 h-16 bg-blue-400 hover:bg-blue-500 rounded-full flex items-center justify-center transition-all group-hover:scale-110 shadow-lg">
            <i class="fab fa-telegram-plane text-white text-2xl"></i>
          </div>
          <span class="text-xs text-gray-600 font-medium">Telegram</span>
        </button>

        <button onclick="shareViaEmail()" class="group flex flex-col items-center gap-2 p-3 rounded-xl hover:bg-gray-50 transition-all" title="G·ª≠i qua email">
          <div class="w-16 h-16 bg-gray-600 hover:bg-gray-700 rounded-full flex items-center justify-center transition-all group-hover:scale-110 shadow-lg">
            <i class="fas fa-envelope text-white text-2xl"></i>
          </div>
          <span class="text-xs text-gray-600 font-medium">Email</span>
        </button>

        <button onclick="copyShareLink(event)" class="group flex flex-col items-center gap-2 p-3 rounded-xl hover:bg-gray-50 transition-all" title="Sao ch√©p li√™n k·∫øt">
          <div class="w-16 h-16 bg-green-600 hover:bg-green-700 rounded-full flex items-center justify-center transition-all group-hover:scale-110 shadow-lg">
            <i class="fas fa-copy text-white text-2xl"></i>
          </div>
          <span class="text-xs text-gray-600 font-medium">Copy Link</span>
        </button>
      `;
      
      shareModal.classList.remove('hidden');
    }

    function closeShareModal(event) {
      if (!event || event.target.id === 'share-modal') {
        document.getElementById('share-modal').classList.add('hidden');
      }
    }

    function shareToFacebook() {
      const fbUrl = `https://www.facebook.com/sharer/sharer.php?u=${encodeURIComponent(currentShareUrl)}`;
      window.open(fbUrl, '_blank', 'width=600,height=400');
      closeShareModal();
    }

    function shareToTwitter() {
      const twitterUrl = `https://twitter.com/intent/tweet?url=${encodeURIComponent(currentShareUrl)}&text=${encodeURIComponent(currentShareTitle)}`;
      window.open(twitterUrl, '_blank', 'width=600,height=400');
      closeShareModal();
    }

    function shareToTelegram() {
      const telegramUrl = `https://t.me/share/url?url=${encodeURIComponent(currentShareUrl)}&text=${encodeURIComponent(currentShareTitle)}`;
      window.open(telegramUrl, '_blank', 'width=600,height=400');
      closeShareModal();
    }

    function shareViaEmail() {
      const subject = encodeURIComponent(currentShareTitle);
      const body = encodeURIComponent(`Xem b√†i vi·∫øt n√†y: ${currentShareUrl}`);
      window.location.href = `mailto:?subject=${subject}&body=${body}`;
      closeShareModal();
    }

    function copyShareLink(event) {
      if (!currentShareUrl) {
        alert('Kh√¥ng c√≥ link ƒë·ªÉ sao ch√©p!');
        return;
      }
      
      navigator.clipboard.writeText(currentShareUrl).then(() => {
        // Show success feedback
        const btn = event.target.closest('button');
        if (btn) {
          const iconDiv = btn.querySelector('div');
          const label = btn.querySelector('span');
          
          if (iconDiv && label) {
            // Change to success state
            iconDiv.className = 'w-16 h-16 bg-green-600 rounded-full flex items-center justify-center transition-all shadow-lg';
            iconDiv.innerHTML = '<i class="fas fa-check text-white text-2xl"></i>';
            label.textContent = 'ƒê√£ copy!';
          }
        }
        
        setTimeout(() => {
          closeShareModal();
        }, 1000);
      }).catch((err) => {
        console.error('Copy error:', err);
        alert('Kh√¥ng th·ªÉ sao ch√©p. Vui l√≤ng th·ª≠ l·∫°i!');
      });
    }

    // Close share modal with Escape key
    document.addEventListener('keydown', function(e) {
      if (e.key === 'Escape') {
        closeShareModal();
      }
    });

    function showLoading() {
      document.getElementById('loading').classList.remove('hidden');
      document.getElementById('news-container').classList.add('hidden');
      document.getElementById('no-results').classList.add('hidden');
    }

    function hideLoading() {
      document.getElementById('loading').classList.add('hidden');
    }

    function showNoResults() {
      document.getElementById('loading').classList.add('hidden');
      document.getElementById('news-container').classList.add('hidden');
      document.getElementById('no-results').classList.remove('hidden');
    }

    function goBack() {
      window.history.back();
    }

    // Article Modal Functions
    function openArticleModal(article) {
      console.log('üì∞ M·ªü modal cho:', article.title);
      
      const modal = document.getElementById('article-modal');
      const modalImageColumn = document.getElementById('modal-image-column');
      const modalContent = document.getElementById('modal-content');
      const modalActionsDesktop = document.getElementById('modal-actions-desktop');
      const modalActionsMobile = document.getElementById('modal-actions-mobile');
      
      const imageUrl = article.urlToImage || 'https://via.placeholder.com/600x800/10b981/ffffff?text=AgriSense+AI';
      const publishedDate = new Date(article.publishedAt).toLocaleDateString('vi-VN', {
        year: 'numeric',
        month: 'long',
        day: 'numeric',
        hour: '2-digit',
        minute: '2-digit'
      });
      const isVietnamese = vietnameseNews.some(vnNews => vnNews.title === article.title);
      const displayCategory = getCategoryFromArticle(article);
      
      // Clean content - remove HTML tags if any
      let content = article.content || article.description || 'N·ªôi dung b√†i vi·∫øt kh√¥ng c√≥ s·∫µn. Vui l√≤ng nh·∫•n "ƒê·ªçc b√†i g·ªëc" ƒë·ªÉ xem ƒë·∫ßy ƒë·ªß.';
      content = content.replace(/<[^>]*>/g, '');
      
      // Left Column - Image with category badge
      modalImageColumn.innerHTML = `
        <div class="relative h-full flex items-center justify-center bg-gradient-to-br from-gray-100 to-gray-200">
          <img src="${imageUrl}" alt="${article.title}" 
               class="w-full h-full object-cover" 
               onerror="this.src='https://via.placeholder.com/600x800/10b981/ffffff?text=AgriSense+AI'">
          <div class="absolute top-4 left-4">
            <span class="bg-green-500 text-white px-3 py-2 rounded-lg text-sm font-medium shadow-lg backdrop-blur-sm bg-opacity-90">
              ${isVietnamese ? 'üáªüá≥' : 'üåç'} ${displayCategory}
            </span>
          </div>
          ${isVietnamese ? `
            <div class="absolute top-4 right-4">
              <span class="bg-red-500 text-white px-3 py-2 rounded-lg text-xs font-bold shadow-lg">
                TIN VI·ªÜT
              </span>
            </div>
          ` : ''}
          
          <div class="absolute inset-0 bg-gradient-to-t from-black/30 via-transparent to-transparent"></div>
        </div>
      `;
      
      // Action Buttons - Circular style (subtle gray)
      const actionButtonsHTML = `
        <a href="${article.url}" target="_blank" 
           class="w-10 h-10 bg-gray-200 hover:bg-gray-300 text-gray-600 hover:text-gray-800 rounded-full flex items-center justify-center shadow-sm hover:shadow-md transition-all" 
           title="ƒê·ªçc b√†i g·ªëc"
           onclick="event.stopPropagation()">
          <i class="fas fa-external-link-alt text-sm"></i>
        </a>
        <button onclick="shareArticle('${article.url.replace(/'/g, "\\'")}', '${article.title.replace(/'/g, "\\'")}'); event.stopPropagation();" 
                class="w-10 h-10 bg-gray-200 hover:bg-gray-300 text-gray-600 hover:text-gray-800 rounded-full flex items-center justify-center shadow-sm hover:shadow-md transition-all" 
                title="Chia s·∫ª">
          <i class="fas fa-share-alt text-sm"></i>
        </button>
      `;
      
      // Set buttons for desktop (below image)
      modalActionsDesktop.innerHTML = actionButtonsHTML;
      
      // Set buttons for mobile (at bottom)
      modalActionsMobile.innerHTML = `
        <div class="flex justify-center gap-3">
          ${actionButtonsHTML}
        </div>
      `;
      
      // Right Column - Content with enhanced readability
      modalContent.innerHTML = `
        
        <div class="md:hidden mb-6 -mx-6 -mt-6">
          <div class="relative">
            <img src="${imageUrl}" alt="${article.title}" 
                 class="w-full h-64 object-cover" 
                 onerror="this.src='https://via.placeholder.com/600x400/10b981/ffffff?text=AgriSense+AI'">

            ${displayCategory ? `
              <div class="absolute top-4 left-4">
                <span class="bg-gradient-to-r from-green-500 to-green-600 text-white px-4 py-2 rounded-full text-sm font-semibold shadow-lg backdrop-blur-sm bg-opacity-90 flex items-center gap-2">
                  <i class="fas fa-tag"></i>
                  ${displayCategory}
                </span>
              </div>
            ` : ''}

            ${isVietnamese ? `
              <div class="absolute top-4 right-4">
                <span class="bg-red-500 text-white px-3 py-1.5 rounded-full text-xs font-bold shadow-lg backdrop-blur-sm bg-opacity-90">
                  TIN VI·ªÜT
                </span>
              </div>
            ` : ''}
          </div>
        </div>

        <h1 class="text-3xl md:text-4xl font-bold text-gray-900 mb-6 leading-tight">
          ${article.title}
        </h1>

        <div class="flex items-center gap-4 text-sm text-gray-500 mb-6 pb-4 border-b border-gray-200 flex-wrap">
          <div class="flex items-center gap-2">
            <i class="fas fa-calendar-alt"></i>
            <span>${publishedDate}</span>
          </div>
          <div class="flex items-center gap-2">
            <i class="fas fa-newspaper"></i>
            <span class="font-medium">${article.source.name}</span>
          </div>
        </div>

        ${article.description ? `
          <div class="bg-blue-50 border-l-4 border-blue-500 p-5 rounded-r mb-6">
            <p class="text-gray-800 font-semibold leading-relaxed text-lg">
              ${article.description}
            </p>
          </div>
        ` : ''}

        <div class="prose prose-lg max-w-none mb-6">
          <div class="text-gray-700 leading-relaxed text-base space-y-4">
            ${content.split('\n').map(para => {
              const trimmed = para.trim();
              if (!trimmed) return '';
              // Check if it's a heading-like sentence (short and likely a section title)
              if (trimmed.length < 60 && !trimmed.includes('.')) {
                return `<h3 class="text-xl font-semibold text-gray-900 mt-6 mb-3">${trimmed}</h3>`;
              }
              return `<p class="mb-4">${trimmed}</p>`;
            }).join('')}
          </div>

          ${content.length < 500 ? `
            <div class="mt-8 p-6 bg-gradient-to-br from-green-50 to-blue-50 rounded-lg border border-green-200">
              <h3 class="text-lg font-semibold text-gray-900 mb-3 flex items-center gap-2">
                <i class="fas fa-info-circle text-green-600"></i>
                Th√¥ng tin th√™m v·ªÅ b√†i vi·∫øt
              </h3>
              <div class="space-y-3 text-gray-700">
                <p>üì∞ <strong>Ngu·ªìn tin:</strong> ${article.source.name} - M·ªôt trong nh·ªØng ngu·ªìn tin uy t√≠n h√†ng ƒë·∫ßu t·∫°i Vi·ªát Nam</p>
                <p>üïê <strong>Th·ªùi gian:</strong> ${publishedDate}</p>
                <p>üìç <strong>Danh m·ª•c:</strong> ${article.categories && article.categories.length > 0 ? article.categories.join(', ') : 'Tin t·ª©c t·ªïng h·ª£p'}</p>
                <p class="pt-3 border-t border-green-300 text-sm italic">
                  üí° N·ªôi dung chi ti·∫øt v√† ƒë·∫ßy ƒë·ªß nh·∫•t c·ªßa b√†i vi·∫øt ƒë∆∞·ª£c c·∫≠p nh·∫≠t li√™n t·ª•c tr√™n website g·ªëc. 
                  Nh·∫•n n√∫t "ƒê·ªçc b√†i g·ªëc" ƒë·ªÉ xem to√†n b·ªô h√¨nh ·∫£nh, video v√† n·ªôi dung b·ªï sung.
                </p>
              </div>
            </div>
          ` : ''}

          <div class="mt-6 p-4 bg-gray-50 rounded-lg border-l-4 border-green-500">
            <p class="text-sm text-gray-600">
              <i class="fas fa-lightbulb text-yellow-500 mr-2"></i>
              <strong>G·ª£i √Ω:</strong> B√†i vi·∫øt n√†y thu·ªôc lƒ©nh v·ª±c ${article.categories && article.categories[0] ? article.categories[0] : 'tin t·ª©c t·ªïng h·ª£p'}. 
              B·∫°n c√≥ th·ªÉ t√¨m th√™m c√°c b√†i vi·∫øt li√™n quan b·∫±ng c√°ch ch·ªçn danh m·ª•c t∆∞∆°ng ·ª©ng ·ªü tr√™n.
            </p>
          </div>
        </div>

        <div class="mt-8 pt-4 border-t border-gray-200 bg-gray-50 -mx-6 px-6 py-4 rounded">
          <div class="flex items-center gap-2 text-sm text-gray-600">
            <i class="fas fa-info-circle"></i>
            <span>B√†i vi·∫øt ƒë·∫ßy ƒë·ªß v√† c·∫≠p nh·∫≠t nh·∫•t t·∫°i: <strong class="text-gray-800">${article.source.name}</strong></span>
          </div>
        </div>
      `;
      
      // Show modal with animation
      modal.classList.remove('hidden');
      document.body.style.overflow = 'hidden'; // Prevent background scroll
    }
    
    function closeArticleModal(event) {
      // Close if clicking backdrop or called directly
      if (!event || event.target.id === 'article-modal') {
        const modal = document.getElementById('article-modal');
        modal.classList.add('hidden');
        document.body.style.overflow = ''; // Restore scroll
      }
    }
    
    // Close modal with Escape key
    document.addEventListener('keydown', function(e) {
      if (e.key === 'Escape') {
        closeArticleModal();
      }
    });

    // CSS utility classes
    const style = document.createElement('style');
    style.textContent = `
      .line-clamp-2 {
        display: -webkit-box;
        -webkit-line-clamp: 2;
        -webkit-box-orient: vertical;
        overflow: hidden;
      }
      
      .line-clamp-3 {
        display: -webkit-box;
        -webkit-line-clamp: 3;
        -webkit-box-orient: vertical;
        overflow: hidden;
      }
    `;
    document.head.appendChild(style);
  </script>
</body>
</html>
