<!DOCTYPE html>
<html lang="vi">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover" />
  
  <title>Hồ sơ - AgriSense AI</title>
  
  <!-- Favicon -->
  <link rel="icon" type="image/x-icon" href="/static/favicon logo/favicon/favicon.ico">
  
  <!-- Tailwind CSS -->
  <script src="https://cdn.tailwindcss.com?v=3.4.0"></script>
  <!-- Font Awesome -->
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" />
  <!-- Cropper.js -->
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/cropperjs/1.5.13/cropper.min.css" />
  <script src="https://cdnjs.cloudflare.com/ajax/libs/cropperjs/1.5.13/cropper.min.js"></script>
  <!-- Profile Extended JS -->
  <script src="/static/profile-extended.js" defer></script>
  
  <style>
    body {
      min-height: 100vh;
      background-color: #f9fafb;
    }
    
    input:focus {
      outline: none;
      border-color: #16a34a;
      box-shadow: 0 0 0 3px rgba(22, 163, 74, 0.1);
    }
    
    .avatar-wrapper {
      position: relative;
      display: inline-block;
    }
    
    .avatar-edit-btn {
      position: absolute;
      bottom: 0;
      right: 0;
      width: 36px;
      height: 36px;
      border-radius: 50%;
      background: #16a34a;
      color: white;
      display: flex;
      align-items: center;
      justify-content: center;
      cursor: pointer;
      box-shadow: 0 2px 8px rgba(0,0,0,0.15);
      transition: all 0.3s;
    }
    
    .avatar-edit-btn:hover {
      background: #15803d;
      transform: scale(1.1);
    }
    
    .modal {
      display: none;
      position: fixed;
      z-index: 1000;
      left: 0;
      top: 0;
      width: 100%;
      height: 100%;
      background-color: rgba(0,0,0,0.5);
      animation: fadeIn 0.2s;
    }
    
    .modal.active {
      display: flex;
      align-items: center;
      justify-content: center;
    }
    
    @keyframes fadeIn {
      from { opacity: 0; }
      to { opacity: 1; }
    }
    
    .crop-container {
      max-width: 90vw;
      max-height: 70vh;
    }
    
    .crop-container img {
      max-width: 100%;
    }
    
    .loading-spinner {
      border: 3px solid #f3f3f3;
      border-top: 3px solid #10b981;
      border-radius: 50%;
      width: 40px;
      height: 40px;
      animation: spin 1s linear infinite;
    }
    
    @keyframes spin {
      0% { transform: rotate(0deg); }
      100% { transform: rotate(360deg); }
    }
    
    .post-card {
      transition: all 0.3s;
    }
    
    .post-card:hover {
      transform: translateY(-2px);
      box-shadow: 0 10px 20px rgba(0,0,0,0.1);
    }
    
    /* Mobile navigation tabs improvements */
    @media (max-width: 640px) {
      .profile-tab {
        min-width: 48px;
        display: flex;
        align-items: center;
        justify-content: center;
      }
      
      .profile-tab i {
        font-size: 1.1rem;
      }
      
      /* Hide scrollbar on mobile tabs */
      .flex.overflow-x-auto::-webkit-scrollbar {
        display: none;
        height: 0;
      }
      
      .flex.overflow-x-auto {
        -ms-overflow-style: none;
        scrollbar-width: none;
        scroll-behavior: smooth;
      }
    }
    
    /* Global scrollbar hiding for overflow-x-auto */
    .overflow-x-auto::-webkit-scrollbar {
      display: none !important;
      height: 0 !important;
    }
    
    .overflow-x-auto {
      -ms-overflow-style: none !important;
      scrollbar-width: none !important;
    }
    
    /* Smooth transitions for sections */
    #posts-section,
    #photos-section, 
    #friends-section,
    #intro-section {
      animation: fadeInUp 0.3s ease-out;
    }
    
    @keyframes fadeInUp {
      from {
        opacity: 0;
        transform: translateY(10px);
      }
      to {
        opacity: 1;
        transform: translateY(0);
      }
    }
  </style>
</head>
<body class="bg-gray-50">
  
  <!-- Header -->
  <header class="bg-green-100 border-b border-green-200 shadow-sm">
    <div class="h-20 flex items-center justify-between px-4 md:px-6">
      <div class="flex items-center gap-3">
        <button onclick="window.history.back()" class="text-white bg-green-600 hover:bg-green-700 transition-colors p-2 rounded-lg shadow-lg border-2 border-green-500" title="Quay lại">
          <i class="fas fa-arrow-left"></i>
        </button>
        <img src="/static/logo/logo.png" alt="AgriSense AI" class="h-12 md:h-14 w-auto object-contain">
      </div>
      
      <!-- Notification Bell -->
      <div class="flex items-center gap-3">
        <div class="relative">
          <button onclick="toggleNotifications()" class="relative p-2 text-gray-600 hover:bg-white rounded-lg transition-colors">
            <i class="fas fa-bell text-xl"></i>
            <span id="notification-badge" class="hidden absolute -top-1 -right-1 w-5 h-5 bg-red-600 text-white text-xs rounded-full flex items-center justify-center font-bold">0</span>
          </button>
          
          <!-- Notifications Dropdown -->
          <div id="notifications-dropdown" class="hidden absolute right-0 mt-2 w-80 bg-white rounded-xl shadow-xl border border-gray-200 z-50 max-h-96 overflow-y-auto">
            <div class="p-4 border-b border-gray-200 flex items-center justify-between">
              <h3 class="font-bold text-lg">Thông báo</h3>
              <button onclick="markAllAsRead()" class="text-xs text-green-600 hover:underline">Đánh dấu đã đọc</button>
            </div>
            <div id="notifications-list">
              <div class="flex justify-center py-8">
                <div class="loading-spinner"></div>
              </div>
            </div>
          </div>
        </div>
      </div>
    </div>
  </header>

  <!-- Main Content -->
  <div class="max-w-7xl mx-auto bg-white">
    
    <!-- Cover Background -->
    <div class="h-40 sm:h-48 md:h-64 bg-gradient-to-r from-green-400 to-green-600 relative">
      <!-- Removed edit cover button -->
    </div>
    
    <!-- Profile Info Container -->
    <div class="px-3 sm:px-4 md:px-6 pb-3 sm:pb-4 border-b border-gray-300">
      <!-- Avatar and Name Row -->
      <div class="flex flex-col sm:flex-row sm:items-end sm:justify-between -mt-10 sm:-mt-12 md:-mt-16 gap-3 sm:gap-4">
        <!-- Left: Avatar + Name (horizontal) -->
        <div class="flex items-end gap-3 sm:gap-4">
          <!-- Avatar -->
          <div class="avatar-wrapper flex-shrink-0 relative">
            <img id="profile-avatar" src="" alt="Avatar" class="w-24 h-24 sm:w-32 sm:h-32 md:w-40 md:h-40 rounded-full object-cover border-4 border-white shadow-xl" onerror="this.style.display='none'; document.getElementById('avatar-placeholder').style.display='flex';" />
            <div id="avatar-placeholder" class="w-24 h-24 sm:w-32 sm:h-32 md:w-40 md:h-40 rounded-full bg-green-600 text-white flex items-center justify-center text-3xl sm:text-4xl md:text-5xl font-bold border-4 border-white shadow-xl" style="display:none;">
              ?
            </div>
            <!-- Online Status Indicator -->
            <div id="online-indicator" class="absolute bottom-1 right-1 w-5 h-5 sm:w-6 sm:h-6 rounded-full border-3 border-white shadow-lg" style="background-color: #6B7280;">
            </div>
            <div id="avatar-edit-btn" class="avatar-edit-btn" onclick="showAvatarOptions()" style="display:none;">
              <i class="fas fa-camera"></i>
            </div>
          </div>
          
          <!-- Name and Stats (right of avatar, aligned to bottom) -->
          <div class="pb-1 sm:pb-2 flex-1 min-w-0">
            <h1 id="profile-name" class="text-xl sm:text-2xl md:text-3xl font-bold text-gray-900 mb-1 truncate">Đang tải...</h1>
            <p id="profile-email" class="text-gray-600 text-xs sm:text-sm mb-2 truncate">email@example.com</p>
            <div class="flex flex-wrap gap-1.5 sm:gap-2 text-xs sm:text-sm text-gray-600">
              <span><span id="posts-count" class="font-semibold">0</span> bài viết</span>
              <span>•</span>
              <span><span class="friends-count font-semibold">0</span> bạn bè</span>
              <span>•</span>
              <span><span id="photos-count" class="font-semibold">0</span> ảnh</span>
            </div>
          </div>
        </div>
        
        <!-- Right: Action Buttons -->
        <div class="flex gap-2 pb-2 flex-shrink-0">
          <!-- Action Buttons (Owner View) -->
          <div id="owner-actions" class="relative" style="display:none;">
            <button onclick="toggleSettingsMenu()" class="px-4 py-2 bg-gray-200 hover:bg-gray-300 rounded-lg font-medium transition-colors flex items-center gap-2 text-sm whitespace-nowrap">
              <i class="fas fa-cog"></i>
              <span class="hidden sm:inline">Chỉnh sửa trang cá nhân</span>
              <span class="sm:hidden">Chỉnh sửa</span>
            </button>
            
            <!-- Settings Dropdown Menu -->
            <div id="settings-menu" class="hidden absolute top-full right-0 mt-2 w-56 bg-white rounded-xl shadow-xl border border-gray-200 py-2 z-50">
              <button onclick="openEditProfileModal()" class="w-full text-left px-4 py-3 hover:bg-gray-50 flex items-center gap-3 transition-colors">
                <i class="fas fa-user text-green-600"></i>
                <span class="text-gray-700">Chỉnh sửa thông tin</span>
              </button>
              <button onclick="openChangePasswordModal()" class="w-full text-left px-4 py-3 hover:bg-gray-50 flex items-center gap-3 transition-colors">
                <i class="fas fa-key text-blue-600"></i>
                <span class="text-gray-700">Đổi mật khẩu</span>
              </button>
              <button onclick="togglePrivacy()" class="w-full text-left px-4 py-3 hover:bg-gray-50 flex items-center gap-3 transition-colors">
                <i class="fas fa-lock text-purple-600"></i>
                <span class="text-gray-700">Quyền riêng tư</span>
              </button>
              <hr class="my-2">
              <button onclick="logout()" class="w-full text-left px-4 py-3 hover:bg-red-50 flex items-center gap-3 transition-colors text-red-600">
                <i class="fas fa-sign-out-alt"></i>
                <span>Đăng xuất</span>
              </button>
            </div>
          </div>
          
          <!-- Action Buttons (Visitor View) -->
          <div id="visitor-actions" class="flex gap-2" style="display:none;">
            <!-- Add Friend Button -->
            <button id="add-friend-btn" onclick="sendFriendRequest()" class="px-4 py-2 bg-green-600 hover:bg-green-700 text-white rounded-lg font-medium transition-colors flex items-center gap-2 text-sm whitespace-nowrap">
              <i class="fas fa-user-plus"></i>
              <span class="hidden sm:inline">Thêm bạn bè</span>
              <i class="fas fa-user-plus sm:hidden"></i>
            </button>
            
            <!-- Friend Request Sent Button -->
            <button id="request-sent-btn" onclick="cancelFriendRequest()" class="hidden px-4 py-2 bg-gray-200 hover:bg-gray-300 text-gray-700 rounded-lg font-medium transition-colors flex items-center gap-2 text-sm whitespace-nowrap">
              <i class="fas fa-clock"></i>
              <span class="hidden sm:inline">Đã gửi lời mời</span>
            </button>
            
            <!-- Accept/Reject Friend Request Buttons -->
            <div id="request-received-btns" class="hidden flex gap-2">
              <button onclick="acceptFriendRequest()" class="px-4 py-2 bg-green-600 hover:bg-green-700 text-white rounded-lg font-medium transition-colors flex items-center gap-2 text-sm whitespace-nowrap">
                <i class="fas fa-check"></i>
                <span class="hidden sm:inline">Chấp nhận</span>
              </button>
              <button onclick="rejectFriendRequest()" class="px-4 py-2 bg-red-600 hover:bg-red-700 text-white rounded-lg font-medium transition-colors flex items-center gap-2 text-sm whitespace-nowrap">
                <i class="fas fa-times"></i>
                <span class="hidden sm:inline">Từ chối</span>
              </button>
            </div>
            
            <!-- Already Friends Button -->
            <button id="friends-btn" onclick="removeFriend()" class="hidden px-4 py-2 bg-gray-200 hover:bg-gray-300 text-gray-700 rounded-lg font-medium transition-colors flex items-center gap-2 text-sm whitespace-nowrap">
              <i class="fas fa-user-check"></i>
              <span class="hidden sm:inline">Bạn bè</span>
            </button>
            
            <!-- Message Button -->
            <button class="px-4 py-2 bg-blue-600 hover:bg-blue-700 text-white rounded-lg font-medium transition-colors flex items-center gap-2 text-sm whitespace-nowrap">
              <i class="fas fa-comment"></i>
              <span class="hidden sm:inline">Nhắn tin</span>
            </button>
          </div>
        </div>
      </div>
      
      <!-- Navigation Tabs -->
      <div class="mt-3 sm:mt-4">
        <div class="flex gap-0.5 sm:gap-1 border-t border-gray-300 -mb-px overflow-x-auto">
          <button onclick="switchTab('posts')" class="profile-tab px-3 sm:px-4 py-2.5 sm:py-3 border-b-4 border-green-600 text-green-600 font-semibold -mb-px text-sm sm:text-base whitespace-nowrap">
            <i class="fas fa-newspaper sm:hidden"></i>
            <span class="hidden sm:inline">Bài viết</span>
          </button>
          <button onclick="switchTab('intro')" class="profile-tab px-3 sm:px-4 py-2.5 sm:py-3 text-gray-600 hover:bg-gray-100 transition-colors text-sm sm:text-base whitespace-nowrap">
            <i class="fas fa-info-circle sm:hidden"></i>
            <span class="hidden sm:inline">Giới thiệu</span>
          </button>
          <button onclick="switchTab('friends')" class="profile-tab px-3 sm:px-4 py-2.5 sm:py-3 text-gray-600 hover:bg-gray-100 transition-colors text-sm sm:text-base whitespace-nowrap">
            <i class="fas fa-user-friends sm:hidden"></i>
            <span class="hidden sm:inline">Bạn bè</span>
          </button>
          <button onclick="switchTab('photos')" class="profile-tab px-3 sm:px-4 py-2.5 sm:py-3 text-gray-600 hover:bg-gray-100 transition-colors text-sm sm:text-base whitespace-nowrap">
            <i class="fas fa-images sm:hidden"></i>
            <span class="hidden sm:inline">Ảnh</span>
          </button>
        </div>
      </div>
    </div>
    <!-- Content Grid -->
    <div class="grid grid-cols-1 lg:grid-cols-12 gap-3 sm:gap-4 p-3 sm:p-4 md:p-6 bg-gray-50">
      
      <!-- Left Sidebar - Hidden on mobile by default, shown when switching to intro tab -->
      <div class="hidden lg:block lg:col-span-5 xl:col-span-4 space-y-3 sm:space-y-4">
        
        <!-- Intro Card -->
        <div class="bg-white rounded-lg sm:rounded-xl shadow p-3 sm:p-4">
          <h2 class="text-lg sm:text-xl font-bold text-gray-900 mb-3 sm:mb-4">Giới thiệu</h2>
          
          <div id="alert-message" class="hidden mb-3 sm:mb-4 p-3 rounded text-sm"></div>
          
          <!-- Bio/Description -->
          <div class="mb-3 sm:mb-4">
            <p id="user-bio" class="text-gray-600 text-center py-2 sm:py-3 text-sm sm:text-base">Chưa có giới thiệu</p>
            <button onclick="openEditProfileModal()" class="w-full mt-2 px-3 sm:px-4 py-2 bg-gray-200 hover:bg-gray-300 rounded-lg font-medium text-xs sm:text-sm transition-colors">
              Chỉnh sửa tiểu sử
            </button>
          </div>
          
          <!-- Info List -->
          <div class="space-y-2.5 sm:space-y-3 pt-3 border-t border-gray-200">
            <div class="flex items-center gap-2.5 sm:gap-3 text-gray-700">
              <i class="fas fa-envelope w-4 sm:w-5 text-gray-500 text-sm sm:text-base"></i>
              <span id="profile-email-sidebar" class="text-xs sm:text-sm truncate">email@example.com</span>
            </div>
            
            <div class="flex items-center gap-2.5 sm:gap-3 text-gray-700">
              <i class="fas fa-calendar-alt w-4 sm:w-5 text-gray-500 text-sm sm:text-base"></i>
              <span class="text-xs sm:text-sm">Tham gia <span id="created-at" class="font-medium">-</span></span>
            </div>
            
            <div class="flex items-center gap-2.5 sm:gap-3 text-gray-700">
              <i class="fas fa-clock w-4 sm:w-5 text-gray-500 text-sm sm:text-base"></i>
              <span class="text-xs sm:text-sm">Hoạt động <span id="last-login" class="font-medium">-</span></span>
            </div>
          </div>
        </div>
        
        <!-- Friends Card -->
        <div class="bg-white rounded-lg sm:rounded-xl shadow p-3 sm:p-4">
          <div class="flex items-center justify-between mb-3 sm:mb-4">
            <h2 class="text-lg sm:text-xl font-bold text-gray-900">Bạn bè</h2>
            <a href="#" onclick="switchTab('friends'); return false;" class="text-green-600 hover:underline text-xs sm:text-sm font-medium">Xem tất cả</a>
          </div>
          <div id="friends-preview" class="grid grid-cols-3 gap-1.5 sm:gap-2">
            <!-- Will be populated by JavaScript -->
          </div>
          <p id="no-friends-preview" class="text-gray-500 text-xs sm:text-sm text-center py-3 sm:py-4 hidden">Chưa có bạn bè</p>
        </div>
        
        <!-- Photos Card -->
        <div class="bg-white rounded-lg sm:rounded-xl shadow p-3 sm:p-4">
          <div class="flex items-center justify-between mb-3 sm:mb-4">
            <h2 class="text-lg sm:text-xl font-bold text-gray-900">Ảnh</h2>
            <a href="#" onclick="switchTab('photos'); return false;" class="text-green-600 hover:underline text-xs sm:text-sm font-medium">Xem tất cả</a>
          </div>
          <div id="photos-preview" class="grid grid-cols-3 gap-1.5 sm:gap-2">
            <!-- Will be populated by JavaScript -->
          </div>
          <p id="no-photos-preview" class="text-gray-500 text-xs sm:text-sm text-center py-3 sm:py-4 hidden">Chưa có ảnh</p>
        </div>
        
      </div>
      
      <!-- Right Content - Posts -->
      <div class="lg:col-span-7 xl:col-span-8 space-y-3 sm:space-y-4">
        
        <!-- Posts Section (default) -->
        <div id="posts-section">
          <!-- Create Post Card - Only show for own profile -->
          <div id="create-post-card" class="bg-white rounded-lg sm:rounded-xl shadow p-3 sm:p-4 mb-3 sm:mb-4" style="display: none;">
            <div class="flex gap-2.5 sm:gap-3 items-center mb-3">
              <div id="small-avatar" class="w-9 h-9 sm:w-10 sm:h-10 rounded-full bg-green-600 flex items-center justify-center text-white font-semibold flex-shrink-0 text-sm">
                <i class="fas fa-user"></i>
              </div>
              <button onclick="openCreatePostModal()" class="flex-1 px-3 sm:px-4 py-2.5 sm:py-3 bg-gray-100 hover:bg-gray-200 rounded-full text-gray-600 transition-colors text-left text-sm sm:text-base">
                Bạn đang nghĩ gì?
              </button>
            </div>
            <div class="flex gap-1.5 sm:gap-2 pt-2.5 sm:pt-3 border-t border-gray-200">
              <button onclick="openCreatePostModal('image')" class="flex-1 flex items-center justify-center gap-1.5 sm:gap-2 py-2 hover:bg-gray-100 rounded-lg transition-colors text-gray-600">
                <i class="fas fa-image text-green-600 text-sm sm:text-base"></i>
                <span class="font-medium text-xs sm:text-sm">Ảnh/Video</span>
              </button>
              <button onclick="openCreatePostModal()" class="flex-1 flex items-center justify-center gap-1.5 sm:gap-2 py-2 hover:bg-gray-100 rounded-lg transition-colors text-gray-600">
                <i class="fas fa-smile text-yellow-500 text-sm sm:text-base"></i>
                <span class="font-medium text-xs sm:text-sm">Cảm xúc</span>
              </button>
            </div>
          </div>
          
          <!-- Posts List -->
          <div id="user-posts-container">
            <div class="flex justify-center py-8">
              <div class="loading-spinner"></div>
            </div>
          </div>
        </div>
        
        <!-- Photos Section (hidden by default) -->
        <div id="photos-section" class="hidden">
          <div class="bg-white rounded-lg sm:rounded-xl shadow p-3 sm:p-4">
            <div class="flex items-center justify-between mb-3 sm:mb-4 gap-2">
              <h2 class="text-xl sm:text-2xl font-bold text-gray-900">Ảnh</h2>
              <button onclick="openUploadPhotoModal()" class="px-3 sm:px-4 py-2 bg-green-600 text-white rounded-lg hover:bg-green-700 transition-colors text-xs sm:text-sm whitespace-nowrap">
                <i class="fas fa-upload"></i> <span class="hidden sm:inline">Tải ảnh lên</span>
              </button>
            </div>
            <div id="photos-grid" class="grid grid-cols-2 sm:grid-cols-3 md:grid-cols-3 gap-2 sm:gap-3">
              <div class="col-span-full flex justify-center py-8">
                <div class="loading-spinner"></div>
              </div>
            </div>
          </div>
        </div>
        
        <!-- Friends Section (hidden by default) -->
        <div id="friends-section" class="hidden">
          <div class="bg-white rounded-lg sm:rounded-xl shadow p-3 sm:p-4">
            <div class="flex items-center justify-between mb-3 sm:mb-4 gap-2">
              <h2 class="text-xl sm:text-2xl font-bold text-gray-900">Bạn bè (<span class="friends-count">0</span>)</h2>
              <button class="px-3 sm:px-4 py-2 bg-gray-100 hover:bg-gray-200 rounded-lg transition-colors text-xs sm:text-sm">
                <i class="fas fa-search"></i> <span class="hidden sm:inline">Tìm kiếm</span>
              </button>
            </div>
            <div id="friends-grid" class="grid grid-cols-1 sm:grid-cols-2 md:grid-cols-3 lg:grid-cols-4 gap-2 sm:gap-3">
              <div class="col-span-full flex justify-center py-8">
                <div class="loading-spinner"></div>
              </div>
            </div>
          </div>
        </div>
        
        <!-- Intro Section (hidden by default) -->
        <div id="intro-section" class="hidden">
          <div class="bg-white rounded-lg sm:rounded-xl shadow p-3 sm:p-4">
            <h2 class="text-xl sm:text-2xl font-bold text-gray-900 mb-3 sm:mb-4">Giới thiệu</h2>
            
            <div class="space-y-3 sm:space-y-4">
              <div>
                <label class="block text-xs sm:text-sm font-medium text-gray-700 mb-2">Tiểu sử</label>
                <p id="bio-detail" class="text-gray-600 p-3 bg-gray-50 rounded-lg text-sm sm:text-base">Chưa có thông tin</p>
              </div>
              
              <div class="border-t border-gray-200 pt-3 sm:pt-4">
                <h3 class="font-semibold mb-2 sm:mb-3 text-sm sm:text-base">Thông tin liên hệ</h3>
                <div class="space-y-2.5 sm:space-y-3">
                  <div class="flex items-center gap-2.5 sm:gap-3">
                    <i class="fas fa-envelope w-5 sm:w-6 text-gray-400 text-sm"></i>
                    <span id="email-detail" class="text-gray-700 text-xs sm:text-sm truncate">-</span>
                  </div>
                  <div class="flex items-center gap-2.5 sm:gap-3">
                    <i class="fas fa-calendar-alt w-5 sm:w-6 text-gray-400 text-sm"></i>
                    <span class="text-xs sm:text-sm">Tham gia <span id="joined-detail">-</span></span>
                  </div>
                  <div class="flex items-center gap-2.5 sm:gap-3">
                    <i class="fas fa-clock w-5 sm:w-6 text-gray-400 text-sm"></i>
                    <span class="text-xs sm:text-sm">Hoạt động <span id="active-detail">-</span></span>
                  </div>
                </div>
              </div>
              
              <button onclick="openEditProfileModal()" class="w-full mt-4 px-4 py-2 bg-green-600 text-white rounded-lg hover:bg-green-700 transition-colors">
                <i class="fas fa-edit"></i> Chỉnh sửa giới thiệu
              </button>
            </div>
          </div>
        </div>
        
      </div>
      
    </div>
    
  </div>
  
  <!-- Avatar Options Modal -->
  <div id="avatar-options-modal" class="modal">
    <div class="bg-white rounded-2xl shadow-xl p-6 max-w-sm mx-4">
      <h3 class="text-lg font-bold text-gray-800 mb-4">Chọn ảnh đại diện</h3>
      <div class="space-y-3">
        <button onclick="selectFromGallery()" class="w-full flex items-center gap-3 px-4 py-3 border-2 border-gray-300 rounded-lg hover:border-green-600 hover:bg-green-50 transition-all">
          <i class="fas fa-image text-green-600 text-xl"></i>
          <span class="font-medium">Chọn từ thư viện</span>
        </button>
        <button id="camera-option" onclick="selectFromCamera()" class="w-full flex items-center gap-3 px-4 py-3 border-2 border-gray-300 rounded-lg hover:border-blue-600 hover:bg-blue-50 transition-all">
          <i class="fas fa-camera text-blue-600 text-xl"></i>
          <span class="font-medium">Chụp ảnh mới</span>
        </button>
        <button onclick="closeAvatarOptions()" class="w-full px-4 py-3 text-gray-600 hover:bg-gray-100 rounded-lg transition-all font-medium">
          Hủy
        </button>
      </div>
    </div>
  </div>
  
  <!-- Crop Image Modal -->
  <div id="crop-modal" class="modal">
    <div class="bg-white rounded-2xl shadow-xl p-6 max-w-2xl mx-4 w-full">
      <h3 class="text-lg font-bold text-gray-800 mb-4">Chỉnh sửa ảnh đại diện</h3>
      <div class="crop-container mb-4">
        <img id="crop-image" src="" alt="Crop" />
      </div>
      <div class="flex gap-3 justify-end">
        <button onclick="closeCropModal()" class="px-6 py-2.5 border border-gray-300 text-gray-700 rounded-lg hover:bg-gray-50 font-medium">
          Hủy
        </button>
        <button onclick="applyCrop()" class="px-6 py-2.5 bg-green-600 hover:bg-green-700 text-white rounded-lg font-medium">
          <i class="fas fa-check mr-2"></i>Áp dụng
        </button>
      </div>
    </div>
  </div>
  
  <!-- Hidden File Inputs -->
  <input type="file" id="avatar-upload" accept="image/*" class="hidden" />
  <input type="file" id="avatar-camera" accept="image/*" capture="environment" class="hidden" />
  
  <!-- Edit Profile Modal -->
  <div id="edit-profile-modal" class="modal">
    <div class="bg-white rounded-2xl shadow-xl p-6 max-w-md mx-4 w-full">
      <div class="flex items-center justify-between mb-4">
        <h3 class="text-xl font-bold text-gray-800 flex items-center">
          <i class="fas fa-user-edit text-green-600 mr-2"></i>
          Chỉnh sửa thông tin
        </h3>
        <button onclick="closeEditProfileModal()" class="text-gray-400 hover:text-gray-600">
          <i class="fas fa-times text-xl"></i>
        </button>
      </div>
      
      <form id="profile-form" class="space-y-4">
        <div>
          <label class="block text-sm font-semibold text-gray-700 mb-2">Họ và tên</label>
          <input 
            type="text" 
            id="name" 
            class="w-full px-4 py-2.5 border border-gray-300 rounded-lg focus:border-green-600"
            placeholder="Nhập tên của bạn"
          />
        </div>
        
        <div>
          <label class="block text-sm font-semibold text-gray-700 mb-2">Tiểu sử</label>
          <textarea 
            id="bio" 
            rows="3"
            class="w-full px-4 py-2.5 border border-gray-300 rounded-lg focus:border-green-600"
            placeholder="Giới thiệu về bạn..."
          ></textarea>
        </div>
        
        <button 
          type="submit" 
          class="w-full py-2.5 bg-green-600 hover:bg-green-700 text-white rounded-lg font-medium transition-colors"
        >
          Lưu thay đổi
        </button>
      </form>
    </div>
  </div>
  
  <!-- Change Password Modal -->
  <div id="change-password-modal" class="modal">
    <div class="bg-white rounded-2xl shadow-xl p-6 max-w-md mx-4 w-full">
      <div class="flex items-center justify-between mb-4">
        <h3 class="text-xl font-bold text-gray-800 flex items-center">
          <i class="fas fa-key text-blue-600 mr-2"></i>
          Đổi mật khẩu
        </h3>
        <button onclick="closeChangePasswordModal()" class="text-gray-400 hover:text-gray-600">
          <i class="fas fa-times text-xl"></i>
        </button>
      </div>
      
      <div id="password-alert" class="hidden mb-4 p-3 rounded text-sm"></div>
      
      <form id="password-form" class="space-y-4">
        <div>
          <label class="block text-sm font-semibold text-gray-700 mb-2">Mật khẩu hiện tại</label>
          <input 
            type="password" 
            id="old-password" 
            required 
            class="w-full px-4 py-2.5 border border-gray-300 rounded-lg focus:border-green-600"
            placeholder="Nhập mật khẩu hiện tại"
          />
        </div>
        
        <div>
          <label class="block text-sm font-semibold text-gray-700 mb-2">Mật khẩu mới</label>
          <input 
            type="password" 
            id="new-password" 
            required 
            minlength="6"
            class="w-full px-4 py-2.5 border border-gray-300 rounded-lg focus:border-green-600"
            placeholder="Tối thiểu 6 ký tự"
          />
        </div>
        
        <div>
          <label class="block text-sm font-semibold text-gray-700 mb-2">Xác nhận mật khẩu mới</label>
          <input 
            type="password" 
            id="confirm-new-password" 
            required 
            class="w-full px-4 py-2.5 border border-gray-300 rounded-lg focus:border-green-600"
            placeholder="Nhập lại mật khẩu mới"
          />
        </div>
        
        <button 
          type="submit" 
          class="w-full py-2.5 bg-blue-600 hover:bg-blue-700 text-white rounded-lg font-medium transition-colors"
        >
          Đổi mật khẩu
        </button>
      </form>
    </div>
  </div>
  
  <!-- Likes List Modal -->
  <div id="likes-modal" class="modal" onclick="if(event.target === this) closeLikesModal()">
    <div class="bg-white rounded-2xl shadow-2xl w-full max-w-md mx-4 max-h-[80vh] flex flex-col">
      <!-- Header -->
      <div class="flex items-center justify-between p-4 border-b border-gray-200">
        <h3 class="text-lg font-bold text-gray-900">Người đã thích</h3>
        <button onclick="closeLikesModal()" class="text-gray-400 hover:text-gray-600 p-1">
          <i class="fas fa-times text-xl"></i>
        </button>
      </div>
      
      <!-- Content -->
      <div id="likes-list-content" class="flex-1 overflow-y-auto p-4">
        <div class="flex justify-center py-8">
          <div class="loading-spinner"></div>
        </div>
      </div>
    </div>
  </div>

  <!-- Create Post Modal -->
  <div id="create-post-modal" class="modal" onclick="if(event.target === this) closeCreatePostModal()">
    <div class="bg-white rounded-xl sm:rounded-2xl shadow-xl max-w-2xl w-full mx-3 sm:mx-4 max-h-[90vh] overflow-y-auto">
      <!-- Modal Header -->
      <div class="flex items-center justify-between p-3 sm:p-4 border-b border-gray-200">
        <h2 class="text-lg sm:text-xl font-bold text-gray-800">Tạo bài viết</h2>
        <button onclick="closeCreatePostModal()" class="text-gray-400 hover:text-gray-600">
          <i class="fas fa-times text-lg sm:text-xl"></i>
        </button>
      </div>
      
      <!-- Modal Body -->
      <div class="p-3 sm:p-4">
        <!-- User Info -->
        <div class="flex items-center gap-2 sm:gap-3 mb-3 sm:mb-4">
          <div id="modal-user-avatar" class="w-9 h-9 sm:w-10 sm:h-10 rounded-full bg-green-600 flex items-center justify-center text-white font-semibold">
            <i class="fas fa-user text-sm sm:text-base"></i>
          </div>
          <div>
            <h3 id="modal-user-name" class="font-semibold text-gray-800 text-sm sm:text-base">Đang tải...</h3>
          </div>
        </div>
        
        <!-- Post Content (No Title) -->
        <div class="relative mb-3 sm:mb-4">
          <textarea 
            id="post-content" 
            rows="5" 
            placeholder="Chia sẻ suy nghĩ của bạn về nông nghiệp..."
            class="create-post-textarea w-full px-3 sm:px-4 py-2 sm:py-3 border border-gray-300 rounded-lg text-sm sm:text-base focus:outline-none focus:border-green-600 resize-none"
          ></textarea>
        </div>
        
        <!-- Poll Preview Container -->
        <div id="poll-preview-container"></div>
        
        <!-- Image Upload Preview -->
        <div id="image-preview-container" class="hidden mb-3 sm:mb-4">
          <div class="relative">
            <img id="image-preview" src="" alt="Preview" class="w-full rounded-lg max-h-48 sm:max-h-64 object-cover" />
            <button onclick="removePostImage()" class="absolute top-2 right-2 w-7 h-7 sm:w-8 sm:h-8 bg-white rounded-full shadow-lg flex items-center justify-center hover:bg-gray-100">
              <i class="fas fa-times text-gray-600 text-sm"></i>
            </button>
          </div>
        </div>
        
        <!-- Tags Input -->
        <div class="mb-3 sm:mb-4">
          <input 
            type="text" 
            id="post-tags" 
            placeholder="Thêm thẻ (cách nhau bằng dấu phẩy). VD: lúa, trồng trọt"
            class="w-full px-3 sm:px-4 py-2 border border-gray-300 rounded-lg focus:outline-none focus:border-green-600 text-xs sm:text-sm"
          />
        </div>
        
        <!-- Bottom Action Bar -->
        <div class="flex gap-2 sm:gap-3">
          <button onclick="selectPostImage()" class="flex-1 py-2.5 sm:py-3 text-green-600 hover:bg-green-50 rounded-lg transition-colors flex items-center justify-center gap-2 font-medium text-sm">
            <i class="fas fa-image"></i>
            <span class="hidden xs:inline">Ảnh</span>
          </button>
          <button onclick="closeCreatePostModal(); openPollModal()" class="flex-1 py-2.5 sm:py-3 text-blue-600 hover:bg-blue-50 rounded-lg transition-colors flex items-center justify-center gap-2 font-medium text-sm">
            <i class="fas fa-poll"></i>
            <span class="hidden xs:inline">Khảo sát</span>
          </button>
          <button onclick="openLocationPicker()" class="flex-1 py-2.5 sm:py-3 text-red-600 hover:bg-red-50 rounded-lg transition-colors flex items-center justify-center gap-2 font-medium text-sm">
            <i class="fas fa-map-marker-alt"></i>
            <span class="hidden xs:inline">Vị trí</span>
          </button>
          <button onclick="submitPost()" class="flex-1 py-2.5 sm:py-3 bg-green-600 hover:bg-green-700 text-white rounded-lg font-semibold transition-colors text-sm">
            Đăng
          </button>
        </div>
      </div>
    </div>
  </div>

  <!-- Hidden File Input -->
  <input type="file" id="post-image-input" accept="image/*" class="hidden" />
  
  <!-- Poll Modal -->
  <div id="poll-modal" class="modal hidden">
    <div class="flex items-center justify-center min-h-screen p-4">
      <div class="bg-white rounded-xl sm:rounded-2xl shadow-xl max-w-md w-full">
        <!-- Modal Header -->
        <div class="flex items-center justify-between p-3 sm:p-4 border-b border-gray-200">
          <h2 class="text-lg sm:text-xl font-bold text-gray-800">Thêm cuộc thăm dò ý kiến</h2>
          <button onclick="closePollModal()" class="text-gray-400 hover:text-gray-600">
            <i class="fas fa-times text-lg sm:text-xl"></i>
          </button>
        </div>
        
        <!-- Modal Body -->
        <div class="p-3 sm:p-4">
          <!-- Poll Options (Main) -->
          <div class="mb-4 sm:mb-5">
            <div id="poll-options-container" class="space-y-2.5">
              <div class="flex items-center gap-2">
                <input 
                  type="text" 
                  placeholder="Lựa chọn 1"
                  class="poll-option flex-1 px-3 sm:px-4 py-2.5 border border-gray-300 rounded-lg focus:outline-none focus:border-blue-600 text-sm sm:text-base"
                />
                <button onclick="removePollOption(this)" class="text-gray-400 hover:text-gray-600 p-1">
                  <i class="fas fa-times"></i>
                </button>
              </div>
              <div class="flex items-center gap-2">
                <input 
                  type="text" 
                  placeholder="Lựa chọn 2"
                  class="poll-option flex-1 px-3 sm:px-4 py-2.5 border border-gray-300 rounded-lg focus:outline-none focus:border-blue-600 text-sm sm:text-base"
                />
                <button onclick="removePollOption(this)" class="text-gray-400 hover:text-gray-600 p-1">
                  <i class="fas fa-times"></i>
                </button>
              </div>
            </div>
            <button onclick="addPollOption()" class="mt-3 w-full py-2.5 text-gray-700 hover:bg-gray-100 rounded-lg transition-colors text-sm font-medium flex items-center justify-center gap-2">
              <i class="fas fa-plus text-green-600"></i>
              <span>Thêm lựa chọn</span>
            </button>
          </div>
          
          <!-- Poll Settings (Bottom Right) -->
          <div class="flex items-center justify-between">
            <div class="text-xs sm:text-sm text-gray-500">
              Bạn không thể tạo cuộc thăm dò ý kiến không chứa ít nhất hai lựa chọn trong bài viết.
            </div>
            <button onclick="togglePollSettings()" class="ml-2 p-2 hover:bg-gray-100 rounded-lg transition-colors" title="Cài đặt">
              <i class="fas fa-cog text-gray-600 text-lg"></i>
            </button>
          </div>
          
          <!-- Poll Settings (Hidden by default) -->
          <div id="poll-settings" class="hidden mt-4 p-3 bg-gray-50 rounded-lg border border-gray-200">
            <label class="flex items-center gap-2 mb-2">
              <input type="checkbox" id="poll-multiple" class="w-4 h-4">
              <span class="text-xs sm:text-sm text-gray-700">Cho phép chọn nhiều tùy chọn</span>
            </label>
          </div>
          
          <!-- Action Buttons -->
          <div class="flex gap-2 mt-4 sm:mt-5">
            <button onclick="closePollModal()" class="flex-1 py-2.5 sm:py-3 bg-gray-200 hover:bg-gray-300 text-gray-800 rounded-lg font-semibold transition-colors text-sm sm:text-base">
              Hủy
            </button>
            <button onclick="addPollToPost()" class="flex-1 py-2.5 sm:py-3 bg-blue-600 hover:bg-blue-700 text-white rounded-lg font-semibold transition-colors text-sm sm:text-base">
              Thêm
            </button>
          </div>
        </div>
      </div>
    </div>
  </div>
  
  <!-- Location Modal -->
  <div id="location-modal" class="modal hidden">
    <div class="flex items-center justify-center min-h-screen p-4">
      <div class="bg-white rounded-xl sm:rounded-2xl shadow-xl max-w-md w-full">
        <!-- Modal Header -->
        <div class="flex items-center justify-between p-3 sm:p-4 border-b border-gray-200">
          <h2 class="text-lg sm:text-xl font-bold text-gray-800">Thêm vị trí</h2>
          <button onclick="closeLocationModal()" class="text-gray-400 hover:text-gray-600">
            <i class="fas fa-times text-lg sm:text-xl"></i>
          </button>
        </div>
        
        <!-- Modal Body -->
        <div class="p-3 sm:p-4">
          <!-- Location Search -->
          <div class="mb-3 sm:mb-4">
            <input 
              type="text" 
              id="location-search" 
              placeholder="Tìm vị trí..."
              class="w-full px-3 sm:px-4 py-2 border border-gray-300 rounded-lg focus:outline-none focus:border-red-600 text-sm sm:text-base"
            />
          </div>
          
          <!-- Current Location -->
          <button onclick="useCurrentLocation()" class="w-full mb-3 sm:mb-4 py-2 sm:py-3 bg-gray-100 hover:bg-gray-200 text-gray-700 rounded-lg transition-colors text-sm sm:text-base">
            <i class="fas fa-crosshairs mr-2"></i>Sử dụng vị trí hiện tại
          </button>
          
          <!-- Location List -->
          <div id="location-list" class="space-y-2 max-h-60 overflow-y-auto mb-3 sm:mb-4">
            <p class="text-center text-gray-500 text-xs sm:text-sm">Nhập địa chỉ để tìm kiếm</p>
          </div>
          
          <!-- Action Buttons -->
          <div class="flex gap-2">
            <button onclick="closeLocationModal()" class="flex-1 py-2 sm:py-3 bg-gray-200 hover:bg-gray-300 text-gray-800 rounded-lg font-semibold transition-colors text-sm sm:text-base">
              Hủy
            </button>
            <button id="location-confirm-btn" onclick="addLocationToPost()" class="flex-1 py-2 sm:py-3 bg-red-600 hover:bg-red-700 text-white rounded-lg font-semibold transition-colors text-sm sm:text-base" disabled>
              Xác nhận
            </button>
          </div>
        </div>
      </div>
    </div>
  </div>
  
  <script>
    let cropper = null;
    let currentUserId = null;
    let profileUserId = null;
    let profileUserSlug = null;  // Store username slug
    let isOwnProfile = false;
    let currentFriendRequestId = null;
    let pollData = null;
    let selectedLocation = null;
    let selectedImage = null;
    let mentionedUsers = [];
    let hashtags = [];
    
    // Get user identifier from URL (username slug or ID)
    function getProfileIdentifier() {
      const urlParams = new URLSearchParams(window.location.search);
      const userIdParam = urlParams.get('user_id');
      
      // Check if URL is /profile/username.123456 or /profile/123 format
      const pathMatch = window.location.pathname.match(/\/profile\/(.+)/);
      
      return userIdParam || (pathMatch ? pathMatch[1] : null);
    }
    
    // Show alert message
    function showAlert(message, type = 'error', elementId = 'alert-message') {
      const alertDiv = document.getElementById(elementId);
      alertDiv.className = `mb-4 p-3 rounded-lg text-sm ${
        type === 'error' ? 'bg-red-50 text-red-700 border border-red-200' : 
        type === 'success' ? 'bg-green-50 text-green-700 border border-green-200' :
        'bg-blue-50 text-blue-700 border border-blue-200'
      }`;
      alertDiv.textContent = message;
      alertDiv.classList.remove('hidden');
      
      if (type === 'success') {
        setTimeout(() => {
          alertDiv.classList.add('hidden');
        }, 3000);
      }
    }
    
    // Toggle settings menu
    function toggleSettingsMenu() {
      const menu = document.getElementById('settings-menu');
      menu.classList.toggle('hidden');
    }
    
    // Close menu when clicking outside
    document.addEventListener('click', function(e) {
      const menu = document.getElementById('settings-menu');
      const settingsBtn = e.target.closest('button[onclick="toggleSettingsMenu()"]');
      
      if (!menu.contains(e.target) && e.target !== settingsBtn && !settingsBtn?.contains(e.target)) {
        menu.classList.add('hidden');
      }
    });
    
    // Open edit profile modal
    function openEditProfileModal() {
      document.getElementById('settings-menu').classList.add('hidden');
      document.getElementById('edit-profile-modal').classList.add('active');
    }
    
    function closeEditProfileModal() {
      document.getElementById('edit-profile-modal').classList.remove('active');
    }
    
    // Open change password modal
    function openChangePasswordModal() {
      document.getElementById('settings-menu').classList.add('hidden');
      document.getElementById('change-password-modal').classList.add('active');
    }
    
    function closeChangePasswordModal() {
      document.getElementById('change-password-modal').classList.remove('active');
      document.getElementById('password-form').reset();
      document.getElementById('password-alert').classList.add('hidden');
    }
    
    // Toggle privacy (placeholder)
    function togglePrivacy() {
      alert('Chức năng quyền riêng tư đang được phát triển');
      document.getElementById('settings-menu').classList.add('hidden');
    }
    
    // Upload photo modal placeholder
    function openUploadPhotoModal() {
      alert('Tính năng tải ảnh lên đang được phát triển. Hiện tại bạn có thể thêm ảnh từ URL trong forum.');
      window.location.href = '/forum';
    }
    
    // Logout
    function logout() {
      if (confirm('Bạn có chắc muốn đăng xuất?')) {
        window.location.href = '/logout';
      }
    }
    
    // Load user profile
    async function loadProfile() {
      try {
        // Get current user (logged in user)
        const currentUserResponse = await fetch('/api/auth/profile');
        const currentUserData = await currentUserResponse.json();
        
        if (!currentUserData.success || !currentUserData.user) {
          window.location.href = '/login';
          return;
        }
        
        currentUserId = currentUserData.user.id;
        const currentUserSlug = currentUserData.user.username_slug;
        
        // Get profile identifier from URL or use current user's slug
        const identifier = getProfileIdentifier() || currentUserSlug || currentUserId;
        
        // Fetch profile data
        const profileResponse = await fetch(`/api/profile/user/${identifier}`);
        const profileData = await profileResponse.json();
        
        if (!profileData.success) {
          showAlert('Không tìm thấy người dùng', 'error');
          return;
        }
        
        const user = profileData.user;
        profileUserId = user.id;
        profileUserSlug = user.username_slug;
        isOwnProfile = profileData.is_own_profile;
        
        console.log('Profile loaded:', {
          currentUserId,
          profileUserId,
          isOwnProfile: profileData.is_own_profile
        });
        
        // Update URL to use username slug (for sharing)
        const currentPath = window.location.pathname;
        const expectedPath = `/profile/${profileUserSlug || profileUserId}`;
        if (currentPath !== expectedPath) {
          window.history.replaceState(null, '', expectedPath);
        }
        
        // Update UI based on ownership
        updateProfileUI(user, profileData);
        
        // Load posts
        loadUserPosts(profileUserId);
        
      } catch (error) {
        console.error('Error loading profile:', error);
        window.location.href = '/login';
      }
    }
    
    function updateProfileUI(user, profileData) {
      const userName = user.name || user.email.split('@')[0];
      
      // Store profile slug for later use
      profileUserSlug = user.username_slug;
      
      // Update name and email
      document.getElementById('profile-name').textContent = userName;
      document.getElementById('profile-email').textContent = user.email;
      document.getElementById('profile-email-sidebar').textContent = user.email;
      
      // Update stats
      document.getElementById('posts-count').textContent = user.posts_count || 0;
      document.querySelectorAll('.friends-count').forEach(el => {
        el.textContent = user.friends_count || 0;
      });
      document.getElementById('photos-count').textContent = user.photos_count || 0;
      
      // Update dates
      document.getElementById('created-at').textContent = user.created_at ? new Date(user.created_at).toLocaleDateString('vi-VN') : '-';
      document.getElementById('last-login').textContent = user.last_login ? new Date(user.last_login).toLocaleDateString('vi-VN') : '-';
      
      // Update intro section
      if (document.getElementById('bio-detail')) {
        document.getElementById('bio-detail').textContent = user.bio || 'Chưa có thông tin';
      }
      if (document.getElementById('email-detail')) {
        document.getElementById('email-detail').textContent = user.email;
      }
      if (document.getElementById('joined-detail')) {
        document.getElementById('joined-detail').textContent = user.created_at ? new Date(user.created_at).toLocaleDateString('vi-VN') : '-';
      }
      if (document.getElementById('active-detail')) {
        document.getElementById('active-detail').textContent = user.last_login ? new Date(user.last_login).toLocaleDateString('vi-VN') : '-';
      }
      
      // Update avatar
      if (user.avatar_url) {
        document.getElementById('profile-avatar').src = user.avatar_url;
        document.getElementById('profile-avatar').style.display = 'block';
        document.getElementById('avatar-placeholder').style.display = 'none';
      } else {
        const firstLetter = userName.charAt(0).toUpperCase();
        document.getElementById('avatar-placeholder').textContent = firstLetter;
        document.getElementById('profile-avatar').style.display = 'none';
        document.getElementById('avatar-placeholder').style.display = 'flex';
      }
      
      // Update small avatar
      const smallAvatar = document.getElementById('small-avatar');
      if (user.avatar_url) {
        smallAvatar.innerHTML = `<img src="${user.avatar_url}" class="w-full h-full rounded-full object-cover" />`;
      } else {
        const firstLetter = userName.charAt(0).toUpperCase();
        smallAvatar.innerHTML = firstLetter;
        smallAvatar.classList.add('bg-green-600', 'text-white', 'flex', 'items-center', 'justify-center', 'font-bold');
      }
      
      // Show/hide UI elements based on ownership
      console.log('Updating UI - isOwnProfile:', isOwnProfile);
      
      if (isOwnProfile) {
        // Owner view
        console.log('Showing owner view');
        document.getElementById('owner-actions').style.display = 'block';
        document.getElementById('visitor-actions').style.display = 'none';
        document.getElementById('avatar-edit-btn').style.display = 'flex';
        document.getElementById('name').value = user.name || '';
        document.getElementById('create-post-card').style.display = 'block';
        
        // Enable edit buttons in sidebar
        const editButtons = document.querySelectorAll('button[onclick="openEditProfileModal()"]');
        editButtons.forEach(btn => btn.style.display = 'block');
        
      } else {
        // Visitor view
        console.log('Showing visitor view');
        document.getElementById('owner-actions').style.display = 'none';
        document.getElementById('visitor-actions').style.display = 'flex';
        document.getElementById('avatar-edit-btn').style.display = 'none';
        document.getElementById('create-post-card').style.display = 'none';
        
        // Hide edit buttons
        const editButtons = document.querySelectorAll('button[onclick="openEditProfileModal()"]');
        editButtons.forEach(btn => btn.style.display = 'none');
        
        // Update friend buttons based on status
        updateFriendButtons(profileData);
      }
      
      // Update page title
      document.title = `${userName} - AgriSense AI`;
      
      // Update bio in sidebar
      const userBio = document.getElementById('user-bio');
      if (userBio) {
        userBio.textContent = user.bio || 'Chưa có giới thiệu';
      }
      
      // Update online status indicator
      updateOnlineStatus(user.last_login);
      
      // Refresh online status every 30 seconds for visitor profiles
      if (!isOwnProfile) {
        setInterval(async () => {
          try {
            const response = await fetch(`/api/profile/user/${profileUserId}`);
            const data = await response.json();
            if (data.success) {
              updateOnlineStatus(data.user.last_login);
            }
          } catch (error) {
            console.error('Error refreshing online status:', error);
          }
        }, 30000); // 30 seconds
      }
      
      // Load friends and photos preview
      loadFriendsPreview();
      loadPhotosPreview();
    }
    
    function updateOnlineStatus(lastLogin) {
      const indicator = document.getElementById('online-indicator');
      if (!indicator) return;
      
      // If viewing own profile, always show green (current user is definitely online)
      if (isOwnProfile) {
        indicator.style.backgroundColor = '#10B981'; // Green
        indicator.title = 'Đang hoạt động';
        return;
      }
      
      const now = new Date();
      const lastLoginDate = new Date(lastLogin);
      const minutesAgo = Math.floor((now - lastLoginDate) / 60000);
      
      // If online within last 5 minutes, show green, otherwise gray
      if (minutesAgo < 5) {
        indicator.style.backgroundColor = '#10B981'; // Green
        indicator.title = 'Đang hoạt động';
      } else {
        indicator.style.backgroundColor = '#6B7280'; // Gray
        indicator.title = 'Ngoại tuyến';
      }
    }
    
    function updateFriendButtons(profileData) {
      const addFriendBtn = document.getElementById('add-friend-btn');
      const requestSentBtn = document.getElementById('request-sent-btn');
      const requestReceivedBtns = document.getElementById('request-received-btns');
      const friendsBtn = document.getElementById('friends-btn');
      
      // Hide all buttons first
      addFriendBtn.classList.add('hidden');
      requestSentBtn.classList.add('hidden');
      requestReceivedBtns.classList.add('hidden');
      friendsBtn.classList.add('hidden');
      
      currentFriendRequestId = profileData.friend_request_id;
      
      if (profileData.is_friend) {
        // Already friends
        friendsBtn.classList.remove('hidden');
      } else if (profileData.friendship_status === 'pending_sent') {
        // Current user sent request
        requestSentBtn.classList.remove('hidden');
      } else if (profileData.friendship_status === 'pending_received') {
        // Profile user sent request to current user
        requestReceivedBtns.classList.remove('hidden');
      } else {
        // No friendship
        addFriendBtn.classList.remove('hidden');
      }
    }
    
    // Friend request functions
    async function sendFriendRequest() {
      try {
        const response = await fetch('/api/profile/friends/add', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ friend_id: profileUserId })
        });
        
        const data = await response.json();
        
        if (data.success) {
          showAlert('Đã gửi lời mời kết bạn', 'success');
          loadProfile(); // Reload to update buttons
        } else {
          showAlert(data.message || 'Không thể gửi lời mời', 'error');
        }
      } catch (error) {
        console.error('Error sending friend request:', error);
        showAlert('Lỗi kết nối', 'error');
      }
    }
    
    async function cancelFriendRequest() {
      if (!confirm('Hủy lời mời kết bạn?')) return;
      
      try {
        const response = await fetch(`/api/profile/friends/reject/${currentFriendRequestId}`, {
          method: 'POST'
        });
        
        const data = await response.json();
        
        if (data.success) {
          showAlert('Đã hủy lời mời', 'success');
          loadProfile();
        }
      } catch (error) {
        console.error('Error canceling request:', error);
      }
    }
    
    async function acceptFriendRequest() {
      try {
        const response = await fetch(`/api/profile/friends/accept/${currentFriendRequestId}`, {
          method: 'POST'
        });
        
        const data = await response.json();
        
        if (data.success) {
          showAlert('Đã chấp nhận lời mời kết bạn', 'success');
          loadProfile();
          loadNotifications(); // Refresh notifications
        }
      } catch (error) {
        console.error('Error accepting request:', error);
      }
    }
    
    async function rejectFriendRequest() {
      if (!confirm('Từ chối lời mời kết bạn?')) return;
      
      try {
        const response = await fetch(`/api/profile/friends/reject/${currentFriendRequestId}`, {
          method: 'POST'
        });
        
        const data = await response.json();
        
        if (data.success) {
          showAlert('Đã từ chối lời mời', 'success');
          loadProfile();
          loadNotifications();
        }
      } catch (error) {
        console.error('Error rejecting request:', error);
      }
    }
    
    async function removeFriend() {
      if (!confirm('Hủy kết bạn với người này?')) return;
      
      try {
        const response = await fetch(`/api/profile/friends/remove/${profileUserId}`, {
          method: 'POST'
        });
        
        const data = await response.json();
        
        if (data.success) {
          showAlert('Đã hủy kết bạn', 'success');
          loadProfile();
        }
      } catch (error) {
        console.error('Error removing friend:', error);
      }
    }
    
    // Notifications
    async function loadNotifications() {
      try {
        const response = await fetch('/api/profile/notifications');
        const data = await response.json();
        
        if (data.success) {
          displayNotifications(data.notifications);
          
          const badge = document.getElementById('notification-badge');
          if (data.unread_count > 0) {
            badge.textContent = data.unread_count;
            badge.classList.remove('hidden');
          } else {
            badge.classList.add('hidden');
          }
        }
      } catch (error) {
        console.error('Error loading notifications:', error);
      }
    }
    
    function displayNotifications(notifications) {
      const container = document.getElementById('notifications-list');
      
      if (notifications.length === 0) {
        container.innerHTML = '<p class="text-gray-500 text-center py-8 text-sm">Không có thông báo mới</p>';
        return;
      }
      
      container.innerHTML = notifications.map(notif => {
        const avatar = notif.user.avatar_url || `https://ui-avatars.com/api/?name=${encodeURIComponent(notif.user.name)}&background=16a34a&color=fff&size=40`;
        const timeAgo = getTimeAgo(notif.created_at); // Don't wrap in new Date()
        
        return `
          <div class="p-4 hover:bg-gray-50 border-b border-gray-100 cursor-pointer" onclick="viewUserProfile(${notif.user.id})">
            <div class="flex gap-3">
              <img src="${avatar}" alt="${notif.user.name}" class="w-10 h-10 rounded-full flex-shrink-0">
              <div class="flex-1 min-w-0">
                <p class="text-sm">
                  <span class="font-semibold">${notif.user.name}</span>
                  <span class="text-gray-600"> đã gửi lời mời kết bạn</span>
                </p>
                <p class="text-xs text-gray-500 mt-1">${timeAgo}</p>
                <div class="flex gap-2 mt-2">
                  <button onclick="event.stopPropagation(); acceptFriendRequestFromNotif(${notif.id})" class="px-3 py-1 bg-green-600 text-white text-xs rounded hover:bg-green-700">
                    Chấp nhận
                  </button>
                  <button onclick="event.stopPropagation(); rejectFriendRequestFromNotif(${notif.id})" class="px-3 py-1 bg-gray-200 text-gray-700 text-xs rounded hover:bg-gray-300">
                    Từ chối
                  </button>
                </div>
              </div>
            </div>
          </div>
        `;
      }).join('');
    }
    
    function toggleNotifications() {
      const dropdown = document.getElementById('notifications-dropdown');
      dropdown.classList.toggle('hidden');
      
      if (!dropdown.classList.contains('hidden')) {
        loadNotifications();
      }
    }
    
    function viewUserProfile(userId) {
      window.location.href = `/profile/${userId}`;
    }
    
    async function acceptFriendRequestFromNotif(requestId) {
      try {
        const response = await fetch(`/api/profile/friends/accept/${requestId}`, {
          method: 'POST'
        });
        
        const data = await response.json();
        
        if (data.success) {
          loadNotifications();
          showAlert('Đã chấp nhận lời mời kết bạn', 'success');
        }
      } catch (error) {
        console.error('Error accepting request:', error);
      }
    }
    
    async function rejectFriendRequestFromNotif(requestId) {
      try {
        const response = await fetch(`/api/profile/friends/reject/${requestId}`, {
          method: 'POST'
        });
        
        const data = await response.json();
        
        if (data.success) {
          loadNotifications();
        }
      } catch (error) {
        console.error('Error rejecting request:', error);
      }
    }
    
    function markAllAsRead() {
      // Placeholder - implement if you add read/unread status to notifications
      document.getElementById('notification-badge').classList.add('hidden');
      document.getElementById('notifications-dropdown').classList.add('hidden');
    }
    
    // Close notifications when clicking outside
    document.addEventListener('click', function(e) {
      const dropdown = document.getElementById('notifications-dropdown');
      const notifBtn = e.target.closest('button[onclick="toggleNotifications()"]');
      
      if (!dropdown.contains(e.target) && !notifBtn) {
        dropdown.classList.add('hidden');
      }
    });
    
    // Load user posts
    async function loadUserPosts(userId) {
      try {
        const response = await fetch('/api/forum/posts');
        const data = await response.json();
        
        if (data.success) {
          const userPosts = data.posts.filter(post => post.user_id === userId);
          document.getElementById('posts-count').textContent = userPosts.length;
          
          const container = document.getElementById('user-posts-container');
          
          if (userPosts.length === 0) {
            let emptyContent = `
              <div class="bg-white rounded-xl shadow p-8 text-center">
                <i class="fas fa-inbox text-gray-300 text-5xl mb-4"></i>
                <p class="text-gray-500 text-lg mb-2">Chưa có bài viết nào</p>`;
            
            // Only show create post button if it's own profile
            if (isOwnProfile) {
              emptyContent += `
                <button onclick="openCreatePostModal()" class="inline-block mt-3 px-6 py-2 bg-green-600 hover:bg-green-700 text-white rounded-lg font-medium transition-colors">
                  Tạo bài viết đầu tiên
                </button>`;
            }
            
            emptyContent += `</div>`;
            container.innerHTML = emptyContent;
          } else {
            container.innerHTML = userPosts.map(post => createPostCard(post)).join('');
          }
        }
      } catch (error) {
        console.error('Error loading user posts:', error);
      }
    }
    
    // Create post card
    function createPostCard(post) {
      const userName = post.user_name || post.user_email?.split('@')[0] || 'Người dùng';
      const userAvatar = post.user_avatar 
        ? `<img src="${post.user_avatar}" class="w-full h-full rounded-full object-cover" />`
        : `<div class="w-10 h-10 rounded-full bg-gradient-to-br from-green-400 to-green-600 flex items-center justify-center text-white font-semibold">${userName.charAt(0).toUpperCase()}</div>`;
      
      const imageHTML = post.image_url 
        ? `<img src="${post.image_url}" alt="Post image" class="w-full rounded-lg object-cover max-h-96 mb-3 cursor-pointer" />`
        : '';
      
      const tagsHTML = post.tags && post.tags.length > 0
        ? `<div class="flex gap-2 mb-3 flex-wrap">
            ${post.tags.map(tag => `<a href="javascript:searchByTag('${tag}')" class="px-3 py-1 bg-green-100 text-green-700 text-xs rounded-full hover:bg-green-200 transition-colors cursor-pointer font-semibold">#${tag}</a>`).join('')}
           </div>`
        : '';
      
      const titleHTML = post.title 
        ? `<h3 class="text-lg font-semibold text-gray-800 mb-2">${escapeHtml(post.title)}</h3>`
        : '';
      
      // Poll HTML
      const pollHTML = post.poll && post.poll.options && post.poll.options.length > 0
        ? `<div class="bg-blue-50 rounded-lg p-3 sm:p-4 mb-3 border border-blue-200">
            <p class="text-sm font-semibold text-blue-700 mb-3">📊 ${escapeHtml(post.poll.question || 'Khảo sát')} (Tổng: ${post.total_poll_votes || 0} phiếu)</p>
            <div class="space-y-2">
              ${post.poll.options.map((option, idx) => {
                const voteData = post.poll_vote_counts[idx] || {count: 0, percentage: 0};
                const isUserVoted = post.user_voted && post.user_voted_option === idx;
                return `
                <div class="flex items-center gap-2">
                  <input type="radio" name="poll_${post.id}" value="${idx}" id="poll_${post.id}_${idx}" class="cursor-pointer" ${post.user_voted ? 'disabled' : ''} ${isUserVoted ? 'checked' : ''} />
                  <label for="poll_${post.id}_${idx}" class="flex-1 py-2 px-3 bg-white rounded border ${isUserVoted ? 'border-green-500 bg-green-50' : 'border-blue-200'} text-sm text-gray-700 cursor-pointer hover:bg-blue-50 transition-colors">
                    <div class="flex items-center justify-between">
                      <span>${escapeHtml(option)} ${isUserVoted ? '✓' : ''}</span>
                      <span class="text-xs font-semibold text-gray-600">${voteData.percentage}% (${voteData.count})</span>
                    </div>
                    <div class="mt-1 w-full bg-gray-200 rounded-full h-1.5">
                      <div class="bg-blue-500 h-1.5 rounded-full transition-all" style="width: ${voteData.percentage}%"></div>
                    </div>
                  </label>
                </div>
              `;
              }).join('')}
            </div>
            <button onclick="submitPollVote(${post.id})" class="mt-3 px-4 py-2 ${post.user_voted ? 'bg-gray-400 cursor-not-allowed' : 'bg-blue-600 hover:bg-blue-700'} text-white rounded-lg transition-colors text-sm font-medium w-full" ${post.user_voted ? 'disabled' : ''}>
              ${post.user_voted ? '✓ Đã bầu chọn' : 'Gửi phiếu bầu'}
            </button>
          </div>`
        : '';
      
      return `
        <div class="bg-white rounded-xl shadow-sm hover:shadow-md transition-shadow post-card mb-4">
          <!-- Post Header -->
          <div class="p-4 flex items-center justify-between">
            <div class="flex items-center gap-3">
              <a href="/profile/${post.user_id}" class="hover:opacity-80 transition-opacity flex-shrink-0">
                ${userAvatar}
              </a>
              <div class="min-w-0 flex-1">
                <a href="/profile/${post.user_id}" class="hover:underline">
                  <h4 class="font-semibold text-gray-900 truncate">${escapeHtml(userName)}</h4>
                </a>
                <p class="text-sm text-gray-500 flex items-center gap-1.5">
                  <i class="far fa-clock"></i>
                  <span>${getTimeAgo(post.created_at)}</span>
                </p>
              </div>
            </div>
            ${isOwnProfile ? `
              <button onclick="deletePost(${post.id})" class="text-gray-400 hover:text-red-600 transition-colors p-2 flex-shrink-0">
                <i class="fas fa-trash"></i>
              </button>
            ` : ''}
          </div>
          
          <!-- Post Content -->
          <div class="px-4 pb-3">
            ${titleHTML}
            <p class="text-gray-800 whitespace-pre-wrap leading-relaxed">${processContent(post.content)}</p>
          </div>
          
          ${imageHTML ? `<div class="px-0 mb-3">${imageHTML}</div>` : ''}
          ${pollHTML}
          ${tagsHTML ? `<div class="px-4 pb-3">${tagsHTML}</div>` : ''}
          
          <!-- Post Stats - Clickable -->
          <div class="px-4 py-3 border-t border-gray-100">
            <div class="flex items-center justify-between text-sm">
              <button 
                onclick="showLikesList(${post.id})" 
                class="flex items-center gap-1.5 text-gray-600 hover:text-green-600 hover:underline transition-colors"
              >
                ${post.likes_count > 0 ? `
                  <span class="flex items-center gap-1">
                    <i class="fas fa-thumbs-up text-green-600"></i>
                    <span class="font-medium text-gray-700">${post.likes_count}</span>
                  </span>
                ` : '<span class="text-gray-500">Chưa có lượt thích</span>'}
              </button>
              <button 
                onclick="toggleComments(${post.id})" 
                class="text-gray-600 hover:text-blue-600 hover:underline transition-colors"
              >
                ${post.comments_count > 0 
                  ? `<span class="font-medium">${post.comments_count}</span> bình luận` 
                  : 'Chưa có bình luận'}
              </button>
            </div>
          </div>
          
          <!-- Post Actions -->
          <div class="px-2 pb-2 flex gap-1 border-t border-gray-100 pt-1">
            <a href="/forum" class="flex-1 flex items-center justify-center gap-2 py-2.5 hover:bg-gray-50 rounded-lg transition-colors text-gray-600 font-medium">
              <i class="far fa-thumbs-up text-lg"></i>
              <span class="text-sm">Thích</span>
            </a>
            <a href="/forum" class="flex-1 flex items-center justify-center gap-2 py-2.5 hover:bg-gray-50 rounded-lg transition-colors text-gray-600 font-medium">
              <i class="far fa-comment text-lg"></i>
              <span class="text-sm">Bình luận</span>
            </a>
            <a href="/forum" class="flex-1 flex items-center justify-center gap-2 py-2.5 hover:bg-gray-50 rounded-lg transition-colors text-gray-600 font-medium">
              <i class="far fa-share-square text-lg"></i>
              <span class="text-sm">Chia sẻ</span>
            </a>
          </div>
          
          <!-- Comments Section (Hidden by default) -->
          <div id="comments-${post.id}" class="hidden border-t border-gray-100 bg-gray-50">
            <div class="p-4">
              <div class="flex items-start gap-3 mb-3">
                <div class="w-8 h-8 rounded-full bg-green-600 flex items-center justify-center text-white font-semibold text-sm flex-shrink-0">
                  ${currentUserId ? 'U' : '?'}
                </div>
                <div class="flex-1">
                  <textarea 
                    placeholder="Viết bình luận..." 
                    class="w-full px-3 py-2 border border-gray-300 rounded-lg resize-none focus:ring-2 focus:ring-green-500 focus:border-transparent text-sm"
                    rows="2"
                  ></textarea>
                  <button class="mt-2 px-4 py-1.5 bg-green-600 text-white rounded-lg hover:bg-green-700 transition-colors text-sm font-medium">
                    Gửi
                  </button>
                </div>
              </div>
              <div id="comments-list-${post.id}" class="space-y-3">
                <p class="text-center text-gray-500 text-sm py-4">Đang tải bình luận...</p>
              </div>
            </div>
          </div>
        </div>
      `;
    }
    
    // Escape HTML
    function escapeHtml(text) {
      const div = document.createElement('div');
      div.textContent = text;
      return div.innerHTML;
    }

    // Process content with hashtag and mention highlights
    function processContent(text) {
      let processed = escapeHtml(text);
      
      // Highlight hashtags - clickable links to search
      processed = processed.replace(/#(\w+)/g, (match, tag) => {
        return `<a href="javascript:searchByTag('${tag}')" class="text-green-600 hover:underline font-semibold cursor-pointer">${match}</a>`;
      });
      
      // Highlight @mentions - clickable links to user profile
      processed = processed.replace(/@([\w\s]+?)(?=\s|$|[,.!?])/g, (match, user) => {
        return `<a href="javascript:goToUserProfile('${user.trim()}')" class="text-blue-600 hover:underline font-semibold cursor-pointer">${match}</a>`;
      });
      
      return processed;
    }

    // Navigate to user profile by name
    function goToUserProfile(userName) {
      fetch(`/api/users/search?name=${encodeURIComponent(userName)}`)
        .then(response => response.json())
        .then(data => {
          if (data.success && data.users && data.users.length > 0) {
            window.location.href = `/profile/${data.users[0].id}`;
          } else {
            alert('Không tìm thấy người dùng: ' + userName);
          }
        })
        .catch(error => {
          console.error('Error:', error);
          alert('Lỗi tìm kiếm người dùng');
        });
    }

    // Search posts by tag
    function searchByTag(tag) {
      // Navigate to forum with tag filter
      window.location.href = `/forum?tag=${encodeURIComponent(tag)}`;
    }
    
    // Get time ago
    function getTimeAgo(dateString) {
      // Parse the date string - if it doesn't have timezone info, treat as UTC
      let date;
      if (dateString instanceof Date) {
        date = dateString;
      } else {
        // SQLite returns UTC time without 'Z', so we need to add it
        const dateStr = dateString.includes('Z') || dateString.includes('+') 
          ? dateString 
          : dateString + 'Z';
        date = new Date(dateStr);
      }
      
      const now = new Date();
      const seconds = Math.floor((now - date) / 1000);
      
      if (seconds < 60) return 'Vừa xong';
      const minutes = Math.floor(seconds / 60);
      if (minutes < 60) return `${minutes} phút trước`;
      const hours = Math.floor(minutes / 60);
      if (hours < 24) return `${hours} giờ trước`;
      const days = Math.floor(hours / 24);
      if (days < 30) return `${days} ngày trước`;
      const months = Math.floor(days / 30);
      if (months < 12) return `${months} tháng trước`;
      const years = Math.floor(months / 12);
      return `${years} năm trước`;
    }
    
    // Delete post
    async function deletePost(postId) {
      if (!confirm('Bạn có chắc muốn xóa bài viết này?')) return;
      
      try {
        const response = await fetch(`/api/forum/posts/${postId}`, {
          method: 'DELETE'
        });
        
        const data = await response.json();
        
        if (data.success) {
          showAlert('Đã xóa bài viết', 'success');
          loadUserPosts(currentUserId);
        }
      } catch (error) {
        console.error('Error deleting post:', error);
      }
    }
    
    // Submit poll vote
    async function submitPollVote(postId) {
      const selectedOption = document.querySelector(`input[name="poll_${postId}"]:checked`);
      
      if (!selectedOption) {
        alert('Vui lòng chọn một lựa chọn');
        return;
      }
      
      const optionIndex = parseInt(selectedOption.value);
      
      try {
        const response = await fetch(`/api/forum/posts/${postId}/poll/vote`, {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ option_index: optionIndex })
        });
        
        const data = await response.json();
        
        if (data.success) {
          // Reload posts to show updated poll results
          loadUserPosts(currentUserId);
          showAlert('Phiếu bầu của bạn đã được ghi nhận!', 'success');
        } else {
          showAlert(data.message || 'Lỗi khi gửi phiếu bầu', 'error');
        }
      } catch (error) {
        console.error('Error submitting poll vote:', error);
        showAlert('Có lỗi xảy ra. Vui lòng thử lại.', 'error');
      }
    }
    
    // Show avatar options modal
    function showAvatarOptions() {
      document.getElementById('avatar-options-modal').classList.add('active');
    }
    
    function closeAvatarOptions() {
      document.getElementById('avatar-options-modal').classList.remove('active');
    }
    
    function selectFromGallery() {
      closeAvatarOptions();
      document.getElementById('avatar-upload').click();
    }
    
    function selectFromCamera() {
      closeAvatarOptions();
      document.getElementById('avatar-camera').click();
    }
    
    // Handle file selection and show crop modal
    function handleFileSelect(event) {
      const file = event.target.files[0];
      if (!file) return;
      
      // Reset input
      event.target.value = '';
      
      // Check file size (max 5MB)
      if (file.size > 5 * 1024 * 1024) {
        showAlert('Kích thước ảnh không được vượt quá 5MB', 'error');
        return;
      }
      
      // Check file type
      if (!file.type.startsWith('image/')) {
        showAlert('Vui lòng chọn file ảnh', 'error');
        return;
      }
      
      // Show crop modal with image
      const reader = new FileReader();
      reader.onload = function(e) {
        const cropImage = document.getElementById('crop-image');
        cropImage.src = e.target.result;
        
        // Destroy old cropper if exists
        if (cropper) {
          cropper.destroy();
        }
        
        // Show modal
        document.getElementById('crop-modal').classList.add('active');
        
        // Initialize cropper
        setTimeout(() => {
          cropper = new Cropper(cropImage, {
            aspectRatio: 1,
            viewMode: 1,
            dragMode: 'move',
            autoCropArea: 1,
            restore: false,
            guides: true,
            center: true,
            highlight: false,
            cropBoxMovable: true,
            cropBoxResizable: true,
            toggleDragModeOnDblclick: false,
          });
        }, 100);
      };
      reader.readAsDataURL(file);
    }
    
    function closeCropModal() {
      document.getElementById('crop-modal').classList.remove('active');
      if (cropper) {
        cropper.destroy();
        cropper = null;
      }
    }
    
    async function applyCrop() {
      if (!cropper) return;
      
      // Get cropped canvas
      const canvas = cropper.getCroppedCanvas({
        width: 400,
        height: 400,
        imageSmoothingQuality: 'high'
      });
      
      // Convert to base64
      const avatar_url = canvas.toDataURL('image/jpeg', 0.85);
      
      // Close modal
      closeCropModal();
      
      // Upload to server
      try {
        const response = await fetch('/api/auth/update-avatar', {
          method: 'POST',
          headers: {'Content-Type': 'application/json'},
          body: JSON.stringify({ avatar_url })
        });
        
        const data = await response.json();
        
        if (data.success) {
          document.getElementById('profile-avatar').src = avatar_url;
          document.getElementById('profile-avatar').style.display = 'block';
          document.getElementById('avatar-placeholder').style.display = 'none';
          showAlert('Cập nhật avatar thành công!', 'success');
        } else {
          showAlert(data.message || 'Cập nhật avatar thất bại', 'error');
        }
      } catch (error) {
        showAlert('Lỗi kết nối. Vui lòng thử lại.', 'error');
      }
    }
    
    // Detect if device has camera/touch (mobile/tablet)
    function isMobileDevice() {
      return ('ontouchstart' in window) || (navigator.maxTouchPoints > 0);
    }
    
    // Hide camera option on desktop
    if (!isMobileDevice()) {
      const cameraOption = document.getElementById('camera-option');
      if (cameraOption) {
        cameraOption.style.display = 'none';
      }
    }
    
    // Attach event listeners
    document.getElementById('avatar-upload').addEventListener('change', handleFileSelect);
    document.getElementById('avatar-camera').addEventListener('change', handleFileSelect);
    
    // Close modals on background click
    document.getElementById('avatar-options-modal').addEventListener('click', function(e) {
      if (e.target === this) closeAvatarOptions();
    });
    
    document.getElementById('crop-modal').addEventListener('click', function(e) {
      if (e.target === this) closeCropModal();
    });
    
    // Update profile
    document.getElementById('profile-form').addEventListener('submit', async function(e) {
      e.preventDefault();
      
      const name = document.getElementById('name').value;
      const bio = document.getElementById('bio')?.value || '';
      
      const submitBtn = this.querySelector('button[type="submit"]');
      const originalText = submitBtn.innerHTML;
      submitBtn.disabled = true;
      submitBtn.innerHTML = 'Đang cập nhật...';
      
      try {
        const response = await fetch('/api/auth/update-profile', {
          method: 'POST',
          headers: {
            'Content-Type': 'application/json'
          },
          body: JSON.stringify({ name, bio })
        });
        
        const data = await response.json();
        
        if (data.success) {
          showAlert('Cập nhật thông tin thành công!', 'success');
          closeEditProfileModal();
          loadProfile(); // Reload profile data
        } else {
          showAlert(data.message || 'Cập nhật thất bại', 'error');
        }
      } catch (error) {
        showAlert('Lỗi kết nối. Vui lòng thử lại.', 'error');
      }
      
      submitBtn.disabled = false;
      submitBtn.innerHTML = originalText;
    });
    
    // Change password
    document.getElementById('password-form').addEventListener('submit', async function(e) {
      e.preventDefault();
      
      const oldPassword = document.getElementById('old-password').value;
      const newPassword = document.getElementById('new-password').value;
      const confirmPassword = document.getElementById('confirm-new-password').value;
      
      if (newPassword.length < 6) {
        showAlert('Mật khẩu mới phải có ít nhất 6 ký tự', 'error', 'password-alert');
        return;
      }
      
      if (newPassword !== confirmPassword) {
        showAlert('Mật khẩu xác nhận không khớp', 'error', 'password-alert');
        return;
      }
      
      const submitBtn = this.querySelector('button[type="submit"]');
      const originalText = submitBtn.innerHTML;
      submitBtn.disabled = true;
      submitBtn.innerHTML = 'Đang xử lý...';
      
      try {
        const response = await fetch('/api/auth/change-password', {
          method: 'POST',
          headers: {
            'Content-Type': 'application/json'
          },
          body: JSON.stringify({ old_password: oldPassword, new_password: newPassword })
        });
        
        const data = await response.json();
        
        if (data.success) {
          showAlert('Đổi mật khẩu thành công!', 'success', 'password-alert');
          this.reset();
          setTimeout(() => {
            closeChangePasswordModal();
            showAlert('Đổi mật khẩu thành công!', 'success', 'alert-message');
          }, 1500);
        } else {
          showAlert(data.message || 'Đổi mật khẩu thất bại', 'error', 'password-alert');
        }
      } catch (error) {
        showAlert('Lỗi kết nối. Vui lòng thử lại.', 'error', 'password-alert');
      }
      
      submitBtn.disabled = false;
      submitBtn.innerHTML = originalText;
    });
    
    // Load friends preview for sidebar
    async function loadFriendsPreview() {
      try {
        const response = await fetch(`/api/profile/friends?user_id=${profileUserId}&limit=6`);
        const data = await response.json();
        
        const previewContainer = document.getElementById('friends-preview');
        const noFriendsMsg = document.getElementById('no-friends-preview');
        
        if (data.success && data.friends && data.friends.length > 0) {
          previewContainer.innerHTML = data.friends.slice(0, 6).map(friend => `
            <a href="/profile/${friend.username_slug || friend.id}" class="block">
              <div class="aspect-square rounded-lg overflow-hidden bg-gray-100">
                ${friend.avatar_url 
                  ? `<img src="${friend.avatar_url}" class="w-full h-full object-cover" />`
                  : `<div class="w-full h-full flex items-center justify-center bg-green-600 text-white font-bold text-lg">
                      ${(friend.name || friend.email).charAt(0).toUpperCase()}
                    </div>`
                }
              </div>
            </a>
          `).join('');
          previewContainer.classList.remove('hidden');
          noFriendsMsg.classList.add('hidden');
        } else {
          previewContainer.classList.add('hidden');
          noFriendsMsg.classList.remove('hidden');
        }
      } catch (error) {
        console.error('Error loading friends preview:', error);
      }
    }
    
    // Load photos preview for sidebar
    async function loadPhotosPreview() {
      try {
        const response = await fetch(`/api/profile/photos?user_id=${profileUserId}&limit=6`);
        const data = await response.json();
        
        const previewContainer = document.getElementById('photos-preview');
        const noPhotosMsg = document.getElementById('no-photos-preview');
        
        if (data.success && data.photos && data.photos.length > 0) {
          previewContainer.innerHTML = data.photos.slice(0, 6).map(photo => `
            <div class="aspect-square rounded-lg overflow-hidden bg-gray-100 cursor-pointer hover:opacity-90 transition-opacity" onclick="openPhotoModal(${photo.id})">
              <img src="${photo.photo_url}" class="w-full h-full object-cover" />
            </div>
          `).join('');
          previewContainer.classList.remove('hidden');
          noPhotosMsg.classList.add('hidden');
        } else {
          previewContainer.classList.add('hidden');
          noPhotosMsg.classList.remove('hidden');
        }
      } catch (error) {
        console.error('Error loading photos preview:', error);
      }
    }
    
    // Load profile on page load
    document.addEventListener('DOMContentLoaded', function() {
      loadProfile();
      loadNotifications();
      
      // Refresh notifications every 30 seconds
      setInterval(loadNotifications, 30000);
    });
    
    // Show likes list modal
    async function showLikesList(postId) {
      const modal = document.getElementById('likes-modal');
      const content = document.getElementById('likes-list-content');
      
      modal.classList.add('active');
      content.innerHTML = '<div class="flex justify-center py-8"><div class="loading-spinner"></div></div>';
      
      try {
        const response = await fetch(`/api/forum/posts/${postId}/likes`);
        const data = await response.json();
        
        if (data.success && data.likes && data.likes.length > 0) {
          content.innerHTML = data.likes.map(like => {
            const userName = like.user_name || like.user_email?.split('@')[0] || 'Người dùng';
            const userAvatar = like.user_avatar 
              ? `<img src="${like.user_avatar}" class="w-full h-full rounded-full object-cover" />`
              : `<div class="w-12 h-12 rounded-full bg-gradient-to-br from-green-400 to-green-600 flex items-center justify-center text-white font-semibold text-lg">
                  ${userName.charAt(0).toUpperCase()}
                </div>`;
            
            return `
              <a href="/profile/${like.username_slug || like.user_id}" class="flex items-center gap-3 p-3 hover:bg-gray-50 rounded-lg transition-colors">
                <div class="w-12 h-12 flex-shrink-0">
                  ${userAvatar}
                </div>
                <div class="flex-1 min-w-0">
                  <h4 class="font-semibold text-gray-900 truncate">${userName}</h4>
                  <p class="text-sm text-gray-500 truncate">${like.user_email || ''}</p>
                </div>
                <i class="fas fa-thumbs-up text-green-600"></i>
              </a>
            `;
          }).join('');
        } else {
          content.innerHTML = `
            <div class="text-center py-8">
              <i class="far fa-heart text-gray-300 text-5xl mb-3"></i>
              <p class="text-gray-500">Chưa có ai thích bài viết này</p>
            </div>
          `;
        }
      } catch (error) {
        console.error('Error loading likes:', error);
        content.innerHTML = `
          <div class="text-center py-8">
            <i class="fas fa-exclamation-circle text-red-400 text-5xl mb-3"></i>
            <p class="text-gray-500">Không thể tải danh sách</p>
          </div>
        `;
      }
    }
    
    function closeLikesModal() {
      document.getElementById('likes-modal').classList.remove('active');
    }
    
    // Toggle comments section
    async function toggleComments(postId) {
      const commentsSection = document.getElementById(`comments-${postId}`);
      const commentsList = document.getElementById(`comments-list-${postId}`);
      
      if (commentsSection.classList.contains('hidden')) {
        commentsSection.classList.remove('hidden');
        
        // Load comments if not already loaded
        if (commentsList.innerHTML.includes('Đang tải')) {
          try {
            const response = await fetch(`/api/forum/posts/${postId}/comments`);
            const data = await response.json();
            
            if (data.success && data.comments && data.comments.length > 0) {
              commentsList.innerHTML = data.comments.map(comment => {
                const userName = comment.user_name || comment.user_email?.split('@')[0] || 'Người dùng';
                const userAvatar = comment.user_avatar
                  ? `<img src="${comment.user_avatar}" class="w-full h-full rounded-full object-cover" />`
                  : `<div class="w-8 h-8 rounded-full bg-gradient-to-br from-blue-400 to-blue-600 flex items-center justify-center text-white font-semibold text-sm">
                      ${userName.charAt(0).toUpperCase()}
                    </div>`;
                
                return `
                  <div class="flex items-start gap-3">
                    <a href="/profile/${comment.username_slug || comment.user_id}" class="flex-shrink-0">
                      ${userAvatar}
                    </a>
                    <div class="flex-1">
                      <div class="bg-white rounded-2xl px-4 py-2.5 inline-block">
                        <a href="/profile/${comment.username_slug || comment.user_id}" class="font-semibold text-gray-900 hover:underline text-sm">
                          ${userName}
                        </a>
                        <p class="text-gray-800 mt-1 text-sm">${comment.content}</p>
                      </div>
                      <div class="flex items-center gap-4 mt-1 px-4 text-xs text-gray-500">
                        <span>${getTimeAgo(comment.created_at)}</span>
                        <button class="hover:underline">Thích</button>
                        <button class="hover:underline">Trả lời</button>
                      </div>
                    </div>
                  </div>
                `;
              }).join('');
            } else {
              commentsList.innerHTML = `
                <div class="text-center py-8">
                  <i class="far fa-comment text-gray-300 text-4xl mb-2"></i>
                  <p class="text-gray-500 text-sm">Chưa có bình luận nào</p>
                  <p class="text-gray-400 text-xs mt-1">Hãy là người đầu tiên bình luận!</p>
                </div>
              `;
            }
          } catch (error) {
            console.error('Error loading comments:', error);
            commentsList.innerHTML = `
              <div class="text-center py-4">
                <p class="text-red-500 text-sm">Không thể tải bình luận</p>
              </div>
            `;
          }
        }
      } else {
        commentsSection.classList.add('hidden');
      }
    }

    // Create Post Modal Functions
    function openCreatePostModal(type) {
      const modal = document.getElementById('create-post-modal');
      if (modal) {
        modal.classList.add('active');
        // Load user info
        if (currentUserId) {
          const avatarEl = document.getElementById('modal-user-avatar');
          const nameEl = document.getElementById('modal-user-name');
          
          if (document.getElementById('profile-avatar').style.display !== 'none') {
            avatarEl.innerHTML = `<img src="${document.getElementById('profile-avatar').src}" class="w-full h-full rounded-full object-cover" />`;
          } else {
            const initial = document.getElementById('profile-name').textContent.charAt(0).toUpperCase();
            avatarEl.innerHTML = initial;
          }
          nameEl.textContent = document.getElementById('profile-name').textContent;
        }
      }
    }

    function closeCreatePostModal() {
      const modal = document.getElementById('create-post-modal');
      if (modal) {
        modal.classList.remove('active');
        // Clear form
        document.getElementById('post-title').value = '';
        document.getElementById('post-content').value = '';
        document.getElementById('post-tags').value = '';
        document.getElementById('image-preview-container').classList.add('hidden');
      }
    }

    function selectPostImage() {
      document.getElementById('post-image-input').click();
    }

    document.getElementById('post-image-input')?.addEventListener('change', function(e) {
      const file = e.target.files[0];
      if (file) {
        const reader = new FileReader();
        reader.onload = function(event) {
          const preview = document.getElementById('image-preview');
          const container = document.getElementById('image-preview-container');
          preview.src = event.target.result;
          container.classList.remove('hidden');
        };
        reader.readAsDataURL(file);
      }
    });

    function removePostImage() {
      document.getElementById('image-preview-container').classList.add('hidden');
      document.getElementById('post-image-input').value = '';
    }


    async function submitPost() {
      const content = document.getElementById('post-content').value.trim();
      const tags = document.getElementById('post-tags').value.trim();
      const imagePreview = document.getElementById('image-preview');
      
      if (!content) {
        alert('Vui lòng nhập nội dung bài viết');
        return;
      }

      try {
        const postData = {
          title: '', // Empty title - no title field
          content,
          tags: tags.split(',').map(t => t.trim()).filter(t => t),
          image_url: selectedImage,
          poll: pollData,
          location: selectedLocation,
          mentioned_users: mentionedUsers
        };

        const response = await fetch('/api/forum/posts', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify(postData)
        });

        const data = await response.json();

        if (data.success) {
          alert('Đăng bài thành công!');
          closeCreatePostModal();
          loadUserPosts(currentUserId);
          // Reset form
          document.getElementById('post-content').value = '';
          document.getElementById('post-tags').value = '';
          document.getElementById('image-preview-container').classList.add('hidden');
          pollData = null;
          selectedLocation = null;
          mentionedUsers = [];
          hashtags = [];
          selectedImage = null;
        } else {
          alert('Có lỗi: ' + (data.message || 'Không thể đăng bài'));
        }
      } catch (error) {
        console.error('Error submitting post:', error);
        alert('Có lỗi khi đăng bài');
      }
    }
    
    // Poll Modal Functions
    function openPollModal() {
      document.getElementById('poll-modal').classList.remove('hidden');
      document.getElementById('poll-modal').classList.add('active');
    }
    
    function closePollModal() {
      document.getElementById('poll-modal').classList.add('hidden');
      document.getElementById('poll-modal').classList.remove('active');
      
      // Reset poll options container to 2 default options with remove buttons
      document.getElementById('poll-options-container').innerHTML = `
        <div class="flex items-center gap-2">
          <input 
            type="text" 
            placeholder="Lựa chọn 1"
            class="poll-option flex-1 px-3 sm:px-4 py-2.5 border border-gray-300 rounded-lg focus:outline-none focus:border-blue-600 text-sm sm:text-base"
          />
          <button onclick="removePollOption(this)" class="text-gray-400 hover:text-gray-600 p-1">
            <i class="fas fa-times"></i>
          </button>
        </div>
        <div class="flex items-center gap-2">
          <input 
            type="text" 
            placeholder="Lựa chọn 2"
            class="poll-option flex-1 px-3 sm:px-4 py-2.5 border border-gray-300 rounded-lg focus:outline-none focus:border-blue-600 text-sm sm:text-base"
          />
          <button onclick="removePollOption(this)" class="text-gray-400 hover:text-gray-600 p-1">
            <i class="fas fa-times"></i>
          </button>
        </div>
      `;
      
      document.getElementById('poll-settings').classList.add('hidden');
      document.getElementById('poll-multiple').checked = false;
    }
    
    function addPollOption() {
      const container = document.getElementById('poll-options-container');
      const optionCount = container.children.length + 1;
      
      const newOption = document.createElement('div');
      newOption.className = 'flex items-center gap-2';
      newOption.innerHTML = `
        <input 
          type="text" 
          placeholder="Lựa chọn ${optionCount}"
          class="poll-option flex-1 px-3 sm:px-4 py-2.5 border border-gray-300 rounded-lg focus:outline-none focus:border-blue-600 text-sm sm:text-base"
        />
        <button onclick="removePollOption(this)" class="text-gray-400 hover:text-gray-600 p-1">
          <i class="fas fa-times"></i>
        </button>
      `;
      
      container.appendChild(newOption);
    }
    
    function removePollOption(button) {
      const optionDiv = button.parentElement;
      optionDiv.remove();
    }
    
    function togglePollSettings() {
      const settings = document.getElementById('poll-settings');
      settings.classList.toggle('hidden');
    }
    
    function addPollToPost() {
      const options = Array.from(document.querySelectorAll('.poll-option'))
        .map(input => input.value.trim())
        .filter(value => value);
      const allowMultiple = document.getElementById('poll-multiple').checked;
      
      if (options.length < 2) {
        alert('Cần ít nhất 2 tùy chọn');
        return;
      }
      
      pollData = { question: '', options, allowMultiple, votes: options.map(() => 0) };
      
      // Close poll modal
      document.getElementById('poll-modal').classList.add('hidden');
      
      // Open create post modal
      document.getElementById('create-post-modal').classList.add('active');
      
      // Setup and show poll preview
      setTimeout(() => {
        showPollPreview();
      }, 100);
      
      showAlert('Khảo sát đã được thêm!', 'success');
    }
    
    function showPollPreview() {
      if (!pollData || pollData.options.length === 0) return;
      
      const pollContainer = document.getElementById('poll-preview-container');
      if (!pollContainer) return;
      
      pollContainer.innerHTML = `
        <div class="mb-3 sm:mb-4 p-3 sm:p-4 bg-blue-50 rounded-lg border border-blue-200">
          <div class="flex items-center justify-between mb-2">
            <p class="text-sm font-semibold text-blue-700">📊 Khảo sát</p>
            <button onclick="removePollPreview()" class="text-gray-400 hover:text-gray-600 transition-colors">
              <i class="fas fa-times"></i>
            </button>
          </div>
          <div class="space-y-2">
            ${pollData.options.map(option => `
              <div class="p-2.5 bg-white rounded border border-blue-200 text-sm text-gray-700 flex items-center gap-2">
                <input type="radio" name="poll_option" class="cursor-pointer" />
                <span>${escapeHtml(option)}</span>
              </div>
            `).join('')}
          </div>
        </div>
      `;
    }
    
    function removePollPreview() {
      const container = document.getElementById('poll-preview-container');
      if (container) {
        container.innerHTML = '';
      }
      pollData = null;
    }
    
    // Location Modal Functions
    function openLocationPicker() {
      document.getElementById('location-modal').classList.add('active');
      document.getElementById('location-modal').classList.remove('hidden');
    }
    
    function closeLocationModal() {
      document.getElementById('location-modal').classList.remove('active');
      document.getElementById('location-modal').classList.add('hidden');
      document.getElementById('location-search').value = '';
      selectedLocation = null;
      document.getElementById('location-confirm-btn').disabled = true;
    }
    
    async function useCurrentLocation() {
      if (navigator.geolocation) {
        // Show loading spinner
        const locationList = document.getElementById('location-list');
        locationList.innerHTML = `<div class="p-3 text-center"><div class="inline-block"><div class="animate-spin rounded-full h-6 w-6 border-2 border-green-300 border-t-green-600"></div></div><p class="text-xs sm:text-sm text-gray-600 mt-2">Đang lấy vị trí...</p></div>`;
        document.getElementById('location-confirm-btn').disabled = true;
        
        navigator.geolocation.getCurrentPosition(async position => {
          const { latitude, longitude } = position.coords;
          
          try {
            // Reverse geocode using Nominatim API to get address
            const response = await fetch(
              `https://nominatim.openstreetmap.org/reverse?format=json&lat=${latitude}&lon=${longitude}&zoom=10&addressdetails=1`
            );
            const data = await response.json();
            
            // Extract province and district from Nominatim response
            const address = data.address;
            let locationName = '';
            
            // For Vietnam locations, try to get province (state)
            if (address.state) {
              locationName = address.state;
              // Try to add district if available
              if (address.county) {
                locationName = `${address.county}, ${address.state}`;
              }
            } else if (address.province) {
              locationName = address.province;
              if (address.county) {
                locationName = `${address.county}, ${address.province}`;
              }
            } else if (address.county) {
              locationName = address.county;
            } else if (data.name) {
              locationName = data.name;
            } else {
              locationName = `${latitude.toFixed(4)}, ${longitude.toFixed(4)}`;
            }
            
            selectedLocation = { latitude, longitude, address: locationName };
            document.getElementById('location-confirm-btn').disabled = false;
            
            const locationListElement = document.getElementById('location-list');
            locationListElement.innerHTML = `<div class="p-2 bg-green-50 rounded-lg text-xs sm:text-sm text-green-700"><i class="fas fa-check-circle mr-2"></i>Vị trí hiện tại: ${selectedLocation.address}</div>`;
          } catch (error) {
            console.error('Reverse geocoding error:', error);
            // Fallback: use coordinates if geocoding fails
            selectedLocation = { latitude, longitude, address: `${latitude.toFixed(4)}, ${longitude.toFixed(4)}` };
            document.getElementById('location-confirm-btn').disabled = false;
            const locationListElement = document.getElementById('location-list');
            locationListElement.innerHTML = `<div class="p-2 bg-green-50 rounded-lg text-xs sm:text-sm text-green-700"><i class="fas fa-check-circle mr-2"></i>Vị trí hiện tại: ${selectedLocation.address}</div>`;
          }
        }, (error) => {
          // Handle geolocation error
          console.error('Geolocation error:', error);
          const locationListElement = document.getElementById('location-list');
          locationListElement.innerHTML = `<div class="p-2 bg-red-50 rounded-lg text-xs sm:text-sm text-red-700"><i class="fas fa-exclamation-circle mr-2"></i>Không thể lấy vị trí. Vui lòng kiểm tra quyền định vị.</div>`;
          document.getElementById('location-confirm-btn').disabled = true;
        });
      } else {
        alert('Trình duyệt không hỗ trợ định vị địa chỉ');
      }
    }
    
    function addLocationToPost() {
      if (!selectedLocation) {
        alert('Vui lòng chọn vị trí');
        return;
      }
      
      // Don't add to post content - location is kept separate
      closeLocationModal();
      showAlert('Vị trí đã được thêm!', 'success');
    }
    
    // Escape HTML to prevent XSS
    function escapeHtml(text) {
      const map = {
        '&': '&amp;',
        '<': '&lt;',
        '>': '&gt;',
        '"': '&quot;',
        "'": '&#039;'
      };
      return text.replace(/[&<>"']/g, m => map[m]);
    }
    
    function showAlert(message, type = 'error', elementId = 'alert-message') {
      console.log(message);
    }
    
    function closeCreatePostModal() {
      document.getElementById('create-post-modal').classList.remove('active');
      document.getElementById('post-content').value = '';
      document.getElementById('post-tags').value = '';
      document.getElementById('image-preview-container').classList.add('hidden');
      const pollContainer = document.getElementById('poll-preview-container');
      if (pollContainer) pollContainer.innerHTML = '';
      pollData = null;
      selectedLocation = null;
    }
  </script>
  
</body>
</html>

