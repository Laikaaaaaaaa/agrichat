<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
    
    <!-- WebView Optimization -->
    <meta name="mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <meta name="format-detection" content="telephone=no">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    
    <title>AgriSense AI - Lịch sử hội thoại</title>
    
    <!-- Favicon -->
    <link rel="icon" type="image/x-icon" href="/static/favicon logo/favicon/favicon.ico">
    <link rel="icon" type="image/svg+xml" href="/static/favicon logo/favicon/favicon.svg">
    <link rel="icon" type="image/png" sizes="96x96" href="/static/favicon logo/favicon/favicon-96x96.png">
    <link rel="apple-touch-icon" sizes="180x180" href="/static/favicon logo/favicon/apple-touch-icon.png">
    <link rel="manifest" href="/static/favicon logo/favicon/site.webmanifest">
    
    <link href="https://cdn.tailwindcss.com" rel="stylesheet">
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">
    <script src="https://cdn.jsdelivr.net/npm/markdown-it@13.0.1/dist/markdown-it.min.js"></script>
    <style>
        /* WebView Optimization */
        * {
            -webkit-tap-highlight-color: rgba(0, 0, 0, 0);
            -webkit-touch-callout: none;
            -webkit-overflow-scrolling: touch;
        }
        
        html, body {
            height: 100%;
            margin: 0;
            padding: 0;
            overflow: hidden;
            -webkit-text-size-adjust: 100%;
            -ms-text-size-adjust: 100%;
            -webkit-font-smoothing: antialiased;
            -moz-osx-font-smoothing: grayscale;
        }
        
        /* Prevent image selection in WebView */
        img {
            -webkit-user-select: none;
            user-select: none;
            pointer-events: none;
        }
        
        /* Better touch handling */
        button, a, input, textarea, select {
            -webkit-user-select: text;
            user-select: text;
        }
        
        :root {
            --sidebar-w: 320px;
            --z-sidebar: 3000;
            --z-backdrop: 4000;
        }
        
        /* Scrollbar styling */
        .custom-scrollbar::-webkit-scrollbar { 
            width: 8px; 
            height: 8px;
        }
        .custom-scrollbar::-webkit-scrollbar-track { 
            background: #f1f5f9; 
            border-radius: 4px; 
        }
        .custom-scrollbar::-webkit-scrollbar-thumb { 
            background: linear-gradient(180deg, #10b981, #059669);
            border-radius: 4px; 
            transition: background 0.3s;
        }
        .custom-scrollbar::-webkit-scrollbar-thumb:hover {
            background: linear-gradient(180deg, #059669, #047857);
        }
        
        /* Main container layout */
        #main-container {
            display: flex;
            height: 100%;
            position: relative;
            overflow: hidden;
            width: 100%;
            max-width: 100%;
            background: white;
        }
        
        /* Sidebar styling */
        #history-sidebar {
            width: var(--sidebar-w);
            height: 100%;
            background: #fff;
            box-shadow: 2px 0 12px rgba(0,0,0,0.08);
            transition: transform 0.36s cubic-bezier(0.25,0.46,0.45,0.94);
            will-change: transform;
            z-index: var(--z-sidebar);
            flex-shrink: 0;
            display: flex;
            flex-direction: column;
            overflow: hidden;
        }
        
        #conversation-list {
            flex: 1;
            overflow-y: auto;
        }
        
        /* Chat content area */
        #chat-content {
            flex: 1;
            display: flex;
            flex-direction: column;
            overflow: hidden;
            background: white;
        }
        
        /* Desktop: sidebar behavior */
        @media (min-width: 768px) {
            #history-sidebar {
                position: relative;
                transform: translateX(0);
            }
            #history-sidebar.closed {
                transform: translateX(calc(-1 * var(--sidebar-w)));
            }
        }
        
        /* Mobile: sidebar overlay */
        @media (max-width: 767px) {
            #history-sidebar {
                position: fixed;
                top: 80px;
                left: 0;
                bottom: 0;
                transform: translateX(calc(-1 * var(--sidebar-w)));
                transition: transform 0.28s ease;
                z-index: 4500;
            }
            #history-sidebar.open {
                transform: translateX(0);
            }
            
            /* Backdrop for mobile */
            #main-container.mobile-sidebar-open::before {
                content: '';
                position: fixed;
                top: 80px;
                left: 0;
                right: 0;
                bottom: 0;
                background: rgba(0, 0, 0, 0.5);
                z-index: 4000;
                animation: fadeIn 0.28s ease;
            }
            
            @keyframes fadeIn {
                from { opacity: 0; }
                to { opacity: 1; }
            }
        }
        
        /* Toggle button */
        #sidebar-toggle {
            position: fixed;
            top: 50%;
            left: 0;
            transform: translateY(-50%);
            z-index: 5000;
            background: transparent;
            color: #10b981;
            border: none;
            width: 32px;
            height: 70px;
            display: flex;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            transition: all 0.3s cubic-bezier(0.25, 0.46, 0.45, 0.94);
            font-size: 28px;
            font-weight: bold;
            opacity: 0.7;
        }
        
        #sidebar-toggle:hover {
            opacity: 1;
            color: #059669;
            transform: translateY(-50%) scale(1.2);
        }
        
        #sidebar-toggle::before {
            content: '»';
            text-shadow: 2px 2px 4px rgba(0,0,0,0.2);
            transition: all 0.3s ease;
        }
        
        /* Change arrow when sidebar is open */
        #main-container.mobile-sidebar-open #sidebar-toggle {
            left: calc(var(--sidebar-w) + 12px);
            opacity: 1;
            pointer-events: all;
        }
        
        #main-container.mobile-sidebar-open #sidebar-toggle::before {
            content: '«';
        }
        
        @media (min-width: 768px) {
            #sidebar-toggle {
                display: none;
            }
        }
        
        /* Conversation item styling */
        .conversation-item { 
            transition: all 0.3s ease; 
            cursor: pointer;
            position: relative;
            overflow: hidden;
        }
        .conversation-item::before {
            content: '';
            position: absolute;
            left: 0;
            top: 0;
            height: 100%;
            width: 4px;
            background: linear-gradient(180deg, #10b981, #059669);
            transform: scaleY(0);
            transition: transform 0.3s ease;
        }
        .conversation-item:hover {
            background: linear-gradient(135deg, #f0fdf4 0%, #dcfce7 100%);
            border-color: #10b981;
            transform: translateX(4px);
            box-shadow: 0 4px 12px rgba(16, 185, 129, 0.15);
        }
        .conversation-item:hover::before {
            transform: scaleY(1);
        }
        .conversation-item.active { 
            background: linear-gradient(135deg, #dcfce7 0%, #bbf7d0 100%);
            border-color: #059669;
            box-shadow: 0 6px 20px rgba(5, 150, 105, 0.25);
            transform: translateX(4px);
        }
        .conversation-item.active::before {
            transform: scaleY(1);
        }
        
        /* Message wrapper styling - giống index.html */
        .message-wrapper {
            margin-bottom: 12px;
            animation: slideIn 0.3s ease;
        }
        
        .message-wrapper.user {
            text-align: right;
        }
        
        .message-wrapper.bot {
            text-align: left;
        }
        
        @keyframes slideIn {
            from {
                opacity: 0;
                transform: translateY(10px);
            }
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }
        
        /* Message bubble styling - giống index.html */
        .user-bubble {
            display: inline-block;
            background: #3b82f6;  /* Blue-500 giống index */
            color: white;
            padding: 8px 12px;
            border-radius: 12px;
            box-shadow: 0 1px 2px rgba(0, 0, 0, 0.1);
            font-size: 14px;
            max-width: 448px;  /* max-w-md */
            word-wrap: break-word;
            overflow-wrap: break-word;
            text-align: left;
        }
        
        .bot-bubble {
            display: inline-block;
            background: #f3f4f6;  /* Gray-100 giống index */
            color: #1f2937;  /* Gray-800 */
            padding: 8px 12px;
            border-radius: 12px;
            box-shadow: 0 1px 2px rgba(0, 0, 0, 0.05);
            font-size: 14px;
            max-width: 448px;  /* max-w-md */
            word-wrap: break-word;
            overflow-wrap: break-word;
            overflow: hidden;
        }
        
        /* Responsive sizes */
        @media (min-width: 768px) {
            .user-bubble, .bot-bubble {
                padding: 12px;
                font-size: 16px;
                max-width: 672px;  /* max-w-2xl */
            }
        }
        
        /* Text truncation */
        .line-clamp-2 {
            display: -webkit-box;
            -webkit-line-clamp: 2;
            line-clamp: 2;
            -webkit-box-orient: vertical;
            overflow: hidden;
            text-overflow: ellipsis;
            line-height: 1.5;
            max-height: 3em;
        }
        
        /* Image galleries */
        .image-gallery {
            max-width: 600px !important;
            margin: 15px auto !important;
        }
        .image-item {
            background: white !important;
            border-radius: 12px !important;
            padding: 12px !important;
            box-shadow: 0 3px 15px rgba(0,0,0,0.12) !important;
            transition: all 0.3s ease !important;
            min-height: auto !important;
            max-height: 280px !important;
        }
        .image-item:hover {
            transform: translateY(-5px) !important;
            box-shadow: 0 8px 25px rgba(0,0,0,0.18) !important;
        }
        .image-item img {
            width: 100% !important;
            height: 140px !important;
            object-fit: cover !important;
            border-radius: 8px !important;
            margin-bottom: 8px !important;
            cursor: pointer !important;
            transition: all 0.3s ease !important;
        }
        .image-item img:hover {
            transform: scale(1.05) !important;
        }
        .image-item h4 {
            font-size: 13px !important;
            line-height: 1.3 !important;
            min-height: auto !important;
            max-height: 32px !important;
            overflow: hidden !important;
            margin: 6px 0 !important;
        }
        .image-item p {
            font-size: 11px !important;
            line-height: 1.3 !important;
            min-height: auto !important;
            max-height: 28px !important;
            overflow: hidden !important;
            margin: 4px 0 !important;
        }
        .image-item small {
            font-size: 10px !important;
        }
        
        /* Mobile optimization for image galleries */
        @media (max-width: 768px) {
            .image-gallery {
                padding: 15px !important;
                gap: 12px !important;
            }
            .image-item {
                padding: 10px !important;
                max-height: 240px !important;
            }
            .image-item img {
                height: 120px !important;
            }
            .image-item h4 {
                font-size: 12px !important;
                max-height: 28px !important;
            }
            .image-item p {
                font-size: 10px !important;
                max-height: 24px !important;
            }
        }
        
        /* Mobile responsive */
        @media (max-width: 768px) {
            .message-bubble {
                max-width: 85% !important;
            }
        }
        
        /* Button hover effects */
        .btn-hover {
            transition: all 0.3s ease;
        }
        .btn-hover:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.15);
        }
        
        /* Empty state animation */
        .empty-state-icon {
            animation: float 3s ease-in-out infinite;
        }
        @keyframes float {
            0%, 100% {
                transform: translateY(0);
            }
            50% {
                transform: translateY(-10px);
            }
        }
    </style>
</head>
<body class="bg-gray-50 min-h-screen flex flex-col">
    <header class="bg-green-100 border-b border-green-200 shadow-sm flex-shrink-0">
        <div class="w-full flex justify-between items-center py-3 px-4 md:py-4 md:px-6">
            <div class="flex items-center gap-3">
                <!-- Back button -->
                <button onclick="window.location.href='index.html'" class="text-white bg-green-600 hover:bg-green-700 transition-colors p-2 rounded-lg shadow-lg border-2 border-green-500 font-bold text-sm">
                    <i class="fas fa-arrow-left"></i>
                </button>
                <!-- Logo -->
                <img src="/static/logo/logo.png" alt="AgriSense AI Logo" class="h-12 md:h-14 w-auto object-contain">
            </div>
            <span class="text-xs md:text-sm text-gray-600 hidden md:block">Lịch sử hội thoại</span>
            <div class="flex items-center gap-2 md:gap-4">
                <div class="text-right">
                    <div class="text-xs md:text-sm text-gray-600">Tổng cộng</div>
                    <div id="total-conversations" class="font-bold text-green-700 text-sm">0 cuộc hội thoại</div>
                </div>
            </div>
        </div>
    </header>

    <div id="main-container" class="w-full flex-1">
        <!-- Mobile Toggle Button - Tab từ cạnh trái -->
        <button id="sidebar-toggle" aria-label="Toggle sidebar"></button>
            
            <!-- Sidebar: Conversation List -->
            <aside id="history-sidebar" class="custom-scrollbar">
                <div class="p-3 md:p-4 border-b border-gray-200 bg-gradient-to-r from-green-50 to-emerald-50 flex-shrink-0">
                    <div class="flex items-center justify-between mb-3 md:mb-4">
                        <h2 class="text-sm md:text-base font-semibold text-gray-800 flex items-center gap-2">
                            <i class="fas fa-comments text-green-600"></i>
                            <span class="hidden sm:inline">Danh sách hội thoại</span>
                            <span class="sm:hidden">Hội thoại</span>
                        </h2>
                        <div class="flex gap-2">

                            <button id="clear-all-btn" class="text-red-500 hover:text-red-700 text-xs md:text-sm p-1 md:p-2 rounded hover:bg-red-50 transition-all btn-hover" title="Xóa tất cả">
                                <i class="fas fa-trash"></i>
                            </button>
                        </div>
                    </div>
                    <div class="relative">
                        <input type="text" id="search-conversations" placeholder="Tìm kiếm hội thoại..." 
                               class="w-full pl-9 md:pl-10 pr-3 md:pr-4 py-2 border border-gray-300 rounded-lg text-xs md:text-sm focus:ring-2 focus:ring-green-500 focus:border-transparent transition-all">
                        <i class="fas fa-search absolute left-3 top-1/2 transform -translate-y-1/2 text-gray-400 text-xs md:text-sm"></i>
                    </div>
                </div>
                <div id="conversation-list" class="flex-1 overflow-y-auto custom-scrollbar"></div>
            </aside>
            
            <!-- Chat Content Area -->
            <main id="chat-content">
                <div class="p-3 md:p-4 border-b border-gray-200 bg-gradient-to-r from-green-50 to-emerald-50 flex-shrink-0">
                    <div id="chat-header" class="flex items-center justify-between">
                        <div class="flex-1 min-w-0">
                            <h2 class="text-sm md:text-base font-semibold text-gray-800 flex items-center gap-2 truncate">
                                <i class="fas fa-comment-dots text-green-600"></i>
                                <span id="conversation-title">Chi tiết hội thoại</span>
                            </h2>
                            <p class="text-xs md:text-sm text-gray-500 mt-1 hidden sm:block">Chọn một cuộc hội thoại để xem chi tiết</p>
                        </div>
                        <button id="continue-chat-btn" class="hidden bg-green-600 hover:bg-green-700 text-white px-4 py-2 rounded-lg transition-all btn-hover flex items-center gap-2 text-sm">
                            <i class="fas fa-arrow-right"></i>
                            <span class="hidden md:inline">Tiếp tục trò chuyện</span>
                            <span class="md:hidden">Tiếp tục</span>
                        </button>
                    </div>
                </div>
                <div id="chat-messages" class="flex-1 overflow-y-auto custom-scrollbar p-3 md:p-4 bg-gradient-to-b from-gray-50 to-white">
                    <div id="empty-state" class="h-full flex items-center justify-center text-gray-500">
                        <div class="text-center px-4">
                            <i class="fas fa-comments text-4xl md:text-6xl text-gray-300 mb-3 md:mb-4 empty-state-icon"></i>
                            <h3 class="text-base md:text-lg font-medium mb-2">Chưa có cuộc hội thoại nào được chọn</h3>
                            <p class="text-xs md:text-sm text-gray-400">Chọn một cuộc hội thoại từ danh sách để xem chi tiết</p>
                        </div>
                    </div>
                </div>
            </main>
        </div>
    </div>

    <script>
    class ChatHistoryManager {
        constructor() {
            this.conversations = [];
            this.selectedConversationId = null;
            this.init();
        }
        
        init() {
            this.loadConversations();
            this.bindEvents();
            this.renderConversationList();
            this.updateStats();
        }
        
        // Helper function để tạo title ngắn gọn
        createShortTitle(content) {
            if (!content || content.length <= 30) {
                return content;
            }
            
            // Cắt ở từ cuối cùng để không cắt giữa từ
            const truncated = content.substring(0, 30);
            const lastSpaceIndex = truncated.lastIndexOf(' ');
            return lastSpaceIndex > 15 ? truncated.substring(0, lastSpaceIndex) + '...' : truncated + '...';
        }
        
        loadConversations() {
            try {
                const stored = localStorage.getItem('agrisense_chat_history');
                this.conversations = stored ? JSON.parse(stored) : [];
                
                // Cập nhật tên cho các cuộc hội thoại cũ chưa có tên đúng
                let updated = false;
                console.log('🔍 Checking conversations for title updates...');
                
                this.conversations.forEach((conv, index) => {
                    console.log(`📋 Conversation ${index}:`, {
                        id: conv.id,
                        title: conv.title,
                        messageCount: conv.messages.length,
                        messages: conv.messages.map(m => ({
                            sender: m.sender,
                            type: m.type,
                            contentPreview: m.content ? m.content.substring(0, 50) + '...' : 'no content'
                        }))
                    });
                    
                    if ((conv.title === 'Cuộc hội thoại mới' || conv.title.startsWith('Cuộc hội thoại ')) && conv.messages.length > 0) {
                        console.log('🎯 Found conversation with default/numbered title, looking for first user message...');
                        console.log('📝 All messages in this conversation:', conv.messages.map((msg, idx) => ({
                            index: idx,
                            sender: msg.sender,
                            type: msg.type || 'text',
                            content: msg.content ? msg.content.substring(0, 100) : 'empty',
                            id: msg.id
                        })));
                        
                        // Tìm user message đầu tiên có content
                        let firstUserMessage = conv.messages.find(msg => {
                            const isUserMessage = msg.sender === 'user';
                            const hasContent = msg.content && msg.content.trim().length > 0;
                            const isNotHtml = msg.type !== 'html';
                            
                            console.log('🔍 Checking user message:', {
                                sender: msg.sender,
                                hasContent: hasContent,
                                type: msg.type,
                                contentPreview: msg.content ? msg.content.substring(0, 30) : 'empty'
                            });
                            
                            return isUserMessage && hasContent && isNotHtml;
                        });
                        
                        // Nếu không có user message, lấy message đầu tiên có content hữu ích
                        if (!firstUserMessage) {
                            console.log('⚠️ No user message found, looking for any meaningful message...');
                            firstUserMessage = conv.messages.find(msg => {
                                const hasContent = msg.content && msg.content.trim().length > 10; // Ít nhất 10 ký tự
                                const isNotHtml = msg.type !== 'html';
                                const isNotGreeting = !msg.content.includes('Chào bạn!'); // Bỏ qua lời chào tự động
                                
                                console.log('🔍 Checking any message:', {
                                    sender: msg.sender,
                                    hasContent: hasContent,
                                    isNotGreeting: isNotGreeting,
                                    contentPreview: msg.content ? msg.content.substring(0, 30) : 'empty'
                                });
                                
                                return hasContent && isNotHtml && isNotGreeting;
                            });
                        }
                        
                        if (firstUserMessage) {
                            const newTitle = this.createShortTitle(firstUserMessage.content);
                            conv.title = newTitle;
                            updated = true;
                            console.log('🔄 Updated conversation title:', conv.id, '→', newTitle);
                        } else {
                            // Nếu không có user message, đặt tên theo số thứ tự
                            if (conv.title === 'Cuộc hội thoại mới') {
                                const newTitle = `Cuộc hội thoại ${index + 1}`;
                                conv.title = newTitle;
                                updated = true;
                                console.log('🔢 Set numbered title:', conv.id, '→', newTitle);
                            }
                        }
                    }
                });
                
                // Lưu lại nếu có cập nhật
                if (updated) {
                    localStorage.setItem('agrisense_chat_history', JSON.stringify(this.conversations));
                    console.log('✅ Saved updated conversation titles');
                }
                
                console.log('Loaded conversations:', this.conversations.length);
            } catch (error) {
                console.error('Error loading conversations:', error);
                this.conversations = [];
            }
        }
        
        bindEvents() {
            const searchInput = document.getElementById('search-conversations');
            searchInput.addEventListener('input', (e) => {
                this.searchConversations(e.target.value);
            });
            
            const clearAllBtn = document.getElementById('clear-all-btn');
            clearAllBtn.addEventListener('click', () => {
                this.clearAllConversations();
            });
            
            // Sidebar toggle functionality
            const sidebarToggle = document.getElementById('sidebar-toggle');
            const sidebar = document.getElementById('history-sidebar');
            const mainContainer = document.getElementById('main-container');
            
            if (sidebarToggle) {
                sidebarToggle.addEventListener('click', (e) => {
                    e.preventDefault();
                    e.stopPropagation();
                    console.log('Toggle clicked!'); // Debug log
                    sidebar.classList.toggle('open');
                    mainContainer.classList.toggle('mobile-sidebar-open');
                });
            }
            
            // Close sidebar when clicking backdrop on mobile
            mainContainer.addEventListener('click', (e) => {
                if (e.target === mainContainer && mainContainer.classList.contains('mobile-sidebar-open')) {
                    sidebar.classList.remove('open');
                    mainContainer.classList.remove('mobile-sidebar-open');
                }
            });
            
            // Close sidebar after selecting conversation on mobile
            document.addEventListener('conversationSelected', () => {
                if (window.innerWidth < 768) {
                    sidebar.classList.remove('open');
                    mainContainer.classList.remove('mobile-sidebar-open');
                }
            });
        }
        
        renderConversationList(filteredConversations = null) {
            const conversationList = document.getElementById('conversation-list');
            const conversations = filteredConversations || this.conversations;
            
            if (conversations.length === 0) {
                conversationList.innerHTML = `
                    <div class="p-6 md:p-8 text-center text-gray-500">
                        <i class="fas fa-comment-slash text-4xl md:text-5xl mb-3 text-gray-300"></i>
                        <p class="font-medium text-sm md:text-base mb-2">Chưa có cuộc hội thoại nào</p>
                        <p class="text-xs md:text-sm text-gray-400">Bắt đầu chat để tạo lịch sử</p>
                    </div>
                `;
                return;
            }
            
            conversationList.innerHTML = conversations.map(conv => {
                const lastMessage = conv.messages[conv.messages.length - 1];
                let preview = 'Không có tin nhắn';
                let previewIcon = '💬';
                
                if (lastMessage && lastMessage.content) {
                    if (lastMessage.type === 'html') {
                        if (lastMessage.content.includes('🖼️')) {
                            preview = 'Thư viện ảnh';
                            previewIcon = '🖼️';
                        } else {
                            const tempDiv = document.createElement('div');
                            tempDiv.innerHTML = lastMessage.content;
                            const textContent = tempDiv.textContent || tempDiv.innerText || '';
                            preview = textContent.substring(0, 60) + (textContent.length > 60 ? '...' : '');
                        }
                    } else {
                        preview = lastMessage.content.substring(0, 60) + (lastMessage.content.length > 60 ? '...' : '');
                    }
                }
                
                // Count user and bot messages
                const userMsgCount = conv.messages.filter(m => m.sender === 'user').length;
                const botMsgCount = conv.messages.filter(m => m.sender === 'bot').length;
                
                return `
                    <div class="conversation-item border border-gray-200 m-2 md:m-3 p-3 md:p-4 rounded-lg md:rounded-xl" 
                         data-conversation-id="${conv.id}">
                        <div class="flex justify-between items-start mb-2">
                            <h3 class="font-semibold text-xs md:text-sm text-gray-800 truncate flex-1 mr-2 leading-tight">${conv.title}</h3>
                            <span class="text-xs text-gray-500 whitespace-nowrap ml-2">${this.formatDate(conv.lastUpdated)}</span>
                        </div>
                        <p class="text-xs md:text-sm text-gray-600 mb-3 line-clamp-2 leading-relaxed">${previewIcon} ${preview}</p>
                        <div class="flex justify-between items-center text-xs">
                            <div class="flex gap-3 text-gray-500">
                                <span class="flex items-center gap-1">
                                    <i class="fas fa-user text-blue-500"></i>
                                    <span class="font-medium">${userMsgCount}</span>
                                </span>
                                <span class="flex items-center gap-1">
                                    <i class="fas fa-robot text-green-500"></i>
                                    <span class="font-medium">${botMsgCount}</span>
                                </span>
                                <span class="text-gray-400">•</span>
                                <span class="font-medium text-gray-600">${conv.messages.length} tổng</span>
                            </div>
                            <button class="delete-conversation text-red-500 hover:text-red-700 p-2 rounded-lg hover:bg-red-50 transition-all btn-hover" 
                                    data-conversation-id="${conv.id}"
                                    title="Xóa cuộc hội thoại">
                                <i class="fas fa-trash text-xs md:text-sm"></i>
                            </button>
                        </div>
                    </div>
                `;
            }).join('');
            
            conversationList.addEventListener('click', (e) => {
                const conversationItem = e.target.closest('.conversation-item');
                const deleteBtn = e.target.closest('.delete-conversation');
                
                if (deleteBtn) {
                    e.stopPropagation();
                    this.deleteConversation(deleteBtn.dataset.conversationId);
                } else if (conversationItem) {
                    this.selectConversation(conversationItem.dataset.conversationId);
                }
            });
        }
        
        selectConversation(conversationId) {
            this.selectedConversationId = conversationId;
            const conversation = this.conversations.find(c => c.id === conversationId);
            
            if (!conversation) return;
            
            document.querySelectorAll('.conversation-item').forEach(item => {
                item.classList.remove('active');
            });
            document.querySelector(`[data-conversation-id="${conversationId}"]`).classList.add('active');
            
            this.renderChatMessages(conversation);
            
            // Show "Continue Chat" button với conversation ID
            const continueChatBtn = document.getElementById('continue-chat-btn');
            const conversationTitle = document.getElementById('conversation-title');
            
            if (continueChatBtn) {
                continueChatBtn.classList.remove('hidden');
                continueChatBtn.onclick = () => {
                    // Navigate to index.html with conversation ID in URL
                    window.location.href = `index.html?c=${conversationId}`;
                };
            }
            
            if (conversationTitle) {
                conversationTitle.textContent = conversation.title || 'Chi tiết hội thoại';
            }
            
            // Trigger event for mobile sidebar close
            document.dispatchEvent(new CustomEvent('conversationSelected'));
        }
        
        renderChatMessages(conversation) {
            const chatMessages = document.getElementById('chat-messages');
            const emptyState = document.getElementById('empty-state');
            
            if (emptyState) {
                emptyState.style.display = 'none';
            }
            
            // Debug: Log all messages
            console.log('🔍 Rendering messages for conversation:', conversation.id);
            console.log('📊 Total messages:', conversation.messages.length);
            conversation.messages.forEach((msg, idx) => {
                console.log(`Message ${idx}:`, {
                    sender: msg.sender,
                    hasContent: !!msg.content,
                    contentLength: msg.content?.length || 0,
                    hasImageUrl: !!msg.imageUrl,
                    type: msg.type,
                    timestamp: msg.timestamp
                });
            });
            
            chatMessages.innerHTML = conversation.messages.map(message => {
                const isBot = message.sender === 'bot';
                
                // Xử lý nội dung message
                let contentHtml = '';
                
                // Hiển thị ảnh nếu có
                if (message.imageUrl) {
                    contentHtml += `<div class="message-image mb-2">
                        <img src="${message.imageUrl}" alt="Uploaded image" 
                             class="max-w-full rounded-lg shadow-md cursor-pointer hover:shadow-xl transition-shadow" 
                             style="max-height: 200px;" 
                             onclick="openImageModal('${message.imageUrl}')">
                    </div>`;
                }
                
                // Hiển thị nội dung text hoặc HTML
                if (message.content) {
                    if (message.type === 'html') {
                        // Hiển thị HTML content trực tiếp (cho image galleries)
                        contentHtml += message.content;
                    } else {
                        // Hiển thị text content với formatting
                        contentHtml += message.content;
                    }
                }
                
                // Skip ONLY if no content AND no image (completely empty)
                if (!contentHtml.trim() && !message.imageUrl) {
                    console.warn('⚠️ Skipping completely empty message:', message);
                    return '';
                }
                
                // Giống index.html - chỉ wrapper + bubble, không có avatar
                return `
                    <div class="message-wrapper ${isBot ? 'bot' : 'user'}">
                        <div class="${isBot ? 'bot-bubble' : 'user-bubble'}">
                            ${contentHtml}
                        </div>
                    </div>
                `;
            }).join('');
            
            // Scroll to bottom smoothly
            setTimeout(() => {
                chatMessages.scrollTo({
                    top: chatMessages.scrollHeight,
                    behavior: 'smooth'
                });
            }, 100);
        }
        
        searchConversations(query) {
            if (!query.trim()) {
                this.renderConversationList();
                return;
            }
            
            const filtered = this.conversations.filter(conv => {
                return conv.title.toLowerCase().includes(query.toLowerCase()) ||
                       conv.messages.some(msg => msg.content.toLowerCase().includes(query.toLowerCase()));
            });
            
            this.renderConversationList(filtered);
        }
        
        deleteConversation(conversationId) {
            if (!confirm('Bạn có chắc chắn muốn xóa cuộc hội thoại này?')) return;
            
            this.conversations = this.conversations.filter(c => c.id !== conversationId);
            localStorage.setItem('agrisense_chat_history', JSON.stringify(this.conversations));
            
            if (this.selectedConversationId === conversationId) {
                this.selectedConversationId = null;
                document.getElementById('chat-messages').innerHTML = `
                    <div id="empty-state" class="h-full flex items-center justify-center text-gray-500">
                        <div class="text-center">
                            <i class="fas fa-comments text-6xl text-gray-300 mb-4"></i>
                            <h3 class="text-lg font-medium mb-2">Chưa có cuộc hội thoại nào được chọn</h3>
                            <p class="text-sm">Chọn một cuộc hội thoại từ danh sách bên trái để xem chi tiết</p>
                        </div>
                    </div>
                `;
            }
            
            this.renderConversationList();
            this.updateStats();
        }
        
        clearAllConversations() {
            if (!confirm('Bạn có chắc chắn muốn xóa TẤT CẢ lịch sử hội thoại?')) return;
            
            localStorage.removeItem('agrisense_chat_history');
            this.conversations = [];
            this.selectedConversationId = null;
            
            this.renderConversationList();
            this.updateStats();
            
            document.getElementById('chat-messages').innerHTML = `
                <div id="empty-state" class="h-full flex items-center justify-center text-gray-500">
                    <div class="text-center">
                        <i class="fas fa-comments text-6xl text-gray-300 mb-4"></i>
                        <h3 class="text-lg font-medium mb-2">Chưa có cuộc hội thoại nào được chọn</h3>
                        <p class="text-sm">Chọn một cuộc hội thoại từ danh sách bên trái để xem chi tiết</p>
                    </div>
                </div>
            `;
        }
        
        updateStats() {
            const totalElement = document.getElementById('total-conversations');
            const count = this.conversations.length;
            totalElement.textContent = `${count} cuộc hội thoại`;
        }
        
        formatDate(dateString) {
            try {
                const date = new Date(dateString);
                return date.toLocaleDateString('vi-VN');
            } catch {
                return 'N/A';
            }
        }
        
        fixAllConversationTitles() {
            console.log('🔧 Manually fixing all conversation titles...');
            let updated = 0;
            
            this.conversations.forEach((conv, index) => {
                // Force update cho các cuộc hội thoại có title mặc định hoặc số thứ tự
                const needsUpdate = conv.title === 'Cuộc hội thoại mới' || conv.title.startsWith('Cuộc hội thoại ');
                
                if (needsUpdate && conv.messages.length > 0) {
                    let firstUserMessage = conv.messages.find(msg => {
                        return msg.sender === 'user' && 
                               msg.content && 
                               msg.content.trim().length > 0 && 
                               msg.type !== 'html';
                    });
                    
                    // Nếu không có user message, tìm message có content hữu ích
                    if (!firstUserMessage) {
                        firstUserMessage = conv.messages.find(msg => {
                            const hasContent = msg.content && msg.content.trim().length > 10;
                            const isNotHtml = msg.type !== 'html';
                            const isNotGreeting = !msg.content.includes('Chào bạn!');
                            return hasContent && isNotHtml && isNotGreeting;
                        });
                    }
                    
                    if (firstUserMessage) {
                        // Ưu tiên dùng tin nhắn có content
                        const newTitle = this.createShortTitle(firstUserMessage.content);
                        conv.title = newTitle;
                        updated++;
                        console.log(`✅ Fixed title ${index + 1} with message:`, newTitle);
                    } else if (conv.title === 'Cuộc hội thoại mới') {
                        // Nếu không có message phù hợp, đặt số thứ tự
                        const newTitle = `Cuộc hội thoại ${index + 1}`;
                        conv.title = newTitle;
                        updated++;
                        console.log(`✅ Fixed title ${index + 1} with number:`, newTitle);
                    }
                }
            });
            
            if (updated > 0) {
                localStorage.setItem('agrisense_chat_history', JSON.stringify(this.conversations));
                this.renderConversationList();
                alert(`✅ Đã cập nhật ${updated} tên cuộc hội thoại!`);
                console.log(`🎉 Updated ${updated} conversation titles`);
            } else {
                alert('ℹ️ Không có cuộc hội thoại nào cần cập nhật tên.');
                console.log('ℹ️ No conversations needed title updates');
            }
        }
        
        formatTime(dateString) {
            try {
                const date = new Date(dateString);
                return date.toLocaleString('vi-VN', {
                    day: '2-digit',
                    month: '2-digit',
                    hour: '2-digit',
                    minute: '2-digit'
                });
            } catch {
                return 'N/A';
            }
        }
    }

    // Function để mở modal xem ảnh full size
    function openImageModal(imageId, imageUrl, title = '', description = '', photographer = '', source = '') {
        // Decode URI components
        title = decodeURIComponent(title) || 'Ảnh';
        description = decodeURIComponent(description) || 'Không có mô tả';
        photographer = decodeURIComponent(photographer) || 'Không rõ tác giả';
        source = decodeURIComponent(source) || 'AgriSense AI';
        
        // Tạo modal overlay
        const modal = document.createElement('div');
        modal.className = 'fixed inset-0 bg-black bg-opacity-75 flex items-center justify-center z-50';
        modal.onclick = function() { document.body.removeChild(modal); };
        
        // Tạo container ảnh
        const imgContainer = document.createElement('div');
        imgContainer.className = 'relative max-w-4xl max-h-4xl p-4';
        imgContainer.onclick = function(e) { e.stopPropagation(); };
        
        // Tạo ảnh
        const img = document.createElement('img');
        img.src = imageUrl;
        img.className = 'max-w-full max-h-full rounded-lg';
        img.alt = title;
        
        // Thông tin ảnh
        const infoDiv = document.createElement('div');
        infoDiv.className = 'absolute bottom-0 left-0 right-0 bg-black bg-opacity-75 text-white p-4 rounded-b-lg';
        infoDiv.innerHTML = `
            <h3 class="text-lg font-bold mb-2">${title}</h3>
            <p class="text-sm mb-2">${description}</p>
            <div class="text-xs text-gray-300">
                <span>📸 ${photographer}</span> • <span>🌐 ${source}</span>
            </div>
        `;
        
        // Nút đóng
        const closeBtn = document.createElement('button');
        closeBtn.innerHTML = '×';
        closeBtn.className = 'absolute top-2 right-2 text-white text-3xl font-bold bg-black bg-opacity-50 rounded-full w-10 h-10 flex items-center justify-center hover:bg-opacity-75';
        closeBtn.onclick = function() { document.body.removeChild(modal); };
        
        imgContainer.appendChild(img);
        imgContainer.appendChild(infoDiv);
        imgContainer.appendChild(closeBtn);
        modal.appendChild(imgContainer);
        document.body.appendChild(modal);
    }

    document.addEventListener('DOMContentLoaded', () => {
        new ChatHistoryManager();
        
        // Debug helper
        window.debugChatHistory = function() {
            const stored = localStorage.getItem('agrisense_chat_history');
            const conversations = stored ? JSON.parse(stored) : [];
            
            console.log('=== CHAT HISTORY DEBUG ===');
            console.log('Total conversations:', conversations.length);
            
            conversations.forEach((conv, idx) => {
                console.log(`\n📋 Conversation ${idx + 1}:`, conv.title);
                console.log('   ID:', conv.id);
                console.log('   Messages:', conv.messages.length);
                
                conv.messages.forEach((msg, msgIdx) => {
                    const senderIcon = msg.sender === 'user' ? '👤' : '🤖';
                    console.log(`   ${senderIcon} Message ${msgIdx + 1}:`, {
                        sender: msg.sender,
                        content: msg.content ? msg.content.substring(0, 50) + '...' : 'null',
                        imageUrl: msg.imageUrl ? 'Yes (length: ' + msg.imageUrl.length + ')' : 'No',
                        type: msg.type || 'text',
                        timestamp: msg.timestamp
                    });
                });
            });
            
            return conversations;
        };
        
        console.log('💡 Tip: Run window.debugChatHistory() to see all conversations');
    });
    </script>
</body>
</html>
